*------------------------------------------------------------------------
* OrdCom.Prg
* Registra las Orden de Compra
* Estado :
*   '00' Emitida   Este es el que se registra para la Solicitud de Cotizaci¢n
*   '20' Afectada
*   '50' Atendido
*   '70' Devuelta
*   '99' Anulada
* Upgrade : Febrero 2001
*--------------------------------------------------------------------------
*
*- Abriendo Archivos
PARAMETER sistema,Vopcion

SET EXCL OFF
*USE STOCK    IN 0   order tag stock1   ALIAS Stockali
USE OrdCom   IN 1   order tag OrdCom1  ALIAS Orden  && mto. de o/c
USE IteOc    IN 2   order tag IteOc1   ALIAS IteOc  && item de o/c
USE Parmae   IN 3   order tag Parmae1  ALIAS Parma  && mto. de parametros
USE IteArt   IN 4   order tag Iteart3  ALIAS Iteart  && item de articulos
USE Pecosa   IN 5   order tag Pecosa1  ALIAS Pecosa  && mto. de pecosas
USE Itepec   IN 6   order tag ItePec1  ALIAS Itepec  && item de pecosas
USE Promae   IN 7   order tag Promae1  ALIAS Promae  && proveedores
 IF sistema=='1'
*IF sistema==1
	USE maepre   IN 8   order tag maepre1  ALIAS maepre
ELSE
	USE maepre   IN 8   order tag maepre3  ALIAS maepre
ENDIF	
USE Calen    in 9   ORDER TAG Calen4   ALIAS CALEN
USE HojCon   IN 10  ORDER TAG HojCon1  ALIAS Hoja
USE Itehc    IN 11  ORDER TAG Itehc1   ALIAS Itehc
USE Hojmod   IN 12  ORDER TAG HOJMOD1  ALIAS HOJMOD
USE IteOc1   IN 13  ORDER TAG Iteoc11  ALIAS IteOc1
USE AstOrd	 IN 15	ORDER TAG AstOrd1  ALIAS AstOrd
USE USUARIO  IN 20  ORDER TAG USUARIO1 ALIAS USU
USE STOCK    IN 0   ORDER TAG STOCK2   ALIAS STOCK
USE IteUsuOp IN 0   ORDER TAG IteUsuOp1 ALIAS SubOp
USE CatAsi   IN 0   ORDER TAG CatAsi4  ALIAS CatAsi

ON KEY LABEL F12 DO LIQUIDAR
ON KEY LABEL F4  do imprimir
ON KEY LABEL F11 do ACTUA


PUBLIC vMes,vPart,vNumOc,OQ,VMS,vfecvis,v_reg ,vTothoc , vcadena , m.fecoc, vtipord,vTipo
*- Mensajes de aviso al usuario
PRIVATE vTotOC, vopcion
xtotoc = 0
vtipord = " "
Vmens01 = ' Orden de Compra : REVISION '
Vmens02 = ' Registro de Ordenes de Compra '
Vmens04 = 'Dicha Orden de Compra no fue encontrado'
Vmens05 = 'No existe Orden de Compra anterior'
Vmens06 = 'No existe Orden de Compra siguiente'
Vmens07 = '¨ Desea ANULAR ‚ste Orden de Compra ?'
Vmens08 = 'No hay registros para procesar'
Vmens09 = 'Este Orden de Compra ha sido anulado'
Vmens10 = 'Este Orden de Compra ya fue atendido'
Vmens11 = 'Este Orden de Compra ha sido devuelto'

PUBLIC GH
SELECT Orden
GO BOTTOM

*- Variables de trabajo (registro a trabajar)
SCATTER MEMVAR BLANK         && Crea variables en blanco

*- Inicia proceso
HIDE POPUP ALL
DO Inicia                    && Define ventanas, men£s, t¡tulos
DO Pantalla                  && Muestra pantalla inicial
DO Vista

*- Activa men£ mientras vEn_accion es .T.
STORE .T. TO vEn_accion
DO WHILE vEn_accion
	ACTIVATE SCREEN
	ACTIVATE MENU mMenu
ENDDO

DO Fin_opcion
RETURN

PROCEDURE Inicia             && Crea ventanas, men£s y t¡tulos
*---------------
ACTIVATE SCREEN
vTempo = ' Revisa  Busca  Anterior  Siguiente  Corrige  Ingresa  aNula    Listar  Termina '
DO Logos WITH Rotulo1,vTempo

DEFINE WINDOW Wind_0 FROM 00,00 TO 23,79  DOUBLE ;
TITLE Vmens01 COLOR SCHEME 10

DEFINE WINDOW Wind_1 FROM 00,00 TO 13,79  DOUBLE ;
TITLE Vmens02 COLOR SCHEME 10

DEFINE WINDOW Wind_2 FROM 14,00 TO 23,79 DOUBLE ;
TITLE '®F4¯ Imprime  ° ®F7¯ Seguimiento  ° ®F9¯ Detalle :Item  ° ®F12¯ Liquidar' COLOR SCHEME 10

DEFINE WINDOW Wind_2A FROM 10,04 TO 16,75 DOUBLE ;
TITLE '®F5¯ Agrega  ° ®F8¯ Eliminar  ° ®F10¯ Terminar ' COLOR SCHEME 10

DEFINE WINDOW Wind_3 FROM 20,63 TO 22,78 ;
TITLE 'TOTAL ' COLOR SCHEME 10

DEFINE WINDOW Wind_4 FROM 20,48 TO 22,78 ;
COLOR SCHEME 10

DEFINE WINDOW Wind_5 FROM 16,01 TO 18,79 ;
TITLE ' Destino '

DEFINE MENU mMenu COLOR SCHEME 3
DEFINE PAD revis   OF mMenu PROMPT '\<Revisa'     AT 24,00
DEFINE PAD busca   OF mMenu PROMPT '\<Busca'      AT 24,08
DEFINE PAD anter   OF mMenu PROMPT '\<Anterior'   AT 24,15
DEFINE PAD proxi   OF mMenu PROMPT '\<Siguiente'  AT 24,25
DEFINE PAD corri   OF mMenu PROMPT '\<Corrige'    AT 24,36
DEFINE PAD ingre   OF mMenu PROMPT '\<Ingresa'    AT 24,45
DEFINE PAD anula   OF mMenu PROMPT 'a\<Nula  '    AT 24,54
DEFINE PAD lista   OF mMenu PROMPT '\<Listar'     AT 24,63
DEFINE PAD termi   OF mMenu PROMPT '\<Termina'    AT 24,71

ON SELECTION PAD revis  OF mMenu DO revis
ON SELECTION PAD busca  OF mMenu DO busca
ON SELECTION PAD anter  OF mMenu DO anter
ON SELECTION PAD proxi  OF mMenu DO proxi
ON SELECTION PAD corri  OF mMenu DO corri
ON SELECTION PAD ingre  OF mMenu DO ingre
ON SELECTION PAD anula  OF mMenu DO anula
ON SELECTION PAD lista  OF mMenu DO lista
ON SELECTION PAD termi  OF mMenu DO termi
RETURN

PROCEDURE Pantalla           && Pinta m scara de datos
*-----------------
ACTIVATE WINDOW Wind_1
CLEAR
 @  1, 2 SAY "       N£mero O/C:"
 @  1,40 SAY "            Fecha:"
 @  2, 2 SAY "        Proveedor:"
 @  3, 2 SAY "      Cadena Fun.:"
 @  4, 2 SAY "  Fte. Financiam.:"
 @  5, 2 SAY "          Funci¢n:"
 @  6, 2 SAY "         Programa:"
 @  7, 2 SAY "      Subprograma:"
 @  8, 2 SAY " Activid./Proyec.:"
 @  9, 2 SAY "       Calendario:"
 @  9,40 SAY "              H/C:"
 @ 10, 2 SAY "    Observaciones:"
 @ 11, 2 SAY "   Factura/Boleta:"
RETURN


PROCEDURE Vista              && Coloca valores de BD en variables y pinta datos
*--------------
ON KEY LABEL F5
ON KEY LABEL F8
SELECT Orden
IF EOF()
	DO Pantalla
	RETURN
ENDIF
ACTIVATE WINDOW WIND_1

ON KEY LABEL F9 DO VISTA_DET
ON KEY LABEL F7 DO PREstado
* WITH 'OC','m.perhc+m.numhc'

SCATTER MEMVAR
=val_CODCAD(ALLT(m.codcad),m.periodo,'C')
@  0,02 SAY IIF(m.Tipdoc='OK' AND m.estado#'5','O/C Visado','          ') 
@  0,16 SAY IIF(m.Tipdoc='OK' AND m.estado#'5',Fecvis,'          ') 
@  0,60 SAY vEstOc(m.Estado) COLOR SCHEME 02
@  1,22 SAY m.Periodo
@  1,25 SAY m.NumOc
@  1,58 SAY m.FecOc   Pict "@D"
@  1,68 SAY IIF(!EMPTY(m.FecDesp),'<'+DTOC(m.FecDesp)+'>',SPAC(10))
@  2, 2 SAY "        Proveedor:"
@  2,22 SAY IIF(EMPTY(m.codprv),'Sin Codigo'+space(40),val_prv(m.Codprv))

* if m.Tipo = 'M'		
*    @ 3, 2 SAY "      Documento :"
*    @ 3,22 say m.Memoran
* else   
*	@ 3, 2 say spac(79)
* endif

@  3,22 Say val_codcad(m.codcad,m.periodo,'V',22,30)
@  4,22 SAY val_para(m.CodFte,'CODFTE','V',22,30)
@  5,22 SAY VAL_PARA(MAEPRE.codfun,'CODFUN','V',22,40)
@  6,22 SAY VAL_PARA1(MAEPRE.CodPrg,'CODPRG'+MAEPRE.codfun,'V',22,40)
@  7,22 SAY VAL_PARA1(MAEPRE.CodSPr,'CODSPR'+MAEPRE.codprg,'V',22,40)
@  8,22 SAY VAL_PARA(MAEPRE.actpry,'ACTPRY','V',22,40)
@  9,22 SAY val_para(m.NumMes,'FECMES','V',20,10)
@  9,60 SAY m.Perhc+' '+m.Numhc
@ 10,22 SAY m.Observa PICTURE "@S54"
@ 11,22 say orden.igv
DO VISTA_HIJO
DO TOTAL
IF !vFlag$'J*'
	DO SubOpc
ENDIF

RETURN


PROCEDURE TOTAL
*--------------
ACTIVATE WINDOW WIND_3
IF !EMPTY(m.NUMANU) OR !EMPTY(M.NUMREB)
	@ 0,0 SAY m.Anultot picture '9,999,999.99'
 else
	@ 0,0 SAY m.Valtot picture '9,999,999.99'
endif
return


PROCEDURE VISTA_HIJO
*-------------------
hide popup all
SELECT IteOc
SEEK m.Periodo + m.NumOc
BROWSE ;
	NOAPPEND NODELETE NOCLEAR NOMENU NOOPTIMIZE NOREFRESH NOEDIT KEY m.Periodo + m.NumOc  TIMEOUT 0.001 ;
	WINDOW Wind_2 ;
	FIELDS;
		CodArt      : H= 'C¢digo',;
		CanReq      : H= 'Cantidad' :P='99,999.99',;
		CodUni      : H= 'Uni'      :W=.F. :3,;
		Descri      : H= 'Descripci¢n' :26 :W=.F. ,;
		Numpec      : H= 'Pecs' :w=.f. ,;
		PreUni      : H= 'PreUni' :P='9,999,999.9999' :W=.F. ,;
		X=ROUND(CanReq*PreUni,2)  :H='Total'  :P='99,999.99' :W=.F.
SELE Orden
RETURN

PROCEDURE VISTA_DET
*------------------
hide popup all
SELECT IteOc
seek m.Periodo + m.NumOc
ON KEY LABEL F9 DO OBSERVA
ON KEY LABEL F7 
if m.igv="F"
   	XIGv=18.00
else
   	XIGV=0.00
endif      
GO TOP
BROWSE ;
   NOAPPEND NODELETE NOCLEAR NOMENU NOOPTIMIZE NOREFRESH NOEDIT KEY m.Periodo + m.NumOc  ;
   WINDOW Wind_2 ;
   FIELDS;
   CodArt      : H= '*C¢digo',;
   CanReq      : H= 'Cantidad' :P='99,999.99',;
   CodUni      : H= 'Uni'      :W=.F. :3,;
   Descri      : H= 'Descripci¢n' :26 :W=.F. ,;
   Numpec      : H= 'Pecs' :w=.f. ,;
   PreUni      : H= 'PreUni' :P='9,999,999.9999' :W=.F. ,;
   PctDto        : H= '% Dcto'     :P='999.999',;
   PctIgv        : H= '% IGV '     :P='999.999',;
   X=calcula1()  : H='Total' :P='9,999,999.99'
SELE Orden
DO VISTA
ON KEY LABEL F7 DO PREstado 
*WITH 'OC','m.perhc+m.numhc'
ON KEY LABEL F9 DO VISTA_DET
RETURN


PROCEDURE Revis              && Revisi¢n de BD en browse
*--------------
SELECT ORDEN
IF EOF()
	DO standby WITH Vmens08
	RETURN
ENDIF
SET RELATION TO PERIODO+NUMOC INTO ITEOC &&+CODFTE
SET SKIP TO ITEOC
Vtemp = RECNO()
HIDE MENU mMenu
ACTIVATE SCREEN
vTempo = '°°°°°°°°°°°Presione ®F10¯ para seleccionar  o  ®Esc¯ para cancelar°°°°°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
ON KEY LABEL F10 KEYBOARD CHR(23)
BROWSE WINDOW Wind_0 NOEDIT NOAPPEND NODELETE NOMENU FIELDS ;
NumOc  :H=' N§ ' ,;
Codfte :H='Fte' ,;
FecOc  :H='Fecha' ,;
CC=vEstOc(ORDEN.Estado) :H='Estd' :4,;
iteOc.descri :H='Articulo ' :36 ,;
iteOc.coduni :H='Unid' ,;
iteOc.Canreq :H='Cantid'
vTempo = '°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
IF LASTKEY()=27
	GOTO Vtemp
ENDIF
SHOW MENU mMenu
ON KEY LABEL F10
SET RELATION TO
DO Vista
RETURN


PROCEDURE Busca              && Realiza b£squeda directa
*--------------
IF EOF()
	DO standby WITH Vmens08
	RETURN
ENDIF
vtemp    = RECNO()
vPeriodo = RIGHT(DTOC(DATE()),2)
vNum_oC = '    '
VFTE = space(2)

ACTIVATE WINDOW standby
@ 1,01 SAY 'Ingrese N£mero O/C : ' GET vPeriodo PICTURE '!!'
@ 1,26 SAY '-' GET vNum_OC PICTURE '!!!!' VALID vBusca()
READ
DEACTIVATE WINDOW standby

IF EMPTY(vNum_OC) .or. LASTKEY()=27
	RETURN
 ELSE
	SEEK  vPeriodo + vNum_OC &&+ ALLTRIM(VFTE)
	IF !FOUND()
		DO standby WITH Vmens04
		GOTO Vtemp
	 ELSE
		DO Vista
	ENDIF
ENDIF
RETURN

PROCEDURE vBusca
*---------------
vNum_Oc=Padl(alltrim(vNum_Oc),4,'0')
retur .t.


PROCEDURE Anter
*--------------
IF EOF()
	DO standby WITH Vmens08
	RETURN
ENDIF

IF !BOF()
	SKIP -1
ENDIF
IF BOF()
	GO TOP
	DO standby WITH Vmens05
 ELSE
	DO Vista
ENDIF
RETURN

PROCEDURE Proxi
*--------------
IF EOF()
	DO standby WITH Vmens08
	RETURN
ENDIF
IF !EOF()
	SKIP
ENDIF
IF EOF()
	DO standby WITH Vmens06
	GO BOTTOM
 ELSE
	DO Vista
ENDIF
RETURN


PROCEDURE Actua
*--------------
ON KEY LABEL F11
*if VE_PASSW('PEPE')
PRIVATE AW
AW = ALIAS()
sele iteoc
seek m.Periodo + m.NumOc  
SCAN WHILE M.PERIODO+M.NUMOC=PERIODO+NUMOC
     SELE ITEPEC
     SET ORDE TO ITEPEC7
     SEEK iteoc.periodo+iteoc.numoc+iteoc.codfte+iteoc.codart+alltrim(iteoc.numord)
     if found()
        if rlock()
           if preuni#iteoc.preuni and tippec='O'
              replace preuni with iteoc.preuni
           endif   
        endif
        UNLOCK
     else
        do standby with 'Pecosa no hallado ...'
     endif
     sele iteoc         
ENDSCAN
sele itepec
set orde to itepec1
sele (aw)
*endif
ON KEY LABEL F11 DO ACTUA
RETURN


PROCEDURE Corri
*--------------
PUBLIC mF4
PRIVATE AD
OQ=.T.
mF4 = ON('KEY', 'F4')
ON KEY LABEL F4
AD = RECNO()
 IF EOF()
    DO standby WITH Vmens08
    RETURN
 ENDIF
 DO CASE  
    CASE Estado = '99'
 		 * Anulada
         DO STANDBY WITH Vmens09
         RETURN
    CASE Estado = '21'
 		 * Parte Anulaci¢n
         DO STANDBY WITH 'La O/C tiene Parte de Anulaci¢n'
         RETURN
	CASE Estado = '20'
         * El Orden de Compra ha sido devuelto
         DO STANDBY WITH 'La O/C ya esta Afectada'
         RETURN
    CASE Estado = '30'
         * El Orden de Compra ha sido devuelto
         DO STANDBY WITH 'La O/C ya esta Afectada y es de Bayovar'
         RETURN
	CASE Estado = '40'
         * El Orden de Compra ya tiene ?
         DO STANDBY WITH 'La O/C ya est  atendida'
         RETURN
	CASE Estado = '51'
         * El Orden de Compra ya tiene ?
         DO STANDBY WITH 'La O/C ya est  liquidada/Contabilizada'
         RETURN
 ENDCASE

 SELECT Orden
 SCATTER MEMVAR
 ACTIVATE WINDOW Wind_1
 DO PANTALLA
 vtipo = m.tipo
 =val_CODCAD(ALLT(m.codcad),m.periodo,'C')

 @  1,22 GET m.Periodo  PICTURE '!!'  DISABLE
 @  1,24 SAY '-'
 @  1,25 GET m.NumOc   PICTURE '!!!!' DISABLE
 @  1,58 GET m.FecOc   PICTURE '@D'   VALID Val_Ano()

DO CASE 
   CASE vTipo = 'C'
        @ 2,22 SAY m.CodPrv  
        @ 2,28 SAY Val_prv( m.CodPrv,.T.,02,27)
   CASE vTipo = 'S' OR vtipo='M'
*        @ 2,22 GET m.CodPrv  PICTURE '!!!!' VALID Val_prv( m.CodPrv,.T.,2,27)  and siprv() and promae.estado="VG"
         @ 2,22 GET m.CodPrv  PICTURE '!!!!' VALID Val_prv( m.CodPrv,.T.,2,27)
         *and siprv() and promae.estado="RG"
ENDCASE

* if m.Tipo = 'M'		
*    @ 3, 2 SAY "        Documento :"
*    @ 3,22 GET m.Memoran
* endif
 
@ 3,22 GET m.CodCad  PICTURE '!!!!' VALID val_codcad(m.codcad,m.periodo,' ',22,30) 
@ 4,22 GET m.CodFte  PICTURE '!!'   VALID val_para(m.Codfte,'CODFTE',' ',22,30) 

READ VALID val_read()
IF LASTKEY()=27 
	DO vista
 	RETURN
ENDIF
@  5,22 SAY VAL_PARA(MAEPRE.codfun,'CODFUN','V',22,40)
@  6,22 SAY VAL_PARA1(MAEPRE.CodPrg,'CODPRG'+MAEPRE.codfun,'V',22,40)
@  7,22 SAY VAL_PARA1(MAEPRE.CodSPr,'CODSPR'+MAEPRE.codprg,'V',22,40)
@  8,22 SAY VAL_PARA(MAEPRE.actpry,'ACTPRY','V',22,40)
@  9,22 GET m.Nummes	PICTURE '!!'	VALID val_para(m.NumMes,'FECMES',' ',22,15) && AND VAalcal(XTOTOC,1)
@ 10,22 GET m.Observa PICTURE "@S54"
@ 11,22 GET m.igv VALID m.igv$"FB"

READ VALID VAL_READ()

IF LASTKEY() # 27
	vcadena=maepre.uniges+maepre.unieje+maepre.Codfun+maepre.CodPrg+maepre.CodSpr+maepre.ActPry
	DO WHILE .T.
		Or = IIF(m.tipo='M',CORRI_HJ(),CORRIJE_HJ())
		IF LASTKEY() # 27
			IF YESNO('¨ Conforme la modificaci¢n ?')
				or=.t.
				EXIT
			ENDIF
		 ELSE
			IF YESNO('¨ Cancela la modificaci¢n ?')
				or = .F.
				EXIT
			ENDIF
		ENDIF
	ENDDO
	
	IF Or .AND. LASTKEY() # 27 AND OQ
		codcad = m.codcad
		vTotal = 0
		SELECT ITEOC1
		SEEK m.Periodo + m.NumOc
		SET FILT TO Periodo = m.Periodo and NumOc = m.NumOc
		GO TOP
		SCAN WHILE Periodo+NumOc = m.Periodo + m.NumOc
			vtotal = vtotal + valpart
			IF RLOCK()
				*SELEC CALEN
				*SEEK m.periodo+vcadena+iteoc1.codcom+iteoc1.codmet+allt(m.codfte)+allt(m.nummes)+iteoc1.codpart
				*if !found()
				*	do standby with 'No existe partida en calendarios...'
				*else
				*	REPLACE totoc WITH totoc+ITEOC1.valPart
				*endif
				SELECT iteoc1
			ENDIF
			UNLOCK
		ENDSCAN
		SET FILTER TO
		SELE ITEOC
		SEEK m.Periodo + m.NumOc
		SET FILT TO Periodo = m.Periodo and NumOc = m.NumOc
		GO TOP
		SCAN WHILE Periodo+NumOc = m.Periodo + m.NumOc 
			REPLA ALL codcad WITH m.codcad, codfte WITH m.codfte
		ENDSCAN
		m.Valtot = vtotal
		
		DO DESTINO
		SELECT Orden
		GO AD
*		m.user = vUser_ID
		m.user_Cr = vUser_ID
		m.user_fc = date()
		m.user_TP = 'C'
		M.ESTADO='00'
		GATHER MEMVAR
	 ELSE
		SELECT Orden
	ENDIF
	UNLOCK
ENDIF  
SELECT Orden
GO AD
DO VISTA
ON KEY LABEL F4 &mF4
RETURN



PROCEDURE Ingre              && Crea nuevo registro en BD
*--------------
DEACTIVATE WINDOW WIND_3
PUBLIC VTIPO,AST,REC,GH,MF4
mF4 = ON('KEY', 'F4')
ON KEY LABEL F4
sincot=.t.
vtippec = " "
*IF escolor
*   DEFINE POPUP xcot  FROM 17,55 SHADOW COLOR &L_COL
*ELSE
*   DEFINE POPUP xcot  FROM 17,55 COLOR SCHEME c_popup
*ENDIF
*
*DEFINE BAR 1 OF xcot PROMPT ' \<Sin Cotizaci¢n '
*DEFINE BAR 2 OF xcot PROMPT ' \<Con Cotizaci¢n '
**DEFINE BAR 3 OF xcot PROMPT ' c\<On otro documento '
*ON SELECTION POPUP xcot  DEACTIVATE POPUP
*ACTIVATE POPUP XCOT
*DO CASE
*	CASE BAR() = 1
*		sincot=.t.
*		vTipo = 'S'
*	CASE BAR() = 2
*		sincot=.f.
*		vTipo = 'C'
**	CASE BAR() = 3
**		sincot=.f.
**		vTipo = 'M'
*	OTHERWISE
*ENDCASE
*RELEASE POPUP Xcot
 
IF LASTKEY()=27
   DO STANDBY WITH 'Proceso cancelado'
   DO VISTA
   RETURN
ENDIF

DO PANTALLA
SELECT Orden
REC=RECNO()
AST=ORDER()

SCATTER MEMVAR BLANK
m.NumOc = REPASA1() 
*= REPASA() 
m.FecEmi = m.fecsis
m.FecOc  = m.fecsis
m.igv    = "F"
m.periodo = PADL(ALLTRIM(STR(YEAR(DATE())-2000)),2,"0")
@  1,22 GET m.periodo DISABLE
@  1,25 GET m.NumOc   PICTURE '!!!!' DISABLE
@  1,58 GET m.FecOc   VALID Val_Ano()
*@  2,22 GET m.CodPrv  PICTURE '!!!!' VALID Val_prv( m.CodPrv,.T.,2,27)  and siprv() and promae.estado="VG"
@  2,22 GET m.CodPrv  PICTURE '!!!!' VALID Val_prv( m.CodPrv,.T.,2,27) 
* and siprv() and promae.estado="RG"

*if vTipo = 'M'		
*   @ 3, 2 SAY "      Documento :"
*   @ 3,22 GET m.Memoran PICTURE '@S54'
*endif

@ 3,22 GET m.CodCad  PICTURE '!!!!' 	VALID VAL_CODCAD(m.codcad,m.periodo,' ',22,30)
@ 4,22 GET m.Codfte  PICTURE '!!'  	    VALID VAL_PARA(m.Codfte,'CODFTE',' ',22,30)

READ VALID Val_Read()
IF LASTKEY()=27
	SELE ORDEN
*	GO GH
*	if numoc=alltrim(m.numoc)
*		dele next 1
*	endif
	GO REC
	DO vista
	RETURN
ENDIF

@  5,22 SAY VAL_PARA(MAEPRE.codfun,'CODFUN','V',22,40)
@  6,22 SAY VAL_PARA1(MAEPRE.CodPrg,'CODPRG'+MAEPRE.codfun,'V',22,40)
@  7,22 SAY VAL_PARA1(MAEPRE.CodSPr,'CODSPR'+MAEPRE.codprg,'V',22,40)
@  8,22 SAY VAL_PARA(MAEPRE.actpry,'ACTPRY','V',22,40)
@  9,22 GET m.Nummes   PICTURE '!!' VALID VAL_PARA(m.Nummes,'FECMES','C',22,30) AND VAL_MES()
@ 10,22 GET m.Observa  PICTURE "@S54"
@ 11,22 get m.igv PICTURE "!" VALID m.igv$"FB"
READ VALID Val_Read()
SET CONFIRM ON

IF LASTKEY() # 27
	vcadena=maepre.uniges+maepre.unieje+maepre.Codfun+maepre.CodPrg+maepre.CodSpr+maepre.ActPry
	
*	DO WHILE .T.
*		Ok = TRABAJA_HJ()
*		IF LASTKEY() # 27 AND Ok
*			IF YESNO('¨ Confirme el ingreso ?')
*				EXIT
*			 ELSE
*				OK = .F.
*				EXIT
*			ENDIF
*		 ELSE
*			DO STANDBY WITH ' Cancelado el Ingreso '
*			ok = .F.
*			EXIT
*		ENDIF
*	ENDDO
	
	IF LASTKEY() # 27
		*- Aumento el correlativo
*		DO ACTUALIZA with 1
		SELECT ITEOC
		SEEK m.Periodo+m.NumOc
*		If vtipo = 'S' or vtipo = 'C'
			ok1 = corri_hj()
*		endif
		SELECT ITEOC1
		SEEK m.Periodo + m.NumOc
		vTotal = 0
		SCAN WHILE Periodo = m.Periodo and NumOc = m.NumOc
			vtotal = vtotal + valPart
		ENDSCAN
		DO DESTINO
		
		SELECT ORDEN
		IF f_Appd()
			m.Valtot = vtotal
			m.tipo   = vtipo
			vImpr = m.Periodo+m.NumOc+ALLTRIM(m.Codfte)
			m.user = vUser_ID
			m.user_fc = date()
			m.user_TP = 'I'
			m.Estado = '00'
			m.tipord = pecosa.tippec
			GATHER MEMVAR
		ENDIF
		
		SELE Parma
		SEEK 'CORREL' + 'ORDENC'
		IF f_Lock(1)
			REPLACE NumEnt WITH Parma.NumEnt+1
			UNLOCK
		ENDIF
		
*		GO GH
*		IF !empty(m.Numoc)
*		ENDIF
	
*		if found()
*			do standby with 'El N£mero de O/C ya ha sido generado por '+alltrim(user)+' Revise ...'
*		endif
		
*		IF sistema=1
*    	IF sistema=='1'
			USE maepre   IN 8   order tag maepre1  ALIAS maepre
*		ELSE
*			USE maepre   IN 8   order tag maepre3  ALIAS maepre
*		ENDIF	
     ELSE    
       SELECT Iteoc
       SEEK m.periodo+m.numoc
       IF FOUND()
       		SCAN WHILE m.Periodo = Periodo  .and.  m.Numoc = Numoc 
            	IF F_LOCK(1)
                	DELETE NEXT 1
            	ENDIF
          	ENDSCAN
          	UNLOCK
       ENDIF   	
       GO REC
    ENDIF
ELSE
	DO STANDBY WITH 'Proceso cancelado'
    SELECT ORDEN
    GO REC
ENDIF
SELECT ORDEN
DO VISTA
ON KEY LABEL F4 &mF4
RETURN


FUNCTION Val_Ano
*---------------
IF YEAR(m.FecOC) = YEAR(m.FecSis)
	mRet = .T.
ELSE
	DO StandBy WITH "Error en la Fecha... Revise."
	mRet = .F.
ENDIF
RETURN mRet


PROCEDURE siprv
*--------------
parameter vfun
vfun = .t.
*if !v_reg='VG'
if !v_reg='RG'
   do standby with 'El Proveedor no esta Regularizado...Observaci¢n'
endif
return vfun   


PROCEDURE TRABAJA_HJ
*-------------------
PRIVATE vfun
ON KEY LABEL F4 DO AgrIgv
vFun=.t.
ACTIVATE SCREEN
HIDE MENU mMenu
vTempo = '°°°°° ®F2¯ Busca Pec °°° ®F11¯ Marca û °°° ®F12¯ Desmarca û °°° ®F10¯ Sale °°°°°'
DO Logos WITH Rotulo1,vTempo

ON KEY LABEL F2  DO BUSPEC
ON KEY LABEL F10 KEYBOARD CHR(23)
ON KEY LABEL F11 DO MARCA
ON KEY LABEL F12 DO DESMARCA

SELECT ITEPEC
SET RELATION TO codart into iteart
SET RELATION TO Periodo+NumPec INTO Pecosa additive

GO TOP
IF !EOF()
	DO CASE
		CASE vTipo = 'S'
			SET ORDER TO ITEPEC5
			ORANT=ORDER()
			VESTA='00'
			SET FILT TO ESTADO='00' AND CODFTE=ALLTRIM(m.CODFTE) AND TIPPEC$'OTB' AND CODCAD=ALLTRIM(m.CODCAD)
			ON KEY LABEL F9 DO VISOBS
			GO TOP
			IF !EOF()
				BROWSE NOAPPEND NODELETE NOMENU WINDOW Wind_2 FIELD ;
					orden         : H= ''          :W=.F. ,;
					numord        : H= 'Od'         :W=.F. ,;
					xx=' '+NumPec : H= 'Pecosa'     :W=.F. ,;
					codfte        : H= 'Fte'        :W=.F. ,;
					Descri        : H= 'Descripci¢n':W=.F. :25 ,;
					Coduni        : H= 'Uni'        :W=.F. :3  ,;
					Canreq        : H= 'Cantid'     :P='99,999.999' ,;
					PreUni        : H= 'Costo'      :P='9,999,999.9999':V=Preuni>0 ,;
					PctDto        : H= '% Dcto'     :P='999.999',;
					PctIgv        : H= '% IGV '     :P='999.999',;
					X=calcula1()  : H='Total' :P='9,999,999.99' 
			 ELSE
				DO STANDBY WITH 'No existe Art¡culos a procesar ...'
			ENDIF
			ON KEY LABEL F9
		CASE vTipo = 'C'
			SET ORDER TO ITEPEC6
			ORANT=ORDER()
			VESTA='20'
			SET FILT TO CODFTE=ALLTRIM(m.CODFTE) AND CODCAD=ALLTRIM(m.CODCAD) AND CODPRV=ALLTRIM(m.CODPRV)
			*SET FILTER TO codprv=alltrim(m.codprv) &&A¤adir Filtro
			ON KEY LABEL F9 DO VISOBS
			GO TOP
			IF !EOF()
				BROWSE NOAPPEND NODELETE NOMENU WINDOW Wind_2 FIELD ;
					orden         : H= ''         :W=.F. ,;
					numord        : H= 'Od'        :W=.F. ,;
					xx=' '+NumPec : H= 'Pecosa'    :W=.F. ,;
					CodPrv        : H= 'Prv'       :W=.F. ,;
					Descri        : H= 'Descripci¢n' :24 :W=.F.  ,;
					Coduni        : H= 'Uni'       :W=.F. :3,;
					Canreq        : H= 'Cantidad'  :P='99,999.999' ,;
					PreUni        : H= 'Costo'     :P='9,999,999.999' :V=Preuni>0 ,;
					PctDto        : H= '% Dcto'    :P='999.999',;
					PctIgv        : H= '% IGV '    :P='999.999',;
					X=calcula1()  : H='Total'      :P='9,999,999.99'
			 ELSE
				DO STANDBY WITH 'No existe Art¡culos a procesar ...'
			ENDIF
			ON KEY LABEL F9
		CASE vTipo = 'M'
			DO CORRI_HJ
	ENDCASE
	set filter to
	IF LASTKEY()=27
		vFun=.f.
	ENDIF
 ELSE
	DO STANDBY WITH 'No existe Art¡culos a Procesar '
	vFun=.f.
ENDIF
SET ORDER TO ITEPEC1
ACTIVATE SCREEN
vTempo = '°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
SHOW MENU mMenu
SELECT Orden
ON KEY LABEL F10
ON KEY LABEL F11 
ON KEY LABEL F12 DO LIQUIDAR
ON KEY LABEL F2 
ON KEY LABEL F4
RETURN vFun

PROCEDURE AgrIGV
*---------------
IF EMPTY(pctIGV)
	REPLACE pctIGV WITH 18
 ELSE
	REPLACE pctIGV WITH 0
ENDIF

FUNCTION CALCULA1
*----------------
Subtotal=round(CanReq*PreUni,2)
Descuen=(subtotal*pctdto)/100
Liquido=SubTotal-Descuen
VIgv=round((Liquido*pctIgv)/100,2)
vTotal=liquido+Vigv
return vTotal

FUNCTION CALCULA2
*----------------
Subtotal=round(CanReq*PreUni,2)
Descuen=(subtotal*pctdto)/100
Liquido=SubTotal-Descuen
VIgv=round((Liquido*pctIgv)/100,2)
vTotal=liquido+Vigv
REPLACE ValTot WITH vTotal
return vTotal

PROCEDURE ACTUALIZA
*------------------
PARAMETER VOPCION
PRIVATE AW,VORD,VOPCION,ad
AW = ALIAS()
SELE itepec
VORD = ORDER()
GO TOP
IF !EOF()
	ACTIVATE WINDOW STANDBY
	@ 01,10 SAY 'Espere un momento........' 
	SET ORDER TO ITEPEC15
	seek m.periodo+m.numoc
	SET FILT TO Periodo = m.Periodo and Numoc = m.Numoc
	SCAN while periodo+numoc=m.periodo+m.numoc 
		*if ESTADO=iif(vtipo= 'C','20','00')
		if ESTADO=iif(vtipo= 'S','00','20')
			vantfte = itepec.codfte
			REPLACE estado with '30', Antfte with vantfte, NewFte with m.codfte,codfte with m.codfte
			ad=recno()
			select pecosa
			set orde to pecosa1
			seek itepec.periodo+itepec.numpec &&+itepec.codfte+itepec.codcad
			if found()
				replace codfte with m.codfte, estado with "30"
			 else
				do standby WITH "Error:1001 No grabo en Pecosa"
			endif
			IF vOpcion = 1
				DO Agreg_item  && agrega  en iteoc
			ENDIF
			sele itepec
			go ad
		endif
	ENDSCAN
	DEACTIVATE WINDOW STANDBY
	SELE ITEPEC
	SET FILTER TO
endif
SET ORDE TO (VORD)
SELE (AW)
RETURN


PROCEDURE ACTUALIZ_C
*-------------------
PARAMETER VOPCION
PRIVATE AW,VORD,VOPCION,ad
AW = ALIAS()
SELE ITEPEC
VORD = ORDER()
GO TOP
IF !EOF()
   ACTIVATE WINDOW STANDBY
   @ 01,10 SAY 'Espere un momento........' 
   SET ORDER TO ITEPEC15
   SET FILT TO Periodo = m.Periodo and Numoc = m.Numoc 
   GO TOP
   SCAN while periodo+numoc=m.periodo+m.numoc 
        if ESTADO=iif(vtipo= 'C','20','00')
*       if ESTADO=iif(vtipo= 'C','20','10')
           vantfte = itepec.codfte
       	   REPLACE estado with '30',codfte with m.codfte 
		   ad=recno()
		   select pecosa
		   set orde to pecosa1
		   seek itepec.periodo+itepec.numpec
		   if found()
		      replace codfte with m.codfte
		   else
		      do standby WITH "Error:1001 No grabo en Pecosa"
		   endif   
      	   DO AGREG_ITEM  && agrega  en iteoc
       	   sele itepec
       	   go ad
       	endif   
    endscan
    GO TOP
    REPLACE ALL codfte with m.codfte
    DEACTIVATE WINDOW STANDBY
endif
SET ORDE TO (VORD)
SELE (AW)
RETURN


PROCEDURE CORRIJE_HJ
*-------------------
ACTIVATE SCREEN
HIDE MENU mMenu
vTempo = '°°°°°F5->Agregar°°°°°°°F8->Eliminar°°°°°°°F9->Obs. Item°°°°°°°F10->Terminar°°°°°'
DO Logos WITH Rotulo1,vTempo
ON KEY LABEL F5  DO Agreg_oc
ON KEY LABEL F8  DO Elimi_oc
ON KEY LABEL F9  DO Obs_Item
ON KEY LABEL F10 KEYBOARD CHR(23)
SELE ITEOC
SEEK m.Periodo + m.NumOc 
IF !FOUND()
	DO Agreg_oc
ENDIF
BROWSE NOAPPEND NODELETE NOCLEAR NOMENU WINDOW Wind_2 key m.Periodo + m.NumOc  FIELD ;
   CodArt      : H= 'C¢digo'   :W=.F.,;
   Descri      : H= 'Descripci¢n' :29 :W=.F. ,;
   CanReq      : H= 'Cantidad' :P='99,999.999' ,;
   CodUni      : H= 'Uni'      :W=.F. :3,;
   PreUni      : H= 'PreUni' :P='9,999,999.9999' ,;
   PctDto        : H= '% Dcto'    :P='999.999',;
   PctIgv        : H= '% IGV '    :P='999.999',;
   X=calcula2()  : H='Total'      :P='9,999,999.99'

ON KEY LABEL F5  DO Agreg_ITEM
ON KEY LABEL F8  DO Elimi_ITEM
ON KEY LABEL F9
ON KEY LABEL F10
sele iteoc
SEEK m.Periodo + m.NumOc 
vTothoc = 0
SCAN WHILE M.PERIODO+M.NUMOC=PERIODO+NUMOC
	 vTothoc = vTothoc + valtot
*     SELE ITEPEC
*     SET ORDE TO ITEPEC7
*     SEEK iteoc.periodo+iteoc.numoc &&+iteoc.codfte+iteoc.codart+alltrim(iteoc.numord)
*     IF found()
*        IF rlock()
*           replace preuni with iteoc.preuni, CODCAD WITH ITEOC.CODCAD, CODFTE WITH ITEOC.CODFTE &&AQUI
*        ENDIF
*        UNLOCK
*     ELSE
*        do standby with 'Pecosa no hallado ...'
*     ENDIF
     sele iteoc         
ENDSCAN
SELE IteOc1
SEEK M.PERIODO+M.NUMOC
IF FOUND()
	IF YesNo("Desea modificar Autom ticamente el valor de las P rtidas")
		REPLACE ValPart WITH vTotHOC, igv WITH IIF(m.Igv='F','S','N')
	ENDIF
ENDIF
 ACTIVATE SCREEN
 vTempo = '°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°'
 DO Logos WITH Rotulo1,vTempo
 SHOW MENU mMenu
 SELECT Orden
 if lastkey()=27
    OQ =.F.
    return .f.
 endif
 do trab_hijo && se adicionan los componentes, metas y partidas
 RETURN


PROCEDURE agreg_OC
*-----------------
VALIAS = ALIAS()
OQ=TRABAJA_HJ()
IF OQ
  DO ACTUALIZ_C WITH 1
ENDIF
ON KEY LABEL F5  DO Agreg_oc
ON KEY LABEL F8  DO Elimi_oc
ON KEY LABEL F10 KEYBOARD CHR(23)
ACTIVATE SCREEN
HIDE MENU mMenu
vTempo = '°°°°°°°°F5->Agregar°°°°°°°°°°°°°°F8->Eliminar°°°°°°°°°°°°°°F10->Terminar°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
SELECT (VALIAS)
return OQ

PROCEDURE ELIMI_OC
*-----------------
PRIVATE vFun,vKey
vfun = .t.
SELE ITEPEC
SET FILT TO
SET ORDE TO ITEPEC7
GO TOP
seek iteoc.periodo+iteoc.numoc+iteoc.codfte+iteoc.codart			&&+iteoc.numord

if found()
  IF RLOCK()
   	REPLACE orden with ' ',estado with iif(vtipo= 'C','20','00'),;
   	        NUMOC WITH SPACE(4)
  ENDIF
  UNLOCK  
else
  do standby with 'Advertencia:No es ubicado la Pecosa,Revise'
  vFun=.f.
ENDif

SELECT ITEoc
IF RLOCK() and vfun
   DELE NEXT 1
ENDIF
RETURN


PROCEDURE ELIMI_C
*----------------
SELE ITEPEC
vTemp=Recno()
SET ORDE TO ITEPEC3
SET FILTER TO ITEPEC.CODART=ITESC.CODART AND ITEPEC.NUMSC=M.NUMSC
GO TOP
SCAN
  IF RLOCK()
     REPLACE LLAVE WITH '.' ESTADO WITH '10',NUMSC WITH '    '
  ENDIF
  UNLOCK
ENDSCAN
SET FILTER TO
SET ORDE TO ITEPEC2

SELECT ITESC
IF RLOCK()
  DELE NEXT 1
ENDIF
RETURN

PROCEDURE Obs_Item
*-----------------
ON KEY LABEL F10 KEYBOARD CHR(23)
ON KEY LABEL F9

DEFINE WINDOW Detalle FROM 03,12 TO 20,67 FLOAT NOCLOSE SHADOW DOUBLE TITLE ALLTRIM(Descri) FOOTER ' ° ®Esc¯ Sale ° ' COLOR SCHEME 1

IF WVISIBLE("Detalle")
	ACTIVATE WINDOW Detalle SAME
 ELSE
	ACTIVATE WINDOW Detalle NOSHOW
ENDIF

MODIFY MEMO Observa WINDOW Detalle
IF !WVISIBLE("Detalle")
	ACTIVATE WINDOW Detalle
ENDIF
RELEASE WINDOW Detalle

ON KEY LABEL F9 DO Obs_Item

RETURN .T.


PROCEDURE Anula
*--------------
SELE orden
PRIVATE vFun,vKey
IF EOF()
	DO standby WITH Vmens08
	RETURN
ENDIF
IF Estado # '00'
	* ya pas¢
	DO STANDBY WITH Vmens10
	RETURN
ENDIF
velimina = YESNO('¨ Desea ANULAR ‚sta Orden de Compra ?')
IF vElimina
	sele iteoc
	vfun = .t.
	SCAN WHILE periodo+numoc+codfte = orden.periodo + orden.numoc + orden.codfte
		vArt = iteoc.codart
		vPrv = orden.codprv
		vkey = iteoc.periodo+iteoc.numoc+iteoc.codfte
		*vfun = .t.
		SELE ITEPEC
		SET ORDE TO ItePec7
		vTemp=Recno()
		vkey = iteoc.periodo+iteoc.numoc+iteoc.codfte+iteoc.codart
		SEEK VKEY
		
		If FOUND()
			IF RLOCK()
				REPLACE orden with ' ',estado with '00',;
				NUMOC WITH SPACE(4)
			 ELSE
				do standby with 'Advertencia:La Pecosa no se habilit¢'
				vFun=.f.
			ENDIF
			UNLOCK
		 else
			do standby with 'Advertencia:No es ubicado la Pecosa,Revise'
			vFun=.f.
		ENDif
		SELECT ITEoc
		IF RLOCK() and vfun
			REPLA ESTADO WITH '99'
		ENDIF
		UNLOCK
	ENDSCAN
	SELE ORDEN
	if vfun
		IF  RLOCK()
			REPLACE ESTADO WITH '99' ,FECVER WITH DATE(),user WITH vUser_ID,user_fc WITH date(),user_TP WITH 'A'
		ENDIF
	endif
	UNLOCK
	DO Vista
ENDIF
RETURN
 
 *VAMOS
 
PROCEDURE Agreg_Ic
*-----------------
PRIVATE VFUN
VFUN=.F.
SELE ITEOC
IF F_appd()
	REPLACE NumOc   WITH m.NumOc ,;
			Periodo WITH m.Periodo ,;
			CodCad  WITH m.CodCad ,;
			CodFte  WITH m.Codfte ,;
			Codart  WITH '     ',;
			descri  WITH spac(60) ,;
			canreQ  WITH 0 ,;
			ESTADO  WITH '00',;
			fecoc   WITH m.fecoc
	VFUN=.T.
ENDIF
* Do standby with 'El N£mero de O/C ya ha sido generado por '+alltrim(user)+' Revise..'
* vfun=.f.
RETURN VFUN


PROCEDURE ELIMI_ic
*-----------------
PRIVATE VFUN
VFUN = .F.
SELE ITEPEC
SET ORDE TO ITEPEC7
SEEK iteoc.periodo+iteoc.numoc+iteoc.codfte+iteoc.codart+iteoc.numord
IF FOUND()
   IF RLOCK()
      REPLACE orden WITH ' ' ESTADO WITH '20',NUMoc WITH '    '
      VFUN = .T.
   ENDIF
   UNLOCK
ELSE
   IF M.TIPO='M'
      VFUN = .T.
   ENDIF
ENDIF  
SELECT ITEoc
IF VFUN
   IF RLOCK()
      DELE NEXT 1
   ENDIF
   UNLOCK
ELSE
   DO STANDBY WITH 'No se ubic¢ el Pecosa ...'
ENDIF

RETURN


PROCEDURE Agreg_Item
*-------------------
PRIVATE VFUN
VFUN=.F.
SELEC ITEOC
vtipord = pecosa.tippec
APPEND BLANK
  REPLACE NumOc   WITH m.NumOc ,;
          Periodo WITH m.Periodo ,;
          CodCad  WITH m.CodCad ,;
          CodArt  WITH Itepec.CodArt ,;
		  CodPart WITH Iteoc1.CodPart ,;
          CodFte  WITH m.Codfte ,;
          CanReq  WITH Itepec.Canreq ,;
          CodUni  WITH Itepec.Coduni ,;
          DesCri  WITH Itepec.Descri ,;
          Preuni  WITH Itepec.Preuni ,;
          Perpec  WITH PADL(MONTH(Pecosa.fecpec),2,"0"),;
          numpec  WITH Itepec.numpec ,;
          CodDep  WITH Pecosa.Coddep ,;
          PctDto  WITH ItePec.PctDto ,;
		  PctIgv  WITH ItePec.PctIgv ,;
          Valtot  WITH ROUND((Preuni*Canreq)*((100-PctDto)/100)*((100+PctIgv)/100),2),;
          Estado  WITH '00',;
          fecoc   WITH m.fecoc,;
   	      observa WITH itepec.observa,;
   	      numord  WITH itepec.numord
  VFUN=.T.

*tipord  WITH vtipord,;   	      
RETURN VFUN



PROCEDURE VALER
*--------------
SELECT Parma
SEEK 'CORREL'+iif(alltrim(m.CodFte)='TRN','ORDTRN','ORDPRP')
 m.numOc =padl(alltrim(str(Parma.NumEnt + 1)),4,'0')
RETURN .T.


PROCEDURE VALERX
*---------------
SELECT Parma
SEEK 'CORRELORDENC'
vNumOc = Parma.NumEnt + 1
DO WHILE .T.
	m.numOc =padl(alltrim(str(vNumoc)),4,'0')
	@  1,25 GET m.NumOc   DISABLE    
	SELE ORDEN
	SEEK m.periodo+m.NumOc &&+alltrim(m.codfte)
	IF FOUND()
	    DO STANDBY WITH 'La O/C ya ha sido generada'
        vnumoc = vnumoc + 1
        LOOP
    ELSE
        EXIT    
    ENDIF        
ENDDO
RETURN .T.


PROCEDURE VALMES
*---------------
IF alltrim(m.Nummes)#vmes
   do standby WITH 'No Coincide con Mes del Calendario'
endif   
return


PROCEDURE NUMERA
*---------------
SELE ORDEN
SEEK m.periodo+m.NumOc &&+alltrim(m.codfte)
IF FOUND()
    DO STANDBY WITH 'La O/C ya ha sido generada'
    RETURN .F.
ELSE
	RETURN .T.
ENDIF	


PROCEDURE AS_PRV
*---------------
vAntprv = codprv
return .t.


*PROCEDURE ORD_1
*--------------
SELE ITEPEC
SET FILT TO
SET ORDE TO (ORANT)
RETURN


PROCEDURE ORD_2
*--------------
SELE ITEPEC
SET ORDE TO 8
SET FILT TO ESTADO=VESTA
RETURN


PROCEDURE BUSPEC
*---------------
ACTIVATE WINDOW WIND_4
VNUMPEC='0000'
@ 0,1 say 'Ingrese N§ Pecosa => ' GET VNUMPEC PICTURE '!!!!' 
READ
DEACTIVATE WINDOW WIND_4
SEEK m.PERIODO+ALLTRIM(VNUMPEC)
RETURN

 
PROCEDURE Marca
*--------------
REPLACE orden with 'x',numoc with m.numoc
return


PROCEDURE DesMarca
*-----------------
REPLACE orden with ' ',numoc with spac(4)
return


PROCEDURE ING_VAL
*----------------
IF RLOCK()
	REPLACE  Valtot with Preuni*Canreq 
ELSE
    RETURN .F.	
ENDIF
RETUR .T. 


PROCEDURE Lista
*--------------
SELECT ORDEN
SET RELATION TO PERIODO+NUMOC+CODFTE INTO ITEOC
vtemp =recno()
if eof()
   do standby with vmens08
   return
else
   DO LisOrd
endif
SELECT ORDEN
SET RELATION TO
SET ORDE TO OrdCom1
go vtemp
DO VISTA
RETURN


PROCEDURE lisOrd
*---------------
vOrde = ORDER()
DEFINE WINDOW LIS FROM 0,15 TO 24,65 FLOAT DOUBLE TITLE 'Listado Ordenes de Compra' COLOR SCHEME 5
ACTIVATE WINDOW LIS
STORE 1        TO vToCLI,vORDEN,vTipPro,vListado,vTofue,vTomes
vCli = SPAC(4)
vAno = SUBSTR(STR(YEAR(DATE()),4),3,2)
VFTE = SPAC(2)
vcodfte = SPAC(2)
vmes  = SPAC(2)
vmes1 = SPAC(2)
@ 01,01 SAY "     Tipo Listado : " GET vListado FUNCTION '^ por Documento;Detallado;Resumido;Control' 
@ 05,01 SAY "        Total O/C : " GET vTOCLI  FUNCTION '*RNH \<Si;\<No' SIZE 1,10,6   VALID VALTOD(VTOCLI,7,22) AND ASSIG() when vlistado =1
@ 07,01 SAY "              O/C : "
@ 07,22 GET vAno    picture '!!'   WHEN VTOCLI=2 and vlistado=1
@ 07,24 SAY '-'
@ 07,25 GET vCli    WHEN VTOCLI=2 and vlistado=1 PICTURE '!!!!' VALID VO() AND ValOrd()
@ 09,01 SAY "Todas las Fuentes : " GET vTofue  FUNCTION '*RNH \<Si;\<No' SIZE 1,10,6   VALID VALTOD(VTOfue,11,22)  WHEN (vlistado=2 OR  vlistado=3 OR VLISTADO=4)
@ 11,01 SAY "           Fuente : "
@ 11,22 GET vCodFte  PICTURE '!!' VALID VAL_PARA(vCodFte,'CODFTE','C') WHEN VTOFUE=2 AND (vlistado=2 OR  vlistado=3)
@ 13,01 SAY "     Ordenado por : " GET vOrden   FUNCTION '^ Numero;Proveedor;Emision;Fuente' WHEN vtocli=1 and (vlistado=2 OR  vlistado=3 OR VLISTADO=4)
@ 16,01 SAY "           Estado : " GET vTipPro  FUNCTION '^ Todos;Pendientes;Atendidos;Afectados;Anulados;Liquidados' WHEN vtocli=1 and (vlistado=2 OR  vlistado=3 OR VLISTADO=4)
@ 19,01 SAY "  Todos los Meses : " GET vtoMes   FUNCTION '*RNH \<Si;\<No' SIZE 1,10,6   VALID VALTOD(VTOmes,11,22)  WHEN (vlistado=2 OR  vlistado=3 OR VLISTADO=4)
@ 20,01 SAY "              Mes : "
@ 20,22 GET vMes     PICTURE '!!' VALID VAL_PARA(vMes,'FECMES','C') WHEN  VTOMES=2 AND (vlistado=2 OR  vlistado=3 OR VLISTADO=4)
@ 20,25 GET vMes1    PICTURE '!!' VALID VAL_PARA(vMes1,'FECMES','C') WHEN VTOMES=2 AND (vlistado=2 OR  vlistado=3 OR VLISTADO=4)

@ 22,10 GET OKCANCEL FUNCTION '*TH \!\<OK;\?\<Cancela' DEFAULT 1 SIZE 1,11,8

READ CYCLE

RELEASE WINDOW LIS

IF OKCANCEL = 1
	ACTIVATE WINDOW STANDBY
	@ 01,04 SAY 'Espere un momento........'
	vInd = SYS(3) + '.IDX'
	IF VLISTADO#4
		INDEX ON IIF(vOrden=1,NumOc,IIF(vOrden=2,CodPrv,iif(vOrden=3,DTOS(FECemi) ,Codfte+NumOc))) TO (vInd) ;
				FOR IIF(vToCli=1,.T.,Periodo+NumOc = vAno + vCli) .AND. IIF(vTipPro=1,.T.,iif(vTipPro=2,Estado = '00',iif(vTipPro=3,Estado = '40',iif(vTipPro=4,Estado = '20',iif(vTipPro=5,Estado = '99',Estado = '50')))))
		SET FILT TO iif(vtofue=1,.t.,Codfte=alltrim(vCODfte)) AND iif(vtoMES=1,.t.,BETW(MONTH(FECOC),VAL(VMES),VAL(VMES1)))
	 ELSE
		INDEX ON IIF(vOrden=1,NumOc,IIF(vOrden=2,CodPrv,iif(vOrden=3,DTOS(FECemi) ,Codfte+NumOc))) TO (vInd) ;
				FOR IIF(vToCli=1,.T.,Periodo+NumOc = vAno + vCli)  AND iif(vtofue=1,.t.,Codfte=alltrim(vCODfte)) AND iif(vtoMES=1,.t.,BETW(MONTH(FECOC),VAL(VMES),VAL(VMES1))) AND BUSPRV() 
	ENDIF
	SET INDEX TO (VIND)
	COUNT ALL TO vTotoc
	GO TOP
	DEACTIVATE WINDOW STANDBY
	vTitulo=IIF(vTipPro=1,'Listado Orden Compra',IIF(vTipPro=2,'Listado Orden de Compra Pendientes',IIF(vTipPro=3,'Listado de Ordenes de Compra Atendidas',IIF(vTipPro=4,'Listado Orden de Compra Afectadas',IIF(vTipPro=4,'Listado Orden de Compra Anuladas','Listado Orden de Compra Liquidadas')))))
	SET MEMOWIDTH TO 43
	IF !EOF()
		SET SKIP TO ITEOC
		do case
			case VLISTADO=1
				SET SKIP TO
				DO REPPRG WITH "LisOc3",' Ordenes de Compra',2
			case VLISTADO=2
				DO REPORTE WITH 2,"LisOrdc",' Ordenes de Compra ',1,.F.,.T.
			case VLISTADO=3
				DO REPORTE WITH 2,"LisOrdY",' Ordenes de Compra ',1,.F.,.T.        
			case VLISTADO=4
				DO REPORTE WITH 2,"ordcont",' Ordenes de Compra ',1,.F.,.T.
		ENDcase
		SELECT ORDEN
	 ELSE
		DO STANDBY WITH VMENS08
	ENDIF
	SET FILT TO
	CLOSE INDEX
	ERASE (VIND)
ENDIF
RETURN

PROCEDURE ASSIG
*--------------
vcli    = orden.NUMoc
vAno    = orden.PERIODO
vfte    = orden.codfte
RETURN  .T.

PROCEDURE VO
*-----------
vCli=Padl(alltrim(vCli),4,'0')
RETURN .T.

PROCEDURE Valord
*--------------
SELECT ORDEN
IF EOF()
   DO standby WITH Vmens08
   RETURN
ENDIF
SEEK vano+VCLI &&+ALLTRIM(vfte)
if !found()
    SET SKIP TO ITEOC
    GO TOP
	HIDE MENU mMenu
	ACTIVATE SCREEN
	vTempo = '°°°°°°°°°°°Presione ®F10¯ para seleccionar  o  ®Esc¯ para cancelar°°°°°°°°°°°°'
	DO Logos WITH Rotulo1,vTempo
	ON KEY LABEL F10 KEYBOARD CHR(23)
	BROWSE WINDOW Wind_0 NOEDIT NOAPPEND NODELETE NOMENU FIELDS ;
	NumOc  :H=' N§ ' ,;
	FecOc  :H='Fecha' ,;
	ess=IIF( Estado= '00','Pend',IIF( Estado = '10','Progra',IIF( Estado = '20','C/c ',IIF(Estado='99','Anul',IIF(Estado='50','Aten','    '))))) :H='Estd' ,;
	iteOc.descri :H='Articulo ' :36 ,;
	iteOc.coduni :H='Unid' ,;
	iteOc.Canreq :H='Cantid'
	vTempo = '°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°'
	DO Logos WITH Rotulo1,vTempo
	IF LASTKEY()=27
	   SELE ORDEN
	   SET RELATION TO
	ENDIF
	SHOW MENU mMenu
	ON KEY LABEL F10
	SELE ORDEN
 endif
 vAno = Orden.Periodo	 
 VCli = Orden.NumOC
 vFte = Orden.Codfte
 RETURN 



PROCEDURE Termi
*--------------
  vEn_accion = .F.
  ON KEY LABEL F2
  ON KEY LABEL F4
  ON KEY LABEL F9 
  ON KEY LABEL F7  
  HIDE WINDOW WIND_1
  DEACTIVATE MENU
  RETURN

PROCEDURE Fin_opcion
*-------------------
  CLOSE DATA
  RELEASE WINDOW wind_0
  RELEASE WINDOW wind_1
  RELEASE WINDOW wind_3
  RELEASE WINDOW wind_4
  RELEASE MENU   mMenu
  RESTORE SCREEN FROM PRINCIPAL
  RETURN

function valprv
*--------------
private xx, vfun
vfun = .f.
m.codprv= iif( empty(m.codprv),m.codprv,padl(alltrim(m.codprv),4,'0')) &&and estado="vg"
xx = val_prv( m.codprv,.t.,2,26)
if xx
   return .t.
endif
return vfun

function valOc
*-------------
parameter vnumOc
private vfun
vfun = .t.
m.numOc =padl(alltrim(str(vnumOc,4)),4,'0')
if m.numOc  = '0000' or empty(m.numOc)
   vfun = .f.
endif
return vfun

FUNCTION Observa
*---------------
vAlias = ALIAS()
SET MEMOWIDTH TO 43
ON KEY LABEL F10 KEYBOARD CHR(23)
ON KEY LABEL F9
IF !WEXIST("Observa")
   DEFINE WINDOW Observa FROM 05,18 TO 18,61 FLOAT NOCLOSE SHADOW DOUBLE TITLE '± Detalle O/C ±' FOOTER ' ° ®F10¯ Graba ° ' COLOR SCHEME 1
ENDIF

IF WVISIBLE("Observa")
   ACTIVATE WINDOW Observa SAME
ELSE
   ACTIVATE WINDOW Observa NOSHOW
ENDIF

MODIFY MEMO OBSERVa WINDOW OBSERVA NOEDIT

IF !WVISIBLE("Observa")
   ACTIVATE WINDOW Observa
ENDIF

RELEASE WINDOW Observa
IF LASTKEY()=27
   DO STANDBY WITH 'Proceso cancelado. No graba la Observaci¢n '
ENDIF

ON KEY LABEL F9 DO Observa

RETURN .T.

FUNCTION VisObs
*--------------
vAlias = ALIAS()
IF !WEXIST("Observa")
   DEFINE WINDOW Observa FROM 03,18 TO 20,61 FLOAT NOCLOSE SHADOW DOUBLE TITLE '± Detalle O/C ±' FOOTER ' ° ®Esc¯ Sale ° ' COLOR SCHEME 1
ENDIF

IF WVISIBLE("Observa")
   ACTIVATE WINDOW Observa SAME
ELSE
   ACTIVATE WINDOW Observa NOSHOW
ENDIF

MODIFY MEMO OBSERVa NOEDIT WINDOW OBSERVA

IF !WVISIBLE("Observa")
   ACTIVATE WINDOW Observa
ENDIF
RELEASE WINDOW Observa
RETURN .T.

procedure itep
*-------------
as=alias()
sele pecosa
seek iteoc.periodo+iteoc.numpec+iteoc.codfte
OK1 = PECOSA.DESTINO
sele (as)
retu (ok1)

procedure DESTINO
*---------------
PRIVATE AZ
aZ=alias()
SELE ITEOC
SEEK m.Periodo + m.NumOc &&+ ALLTRIM(m.CodFte)
select pecosa
seek iteoc.periodo+iteoc.numpec+iteoc.codfte
m.destino = IIF(EMPTY(m.destino),PECOSA.DESTINO,m.destino)
sele (aZ)
ACTIVATE WINDOW wind_5
@ 0,0 SAY 'Destino: ' get m.destino picture '@S73'
READ
DEACTIVATE WINDOW wind_5
retuR

PROCEDURE ALAN
*-------------
RETU
AX=ALIAS()
SELE ALAN
SEEK ALLTRIM(M.CODFTE)+ALLTRIM(M.NUMOC)
IF FOUND()
   M.NUMMES = ALAN.NUMMES
ELSE
   M.NUMMES = '00'
ENDIF      
SELE (AX)
RETURN

FUNCTION Val_ArtC  && Articulos
*------------------
PARAMETER xcod,_tipo,_x,_y
PRIVATE mEdita, mMsg, mAlias, v_fun, _oldWind,_campo
mEdita = (parameters()>=2)
mMsg   = (parameters()=4) .and.  _tipo
_campo = VARREAD()
ORD=ORDER()
mAlias = ALIAS()
SELECT IteArt
GO TOP
_OldWnd = WOUTPUT()
v_Fun=.f.
IF !mEdita
   SEEK xcod
   v_fun = IIF(FOUND(),Descri,"")
ELSE
   IF EMPTY(xcod)
      SET ORDER TO 2
      ACTIVATE SCREEN
      ON KEY LABEL F10 KEYBOARD CHR(23)
      ON KEY LABEL F8 DO BorrDet
      ON KEY LABEL F5 DO Agr2Det
      ON KEY LABEL F2 DO FunBusDet
      DEFINE WINDOW _BusArt FROM 2,01 TO 22,78
      BROWSE WINDOW _BusArt TITLE '²²²² [F10] Selecciona  [F5] Agrega  [F8] Elimina  [F2] Buscar ²²²²' NOLGRID NOEDIT NOAPPEND NODELETE NOMENU FIELDS;
        CodArt   :H='C¢digo' :W=.F. ,;
        Descri   :H='Nombre':70  ,;
        CodUni   :H='Unidad':7   
      vORD = RECNO()  
      GO TOP
      SCAN WHILE EMPTY(DESCRI)
           IF RLOCK()
              DELETE NEXT 1
           ENDIF    
      ENDSCAN  
      GO TOP
      GO vord
      ON KEY LABEL F10
      ON KEY LABEL F8
      ON KEY LABEL F5
      ON KEY LABEL F2
      RELEASE WINDOW _BusArt
      SET ORDER TO 1
      
      IF Lastkey()=27
         V_FUN = .f.
      ELSE
         xcod = CodArt
         IF mMsg
            @ _x,_y SAY Descri
         ENDIF
         SELECT (mAlias)
         IF !_tipo
            REPLACE &_campo WITH  xcod
         ENDIF
         v_fun = .T.
      ENDIF
   ENDIF
ENDIf
IF v_Fun
   SELECT iteoc
   IF RLOCK()
      REPLACE ;
          coduni  WITH Iteart.coduni,;
          preuni  WITH Iteart.preuni,;
          descri  WITH Iteart.descri
   ENDIF
endif
SELECT (mAlias)
SET ORDE TO (ORD)
ON KEY LABEL F5  DO Agreg_iC
ON KEY LABEL F8  DO Elimi_iC
ON KEY LABEL F10 KEYBOARD CHR(23)
UNLOCK ALL
RETURN v_fun

PROCEDURE IMPRIMIR
*-----------------
PRIVATE VCON
SELECT OrdEN
VCON = RECNO()
SCATTER MEMVAR
SET MEMOWIDTH TO 43
vNumOc = m.Periodo+m.NumOc &&+alltrim(m.Codfte)
SET RELATION TO periodo + NUMOC+CODFTE INTO ITEOC
set filt to Periodo+NumOc=vNumoc
*SET SKIP TO ITEOC
if eof()
   do standby with vmens08
   return
else
 DO REPPRG WITH "LisOc3",' ORDEN DE COMPRA'
endif
set skip to
set filter to
SET RELATION TO 
SELECT ordEN
GO VCON
DO VISTA
RETURN

PROCEDURE Titulo
*---------------
pagina = pagina  + 1
vTitulo = ' ORDEN DE COMPRA '
@ 0,1   SAY CHR(18)+CHR(14)
@ 0,15 SAY VTITULO+CHR(18)
@ 1,2   SAY cia
@ 1,70  SAY 'P g.'
@ 1,74  SAY pagina   PICTURE '##,###'
*@ 2,2   say "LISOC"
*@ 2,70  SAY DATE()
@ 3,04  SAY '                  ÚÄÄÄÄÄÄÄÄÄ¿'
@ 4,04  SAY 'ORDEN DE COMPRA : ³ '+Orden.Numoc+'.'+Orden.Nummes+' ³'
@ 4,62  SAY 'Estado : '+vEstOc(Orden.Estado)

@ 5,04  SAY '                  ÀÄÄÄÄÄÄÄÄÄÙ'
@ 5,59  say 'Fecha O/C:'+DTOC(Orden.fecoC)
@ 6,66  say IIF(!EMPTY(Orden.NUMHC),'H/C :','  ')+IIF(!EMPTY(Orden.NUMHC),Orden.PERHC+"."+Orden.NUMHC,' ')
@ 7,02  SAY ' SE¥OR(ES) : '+CHR(27)+'G'+val_prv(Orden.Codprv)+CHR(27)+'H'
@ 8,02  SAY '     R.U.C.: '+Promae.numruc
@ 9,02  SAY ' DIRECCION : '+Val_Fun('ProMae','CodPrv','Dirpro',Orden.Codprv)
@ 10,02  SAY ' -Le agradecemos enviar a nuestro Almac‚n :' + direw
@ 11,1 say chr(15)
@ 11,06 say IIF(SUBST(Orden.OBSERVA,1,4)<>SPACE(4),'OBS.:'+CHR(15)+Orden.OBSERVA+CHR(18),' ')+CHR(18)
@ 12,02 say ' -Facturar a nombre de :'+ detaw +  ' RUC NRO. : ' + rucw +CHR(15)
@ 13,02 SAY IIF(ORDEN.TIPO='M',"REFERENCIA : "+MEMORAN,CHR(18)+VALCCC()+CHR(15))
@ 14,05 SAY 'ÚÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄ¿'
@ 15,05 SAY '³Pecosa ³  C¢digo   ³Unidad³                Art¡culo                                     ³Cantidad³Pre.Uni.³%    ³Dscto   ³ I.G.V.³    Total  ³'
@ 16,05 SAY 'ÀÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÙ'
linea = 17
RETURN



PROCEDURE LisOC3
*---------------
PARAMETER _desti
private nReg
IF _desti=2
   SET PRINTER TO (p_fil)
ENDIF
SET DEVICE TO PRINT
Impri    = .F.
xColumna = SPACE(7)
GO TOP
SCAN
	STORE 0 TO pagina, linea, vSuma, vSumIgv
	nReg = RECNO()
	SELE IteOC
	SCAN WHILE Orden.NumOC = IteOC.NumOc
		IF pagina = 0 .OR. linea > 60
			DO Titulo
		ENDIF
		DO CASE
			CASE linea < 33
				@ LINEA,1   SAY CHR(15)
				@ LINEA,08  SAY iteoc.numpec
				@ LINEA,15  SAY iteoc.codart
				@ LINEA,27  SAY ITEoC.codUNI
				@ LINEA,35  SAY ALLTRIM(ITEoC.DEScri) + IIF(EMPTY(MLINE(Iteoc.observa,1)),' ',' - '+ALLTRIM(MLINE(Iteoc.observa,1)))
				@ LINEA,93  SAY ITEoc.CANreq PICTURE '99,999.999'
				@ LINEA,104 SAY ITEoc.PREUNI PICTURE '9,999.9999'
				@ LINEA,115 SAY ITEoc.PctDto PICTURE '99.99'
				xPctDto = (ITEoc.PREUNI*ITEoc.CANreq)*(ITEoc.PctDto)/100
				@ LINEA,121 SAY xPctDto PICTURE '99.99'

				nIgv = IIF(DTOC(Orden.FecOC,1)>'20110228',1.18,1.19)

				xPctIgv = IIF(m.IGV="F",ROUND(ITEOC.valtot-(ITEOC.valtot/nIgv),2),ROUND(ITEOC.valtot-(ITEOC.valtot/(1+IteOC.PctIGV/100)),2))
*				xPctIgv = ITEoc.PREUNI*ITEoc.CANreq*(100-ITEoc.PctDto)/100*(IteOc.PctIgv)/100
				@ LINEA,128 SAY xPctIgv PICTURE '9,999.99'
				@ LINEA,136 SAY ITEOC.valtot PICTURE '999,999.99'
				vSuma = vSuma + ITEOC.valtot
				vSumIgv = vSumIgv + xPctIgv
				linea = linea + 1
			CASE linea >= 33
				@ linea,1 say Chr(18)
				@ linea,05 say repli('-',80)
				linea = linea + 1
				@ linea,50 say 'S U B T O T A L   S/.'
				@ Linea,71 say vSuma PICTURE '999,999.99'
				linea = linea + 2
				SELECT IteOC
				CC = RECNO()
				SELECT 1
				DO SUMARIO
				DO TITULO
				GO   cc IN IteOC
				SKIP -1 IN IteOC
				@ linea,01 say chr(18)
				@ linea,52 say 'V I E N E N  S/.'
				@ linea,71 say vSuma PICTURE '999,999.99'
				linea = linea + 1
			OTHER
		ENDCASE
		IF !EMPTY(ITEOC.OBSERVA)
			for xx = 2 to MEMLINES(ITEOC.OBSERVA)
				@ linea,37 say MLINE(Iteoc.observa,xx)
				linea = linea + 1
				if linea >= 33
					@ linea,1 say chr(18)
					@ linea,05 say repli('-',80)
					linea = linea + 1
					@ linea,56 say '    V A N   S/.'
					@ Linea,71 say vSuma PICTURE '999,999.99'
					linea = linea + 2
					SELECT 2
					CC = RECNO()
					SELECT 1
					DO SUMARIO
					DO TITULO
					SELECT 2
					GO CC
					SELECT 1
					@ linea,01 say chr(18)
					@ linea,52 say 'V I E N E N  S/.'
					@ linea,71 say vSuma PICTURE '999,999.99'
					@ LINEA,79  SAY CHR(15)
					linea = linea + 1
				endif
			endfoR
		ENDI    
	ENDSCAN
	SELE IteOc1
	vSumIgv = 0
	IF SEEK(Orden.Periodo+Orden.NumOC)
		SCAN WHILE IteOC1.Periodo+IteOC1.NumOC = Orden.Periodo+Orden.NumOC
			IF IteOC1.IGV = 'S'
				vSumIgv = vSumIgv + IteOC1.ValPart
			ENDIF
		ENDSCAN
		vSumIgv = ROUND(vSumIGV-(vSumIGV/nIgv),2)
	ENDIF
	SELE IteOc
*	set step on
	@ linea,1 say chr(18)
	@ linea,05 say repli('Í',80)
	linea = linea + 1
	IF vSumIgv>0
		@ linea,30 say 'I.G.V.  S/.'
		@ Linea,42 say vSumIgv PICTURE '9,999.99'
	ENDIF
	@ linea,56 say 'T O T A L   S/.'
	@ Linea,71 say vSuma PICTURE '999,999.99'
	linea = linea + 1
	@ Linea,71 say 'ÍÍÍÍÍÍÍÍÍÍÍÍ'
	linea = linea + 1
	GO nReg
	IF Orden.NumOC="0399" and orden.Periodo='03'
		do coDific1
	 ELSE
		do coDific
	ENDIF
	do sumario
	SELE orden
ENDSCAN
SET DEVICE TO SCREEN
SET PRINTER TO
RETURN


procedure codific
*----------------
VALIAS = ALIAS()
VORDER = ORDER()
VRECNO = RECNO()
@ linea,01 say '         SON :'+ LETRAS1(ORDEN.VALTOT,'NUEVOS SOLES')
linea = linea + 2
@ linea,1 say chr(15)
SEEK vNumOC
IF !EMPTY(Orden.DESTINO) 
	@ linea,04 say '     Destino : ' + ALLTRIM(Orden.DESTINO) +'  '+'Calendario : '+ NUMMES+'  '+val_para(orden.nummes,'FECMES','D',26,50)
	linea = linea + 1
ENDIF
*@ linea,04 say '  Calendario : '+ NUMMES+'  '+val_para(orden.nummes,'FECMES','D',26,50)
*linea = linea + 1
@ linea,04 say '  Cadena Fun.: '+ codcad + '   ' + ALLTRIM(val_codcad(m.Codcad,m.periodo,'D',26,60))
linea = linea + 1
@ linea,04 say 'Fte.Financia.: '+ codfte + '     ' + ALLTRIM(val_para(m.CodFte,'CODFTE','D',26,60))
linea = linea + 1
@ linea,04 say '     Funci¢n : '+ ALLTRIM(maepre.CODFUN) + '     ' + ALLTRIM(val_para(maepre.codfun,'CODFUN','D',26,60))
linea = linea + 1
@ linea,04 say '    Programa : '+ ALLTRIM(maepre.CODPRG) + '    ' +ALLTRIM(VAL_PARA1(maepre.CodPrg,'CODPRG'+maepre.codfun,'D',26,60))
linea = linea + 1
@ linea,04 say ' SubPrograma : '+ ALLTRIM(maepre.CODSPR) + '   ' +ALLTRIM(VAL_PARA1(maepre.CodSPr,'CODSPR'+maepre.codprg,'D',26,60))
linea = linea + 1
@ linea,04 say 'Activ./Proye.: '+ ALLTRIM(maepre.ACTPRY) + ' ' +ALLTRIM(val_para(maepre.actpry,'ACTPRY','D',26,60))
linea = linea + 1

SELEC ITEOC1
SET FILTER TO periodo+numoc = ORDEN.periodo+ORDEN.numoc
go top
DO WHILE .T. AND !EOF()
    @ LINEA,1   SAY CHR(15)
    @ LINEA,04  SAY '   Componente : ' + codcom
    @ LINEA,26  SAY 'Meta : '+ codmet
    @ LINEA,40  SAY CHR(18)+CHR(27)+"G"+ "Partida:"
    @ LINEA,52  SAY codpart
    @ LINEA,60  SAY Valpart  PICTURE '9,999,999.99'
    @ LINEA,86  SAY +CHR(27)+"H"+CHR(15)
    SKIP
    IF !EOF()
    	linea = linea + 1
		VRECNO1 = RECNO()
    	DO CASE
      		CASE linea >= 47
          		SELECT 1
          		DO SUMARIO
          		DO TITULO
          		@ linea,52 say 'V I E N E N '
          		linea = linea + 2
    	  		SELEC ITEOC1
    	  		GO VRECNO1
		ENDCASE  
	ENDIF
ENDDO	
SET FILTER TO
SELECT (VALIAS)
SET ORDER TO (VORDER)
GO VRECNO
return

procedure codific1
*-----------------
VALIAS = ALIAS()
VORDER = ORDER()
VRECNO = RECNO()
@ linea,01 say '         SON :'+ LETRAS1(ORDEN.VALTOT,'NUEVOS SOLES')
linea = linea + 2
@ linea,1 say chr(15)
SEEK vNumOC
IF !EMPTY(Orden.DESTINO) 
	@ linea,04 say '     Destino : ' + ALLTRIM(Orden.DESTINO) +'  '+'Calendario : '+ NUMMES+'  '+val_para(orden.nummes,'FECMES','D',26,50)
	linea = linea + 2
ENDIF

@ linea,04 say '               Cadena   Fuente   Funci¢n   Programa  SubPrg.   Act/Pry.  Componente   Meta   Asignaci¢n     Total'
linea = linea + 1
@ linea,04 say '               ------   ------   -------   --------  ------    -------   ----------   ----   ----------     -----'
linea = linea + 1

SELEC ITEOC1
SET FILTER TO periodo+numoc = ORDEN.periodo+ORDEN.numoc
go top
DO WHILE .T. AND !EOF()
    @ LINEA,1   SAY CHR(15)
    @ LINEA,20  SAY CodCad
    =val_codcad(Codcad,periodo,'D',26,60)
    @ LINEA,30  SAY CodFte
    @ LINEA,39  SAY Maepre.Codfun
    @ LINEA,49  SAY Maepre.CodPrg
    @ LINEA,58  SAY Maepre.CodSpr
    @ LINEA,67  SAY Maepre.Actpry
    @ LINEA,79  SAY Maepre.CodCom
    @ LINEA,90  SAY codmet
*    @ LINEA,95  SAY CHR(18)+CHR(27)+"G"
    @ LINEA,99  SAY codpart
    @ LINEA,105 SAY Valpart  PICTURE '9,999,999.99'
*    @ LINEA,119 SAY +CHR(27)+"H"+CHR(15)
    SKIP
    IF !EOF()
    	linea = linea + 1
		VRECNO1 = RECNO()
    	DO CASE
      		CASE linea >= 47
          		SELECT 1
          		DO SUMARIO
          		DO TITULO
          		@ linea,52 say 'V I E N E N '
          		linea = linea + 2
    	  		SELEC ITEOC1
    	  		GO VRECNO1
		ENDCASE  
	ENDIF
ENDDO	
SET FILTER TO
SELECT (VALIAS)
SET ORDER TO (VORDER)
GO VRECNO
return

PROCEDURE sumario
*----------------
@ 46,1  SAY CHR(18)
@ 47,07 SAY 'ÚÄ¿                                       ÚÄ¿'
@ 48,07 SAY '³1³                                       ³3³'
@ 49,07 SAY 'ÀÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ-        ÀÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ-'
@ 50,07 say '     Director de Abastecimiento                   Jefe de Almacen '

@ 53,07 SAY 'ÚÄ¿                                                RECIBI CONFORME:  '
@ 54,07 SAY '³2³                                              ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿ '
@ 55,07 SAY 'ÀÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ-               ³ Fecha:   /  /   ³ '
@ 56,07 say '       Jefe de Adquisiciones                     ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ '

@ 57,07 SAY chr(15)+'Elaborado por: '+ Vusua(m.User)
@ 57,56 SAY chr(15)+'Corregido por: '+ IIF(!EMPTY(m.User_Cr),Vusua(m.User_Cr),"")
@ 58, 1 say chr(15)+'Nota: Esta Orden es Nula sin la firma del Jefe de Abastecimiento. Nos reservamos el derecho de'
@ 59, 1 say chr(15)+'      devolver la mercader¡a que no est‚ de acuerdo con nuestras especificaciones.'+chr(18)+chr(12)
linea = 1
RETURN


PROCEDURE LIQUIDAR
*-----------------
PRIVATE OK
*OK=VE_PASSW('LMNS')
*IF OK
DO CASE
*   CASE ESTADO = '00'
*       DO STANDBY WITH 'El Documento a£n no est  afectado'
*       do vista
   CASE ESTADO = '50'
        DO STANDBY WITH 'El Documento ya est  liquidado'
        do vista
        return
   CASE ESTADO = '99'
        DO STANDBY WITH 'El Documento ya est  Anulado'
        do vista
        return
ENDCA            
IF YESNO('Est  seguro de Liquidar esta O/C')
   activate WINDOW STANDBY
   vfecvis=date() 
   @ 1,1 say 'Ingrese Fecha-> ' get vfecvis
   read
   deactivate WINDOW STANDBY
   IF RLOCK()
      REPLACE tipdoc WITH 'OK',FECVIS WITH vfecvis
      BUSOC=NUMOC
   ENDIF 
   do wstock
else 
   DO STANDBY WITH 'Proceso Cancelado'
endif
do vista
*ENDIF
retu

FUNCTION Val_cal
*----------------
 PARAMETERS xtotoc
 vTotal = 0
 SELECT Itepec
 VORD = ORDER()
 IF !EOF()
   SET ORDER TO ITEPEC1
   GO TOP
 	SCAN FOR orden+periodo+numoc = 'x'+m.periodo+m.numoc AND ESTADO='00' &&estado#'30'
 		vtotal = vtotal + Preuni*Canreq
 	ENDSCAN
 	IF xTotOc < vtotal
		SET ORDER TO (vord)
		xtotoc = 0
		RETURN .F.
 	ENDIF
 	SET ORDER TO (vord)
 ENDIF
 RETURN .T.


Function repasa
*--------------
vfun = .t.
vrec = recno()
vali = alias()
select ORDEN
set order to ORDCOM1
GO TOP
SET FILTER TO 
AS = RECNO()
IF FOUND()
   go as
ENDIF  
numr = 0001  					&&  Data
do while .t.
   if val(numOC)=numr
      numr = numr + 1
      skip
      loop
   else 
      exit   
   endif   
enddo

m.numoc=padl(alltrim(str(numr,4)),4,'0')
if m.numoc = '0000' or empty(m.numoc)
   vfun = .f.
else
	SELE ORDEN
	IF F_APPD() 
    	 replace periodo with m.periodo,;
				 numoc with m.numoc,;
				 estado with '00',;
				 user_tp with 'E',;
				 user with vUser_ID
     	 gh = recno()
	ENDIF 
	UNLOCK
endif


SELECT Parma
SEEK 'CORRELORDENC'
REPLACE NumEnt WITH NumR 
sele (vali)
return vfun

Function repasa1
*--------------
vfun = .t.
vrec = recno()
vali = alias()
SELE Parma
SEEK "CORREL"+"ORDENC"
IF !FOUND()
	DO StandBy WITH "No Existe Parametro de correlativo de pecosa. Avise al Area de Sistemas"
	mret = PADL(ALLTRIM(STR(0)),4,'0')
 ELSE
	nOldCor = Parma.NumEnt
	mRet= PADL(ALLTRIM(STR(Parma.NumEnt+1)),4,'0')
	
*	IF f_Lock(1)
*		REPLACE NumEnt WITH Parma.NumEnt+1
*		UNLOCK
*	ENDIF
ENDIF
SELE (vAli)
RETURN mRet

procedure PRestado
*-----------------
use in 11
use in 12
USE Cheque   IN 13  ORDER TAG Cheque1  ALIAS Cheque
USE Compag   IN 14  ORDER TAG Compag1  ALIAS compag
DO Estado WITH 'OC','m.perhc+m.numhc'
use in 13
use in 14
USE Itehc    IN 11  ORDER TAG Itehc1   ALIAS Itehc
USE HOJMOD   IN 12  ORDER TAG HOJMOD1  ALIAS HOJMOD
RETURN


PROCEDURE VALCCC
*---------------
PRIVATE AS,vnumccc
USE Solcot  IN 10  ORDER TAG Solcot1  ALIAS solcot
USE IteSC   IN 11  ORDER TAG Itesc1   ALIAS Itesc
USE IN 12 

AS=ALIAS()
VCC=ITEOC.NUMPEC+ITEOC.CODART+ALLTRIM(ITEOC.NUMORD)
SELEct ITESC
SET RELA TO PERIODO+NUMSC INTO SOLCOT
SET ORDE TO ITESC4
SEEK VCC
VNUMCCC=IIf(FOUND(),"   CUADRO COMPARATIVO : "+SOLCOT.NUMCCC,'   ')
set rela to
SELEct (as)

USE HojCon   IN 10  ORDER TAG HojCon1  ALIAS Hoja
USE Itehc    IN 11  ORDER TAG Itehc1   ALIAS Itehc
USE HOJMOD   IN 12  ORDER TAG HOJMOD1  ALIAS HOJMOD

return vnumccc


procedure busprv
*---------------
private ali,vkey
ali=alias()
vkey = codprv
select promae
SEEK vkey
if found()
   if estado='VG'
      vfun = .F.
   else
      vfun = .T.
   endif     
else   
   vfun = .T.
endif
select (ali)
return vfun


PROCEDURE Trab_hijo            && Revisi¢n de BD en browse CUANDO # O/?
*------------------
*PRIVATE vCadena

as    = ALIAS()
vTemp = RECNO()
HIDE MENU mMenu
ACTIVATE SCREEN
vTempo = '°°°°°°°°°°°°F5->Agregar°°°°°°°°°°F8->Eliminar°°°°°°°°°°°F10->Terminar°°°°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
ON KEY LABEL F5  DO Agre_ItOC
ON KEY LABEL F8  DO elim_itoc
ON KEY LABEL F10 KEYBOARD CHR(23)
SELECT iteoc1
SET ORDE TO ITEOC11
seek m.periodo +m.Numoc

SET RELATION TO Periodo+uniges+unieje+codcad INTO MaePre ADDITIVE

if !found()
	DO Agre_ItOC
else
	DO Borra_Oc	
endif

BROWSE WINDOW Wind_2A NOAPPEND NODELETE NOMENU key m.periodo +m.Numoc FIELDS ;
		CODCad	: H= 'Cadena'	    :V=val_CODCAD(ALLT(codcad),periodo,'CodCad'):F ,;
		CODCOM	: H= 'Componente'	:V=Val_comp(periodo+maEPRE.uniges+maepre.unieje+codcad,codcom,'codcom'):F ,;
		CODMET	: H= 'Meta' 		:V=Val_meta(periodo+maEPRE.uniges+maepre.unieje+codcad,CODCOM+codmet,'codmet'):F ,;
		CodPart	: H= 'Partida' 		:V=VAL_cale(codpart,periodo+maepre.uniges+maepre.unieje+maepre.Codfun+maepre.CodPrg+maepre.CodSpr+maepre.ActPry+codcom+codmet+allt(codfte)+allt(nummes),'codpart'):F ,;		
		ValPart : H='Monto' :P='99,999,999.99',;
		Igv     : H='Igv' 	:P='@M S,N'

SET RELATION TO

*		aa = IIF(EMPTY(CodPart),' ',IIF(LEN(ALLTRIM(CodPart))=6,val_para(SUBSTR(codpart,5,2),'ESPGAS','D'),VAL_PARA1(SUBSTR(CodPart,7,2),'SUBESP'+SUBSTR(CodPart,5,2),'D'))) :H='Descripci¢n':40
*		CodPart	: H= 'Partida' 		:V=VAL_cale(codpart,periodo+vcadena+codcom+codmet+allt(codfte)+allt(m.nummes),'codpart'):F ,;
*aa = IIF(EMPTY(CodPart),' ',val_para(SUBSTR(codpart,5,2),'ESPGAS','D',28,40)) :H='Descripci¢n':40,;

* oJO CON LA PARTIDA

vTempo = '°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°'
DO Logos WITH Rotulo1,vTempo

* CodPart  : H= 'Partida' :F ,;

SELECT iteoc1
seek m.periodo + m.Numoc
vtotcom = 0
SCAN WHILE PERIODO + NUMOC = m.periodo + m.Numoc
	vtotcom = vtotcom + valpart
	IF VALPART=0
		DELETE NEXT 1
	ENDIF
ENDSCAN	
IF vtotcom <> vTothoc
	DO STANDBY WITH ('Total Compon. es diferente al total de  O/C...Revise...')
ENDIF	
DO AsiOrd


SHOW MENU mMenu
ON KEY LABEL F5
ON KEY LABEL F7
ON KEY LABEL F8
ON KEY LABEL F10
SET FILTER TO
SELE (AS)
if lastkey()=27
   return .f.
endif
RETURN .t.


PROCEDURE Agre_ItOC
*------------------
sele iteoc1
vp = codpart
vuniges = vUGes
vunieje = vUEje

IF F_appd()
   REPLACE Periodo WITH m.Periodo ,;
   		  Numoc   WITH m.Numoc ,;
          CodCad  WITH m.CodCad,;
          Uniges  WITH vuniges,;
          UniEje  WITH vunieje
   UNLOCK
ENDIF

vcodcom = MAEPRE.codcom
vcodmet = MAEPRE.codmet

IF f_lock(1)
	REPLACE Codcom  WITH vCodcom,;
			Codmet  WITH vCodmet,;
			Codpart WITH Vp ,;
			valpart WITH vTotHOC,;
			IGV     WITH IIF(Orden.IGV="F","S","N")
*           valpart WITH ITEOC1.valpart
ENDIF
RETURN .T.







PROCEDURE elim_itoc
*-------------------
sele iteoc1
if rlock()
   delete next 1
endif
return



PROCEDURE Borra_oc            && Borra los items de itehc
*----------------
AX=ALIAS()
SELECT IteOc1
SEEK m.Periodo + m.NumOc
if rlock()
   SCAN WHILE Periodo+NumOc=m.Periodo+m.NumOc
   		* Elimina las asignaciones efectuadas en el calendario
   		SELECT CALEN
        SEEK m.periodo+vcadena+iteoc1.codcom+iteoc1.codmet+allt(m.codfte)+allt(m.nummes)+iteoc1.codpart
   		REPLACE TotOC WITH TotOC-iteoc1.Valpart
		SELECT ITEoc1
   ENDSCAN
endif
sele (AX)
retur


PROCEDURE Corri_Hj
*-----------------
ON KEY LABEL F7
ON KEY LABEL F9
ACTIVATE SCREEN
HIDE MENU mMenu
vTempo = '°°°°°°°°F5->Agregar°°°°°°°°°°°°°°F8->Eliminar°°°°°°°°°°°°°°F10->Terminar°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
ON KEY LABEL F5  DO Agreg_Ic
ON KEY LABEL F8  DO Elimi_Ic
ON KEY LABEL F10 KEYBOARD CHR(23)
SELE ITEOC
set orde to iteoc1
seek m.Periodo + m.NumOc    &&+m.Codfte
if !found()
   do agreg_ic
endif
*   
*if m.igv="F"
*	pctIgv=18.00
*else
*	pctIgv=0.00
*endif
*
*if vtipo='M'
*	BROWSE NOAPPEND NODELETE NOCLEAR NOMENU WINDOW Wind_2 key m.Periodo + m.NumOc FIELD ;
*   		CodArt      : H= 'C¢digo' :V=VAL_ARTC(codArt,.F.):F :W=EMPTY(CodArt) ,;
*   		Descri      : H= 'Descripci¢n'	:29 :W=.F. ,;
*   		CanReq      : H= 'Cantidad'		:P='99,999.999' ,;
*   		CodUni      : H= 'Uni'			:W=.F. :3,;
*   		PreUni      : H= 'PreUni'		:P='9,999,999.999' :V=ING_VAL():F,;
*		PctDto      : H= '% Dcto'		:P='999.999',;
*		PctIgv      : H= '% IGV '		:P='999.999',;
*		X=calcula1(): H='Total'			:P='9,999,999.99' 
*else
set step on
	BROWSE NOAPPEND NODELETE NOCLEAR NOMENU WINDOW Wind_2 key m.Periodo + m.NumOc FIELD ;
   		CodArt      : H= 'C¢digo' :V=VAL_ARTC(codArt,.F.):F :W=EMPTY(CodArt) ,;
   		Descri      : H= 'Descripci¢n'	:29 :W=.F. ,;
   		CanReq      : H= 'Cantidad'		:P='99,999.999' ,;
   		CodUni      : H= 'Uni'			:W=.F. :3,;
   		PreUni      : H= 'PreUni'		:P='9,999,999.999',;
		PctDto      : H= '% Dcto'		:P='999.999',;
		PctIgv      : H= '% IGV '		:P='999.999',;
    	X=calcula1(): H='Total'			:P='9,999,999.99' 
*endif
SELE ITEOC
seek m.Periodo + m.NumOc 
vTothoc = 0
SCAN WHILE Periodo + NumOc  = m.Periodo + m.NumOc
	vTothoc = vTothoc + valtot
*	IF !EMPTY(NUMPEC)
*		=agre_itoc1(m.Periodo+numpec,codart)
*	ENDIF
ENDSCAN 
seek m.Periodo + m.NumOc
ON KEY LABEL F5  DO Agreg_item
ON KEY LABEL F8  DO Elimi_item
*ON KEY LABEL F9  DO VISTA_DET
ON KEY LABEL F7  DO PREstado &&WITH 'OC','m.perhc+m.numhc' 
ON KEY LABEL F10
ACTIVATE SCREEN
vTempo = '°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
SHOW MENU mMenu
SELECT Orden
if lastkey()=27
	return .f.
endif
set relation to
do trab_hijo && se adicionan los componentes, metas y partidas
RETURN



FUNCTION agre_itoc1
*------------------
PARAMETER vKey,vCodart
vrecno = RECNO()
valias = ALIAS()
SELECT iteOC
=val_CODCAD(ALLT(iteOC.codcad),m.periodo,'C')
vuniges = MAEPRE.uniges
vunieje = MAEPRE.unieje
vcodcom = MAEPRE.codcom
vcodmet = MAEPRE.codmet
SELECT iteoc1
set orde to iteoc13
seek M.PERIODO+M.NUMOC+iteOC.CODCAD+vCODCOM+vCODMET
IF FOUND()
	REPLACE valpart WITH valpart+ITEOC.valTOT
ELSE 
	APPEND BLANK
   	REPLACE Periodo WITH m.Periodo ,;
     		NUMOC   WITH m.NUMOC,;
       		CodCad  WITH ITEOC.CodCad,;
       		uniges  WITH vuniges,;
       		unieje  WITH vunieje,;
       		Codcom  WITH vCodcom,;
       		Codmet  WITH vCodmet,;
       		valpart WITH ITEOC.valTOT
ENDIF
SELECT (valias)
GO vrecno 
RETURN


PROCEDURE VAL_MES
*----------------
IF VOPCION = 1
	SELECT PARMA
	SET ORDER TO PARMAE1
	M.FecOc  = date()
	*SEEK 'ORDENC'+ALLTRIM(M.NumMes)
	SEEK 'CORRELORDENC'
	if !found()
	   do standby with 'El Correlativo del Mes no est  Inicializado'
	   SELE orden
	   return .F.
	else
	  IF CODIGOAUX='00'
	     do standby with 'El Calendario del Mes '+alltrim(m.nummes)+' ya est  cerrado'
		 SELE orden
   		 return .F.
	  else
		  * m.NumOc=valHC(Parma.NumEnt + 1)
		  xx = IIF(m.Nummes='12','01',padl(alltrim(str((val(m.NumMes)+1),2)),2,'0'))
 		  if !val(m.nummes)=month(date())
		     m.FecOc = IIF( val(m.Nummes) < iif( xx='01',month(DATE())+12,month(DATE())),ctod('01/'+xx+'/'+ALLTRIM(STR(YEAR(m.fecOc),4))) - 1,date()) 		     
  		  endif
		  @  1,58 GET m.FecOc  WHEN .F.
		  READ
		  sele Orden
	      return .t.
	   endif
	endif
ELSE
   RETURN .T.
ENDIF

PROCEDURE AsiOrd
*---------------
*SELE Parma
*SEEK 'TIPDOCO/C'
*IF !FOUND()
*	DO StandBy WITH "PARAMETRO NO INICIALIZADO, CONSULTE AL AREA DE SISTEMAS"
*	RETURN
*ENDIF
USE AsiAut IN 0 ORDER TAG AsiAut1
SELE AsiAut
SEEK "O/C"+"   "+"ASTORD"
IF !FOUND()
	DO StandBy WITH "PARAMETRO DE CTAS. DE ORDEN INICIALIZADO, CONSULTE AL AREA DE SISTEMAS"
	RETURN
 ELSE
	cCtaD = DCuenta
	cCtaH = HCuenta
ENDIF
SELE AstOrd
SEEK m.Periodo+m.NumMes+m.NumOc+"O/C"
IF FOUND()
	FOR i = 1 TO 2
		IF f_Lock(1) OR RLOCK()
			REPLACE Periodo WITH m.Periodo ,;
					NUMMES	WITH m.NumMes  ,;
					NUMREF	WITH m.NumOC   ,;
					TIPDOC	WITH "O/C"     ,;
					FECHA	WITH m.FecEmi,;
					CODCTA	WITH IIF(i=1,cCtaD,cCtaH),;
					TIPCTA	WITH IIF(i=1,"D","H"),;
					MTODEB	WITH IIF(i=1,vtotcom,0),;
					MTOHAB	WITH IIF(i=2,vtotcom,0)
*					MTODEB	WITH IIF(i=1,m.ValTot,0),;
*					MTOHAB	WITH IIF(i=2,m.ValTot,0)
			UNLOCK
			SKIP
		ENDIF
	ENDFOR
 ELSE
	FOR i = 1 TO 2
		IF f_Appd()
			REPLACE Periodo WITH m.Periodo ,;
					NUMMES	WITH m.NumMes  ,;
					NUMREF	WITH m.NumOC   ,;
					TIPDOC	WITH "O/C"     ,;
					FECHA	WITH m.FecEmi,;
					CODCTA	WITH IIF(i=1,cCtaD,cCtaH),;
					TIPCTA	WITH IIF(i=1,"D","H"),;
					MTODEB	WITH IIF(i=1,vtotcom,0),;
					MTOHAB	WITH IIF(i=2,vtotcom,0)
*					MTODEB	WITH IIF(i=1,m.ValTot,0),;
*					MTOHAB	WITH IIF(i=2,m.ValTot,0)
			UNLOCK
		ENDIF
	ENDFOR
ENDIF

*VAMOS2

USE IN AsiAut
DEFINE WINDOW wAstOrd FROM 10,10 TO 15,70 ;
 TITLE ' ASIENTOS DE ORDEN' COLOR SCHEME 02
ACTIVATE WINDOW wAstOrd
@ 00,08  SAY 'Cuentas '
@ 00,18  SAY '        Debe '
@ 00,34  SAY '        Haber '
@ 01,04  SAY cCtaD PICTURE '!!!!!!!!!!!'
@ 01,18  SAY vtotcom PICTURE '99,999,999.99'
@ 02,12  SAY cCtaH PICTURE '!!!!!!!!!!!'
@ 02,34  SAY vtotcom PICTURE '99,999,999.99'
WAIT " "
DEACTIVATE WINDOW wAstOrd
RELEASE WIND wAstOrd
RETURN

PROCEDURE WSTOCK
*------------------
SAVALI=ALIAS()
Cancomp=0
Cancom1=0
SELEC STOCK
*SET STEP ON
*SET ORDER TO STOCK2
Periow1 = Periodo
Periw   = Periodo
Tipdow1 = "O/C"
Numdow1 = Numdoc
SEEK Periodo+Tipdoc+Numdoc
IF !FOUND()
	SELEC ITEOC
	SEEK m.periodo+BUSOC
	DO WHILE !EOF() .AND. PERIODO=m.periodo .AND. NUMOC=BUSOC
    	Periw = Periodo
	    Codaw = CodArt
    	Numow = Numoc
	    Codfw = Codfte
    	Canrw = Canreq
	    Preuw = Preuni
    	fecow = Fecoc
        SELEC STOCK
		APPEND BLANK
		REPLACE Periodo with Periw
		REPLACE CodArt  with Codaw
		REPLACE Tipdoc  with "O/C"
		REPLACE Numdoc  with Numow
		REPLACE Fuente  with Codfw
		REPLACE Cantidad with Canrw
		REPLACE Cosmed   with Preuw
		REPLACE Fechamov with vfecvis
		REPLACE Tipomov with "E"
		Cancomp=Cancomp+Cantidad
		*DO CALCULO
		selec iteoc
		skip
	ENDDO
Else
	SCAN WHILE Periodo=Periow1 AND Tipdoc="O/C" AND Numdoc=Numdow1
		IF RLOCK()
			DELETE NEXT 1
		ENDIF
	 EndScan
	*----------------------
	SELEC ITEOC
	SEEK m.periodo+BUSOC
	DO WHILE !EOF() .AND. PERIODO=m.periodo .AND. NUMOC=BUSOC
    	Periw = Periodo
	    Codaw = CodArt
    	Numow = Numoc
	    Codfw = Codfte
    	Canrw = Canreq
	    Preuw = Preuni
    	fecow = Fecoc
    	SELEC STOCK
		APPEND BLANK
		REPLACE Periodo with Periw
		REPLACE CodArt  with Codaw
		REPLACE Tipdoc  with "O/C"
		REPLACE Numdoc  with Numow
		REPLACE Fuente  with Codfw
		REPLACE Cantidad with Canrw
		REPLACE Cosmed   with Preuw
		REPLACE Fechamov with vfecvis
		REPLACE Tipomov with "E"
		Cancomp=Cancomp+Cantidad
		go top
		SET FILTER TO Periodo=Periw AND Tipdoc="O/C" AND Codart=Codaw
		count to con
		*IF CON=1
			*DO CALCULO
		*ENDIF
		SET FILTER TO
		selec iteoc
		skip
	ENDDO
Endif


PROCEDURE CALCULO	&& Desactivado por cambio de programaci¢n
*-----------------
selec IteArt
seek Codaw
If Found()
	REPLACE CantIni with Canrw
	REPLACE PreUni  with Preuw
EndIf
selec (SAVALI)
return 

PROCEDURE SubOpc
*---------------
PRIVATE cAlias,cMod
cAlias = ALIAS()
SELE SubOp
cCtrlOp = ''
cMod = "01"

SEEK vUsuCla+PADL(SistCtrl,2,'0')+cMod

IF FOUND()
	SCAN WHILE vUsuCla+PADL(SistCtrl,2,'0')+cMod = ALLTRIM(SubOp.User)+SubOp.Sistema+SubOp.Modulo
		cCtrlOp = cCtrlOp + SubOp.Opcion
	ENDSCAN
ENDIF

set skip of PAD Revis of mMenu !'A' $cCtrlOp
set skip of PAD Busca of mMenu !'B' $cCtrlOp
set skip of PAD Anter of mMenu !'C' $cCtrlOp
set skip of PAD Proxi of mMenu !'D' $cCtrlOp
set skip of PAD Corri of mMenu !'E' $cCtrlOp
set skip of PAD Ingre of mMenu !'F' $cCtrlOp
set skip of PAD Anula of mMenu !'G' $cCtrlOp
set skip of PAD Lista of mMenu !'H' $cCtrlOp

SELE (cAlias)

RETURN

