PARAMETERS newsistem
*Realizado el 05-09-98
* ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
* ³ RegRi.PRG     21/11/96                             L: 2773   ³	
* ³ Registro de Recibos de Ingreso - Emisi¢n de Facturas         ³
* ÔÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¾
*- Abriendo Archivos
PUBLIC Idx1,AstOrdF
USE Parmae   IN  1  ORDER TAG Parmae1 	    ALIAS Parma
USE Cajas    IN  2  ORDER TAG Cajas1   		ALIAS Caja
USE RecIng   IN  3  ORDER TAG RecIng1  		ALIAS Ri
USE IteRi    IN  4  ORDER TAG IteRi1   		ALIAS IteRi
USE Ingreso  IN  5  ORDER TAG Ingreso1 		ALIAS IngR
USE AstPat   IN  6  ORDER TAG AstPat14  	ALIAS astpat
USE Cuentas  IN  7  ORDER TAG Cuentas1 		ALIAS cuenta
USE Auxil    IN  8  ORDER TAG Auxil1   		ALIAS Auxi
USE astpre   IN  9  ORDER TAG astpre20      ALIAS astpre  
USE Factura  IN 12  ORDER TAG Factura1 		ALIAS Fact
USE AstOrd	 IN 15	ORDER TAG AstOrd1		ALIAS AstOrd
USE MaePre   IN 16  ORDER TAG MaePre1       ALIAS maepre
USE ItePari  IN 25  ORDER TAG ItePari1      ALIAS ItePari          
USE Movbco   IN 10  ORDER TAG Movbco11  	ALIAS Movbco
*USE Reversio IN 14  ORDER TAG Rever1    	ALIAS Rever
USE RevSNU   IN 14  ORDER TAG Revsnu1    	ALIAS Rever
USE SubCtas  IN 17  ORDER TAG Subctas1      ALIAS Subcta
USE AsiAutRI   IN 26 ORDER TAG AsiAutRi1	ALIAS AsiAut
USE IteUsuOp IN 0 ORDER TAG IteUsuOp1 		ALIAS SubOp
USE CatAsi   IN 19  ORDER TAG CatAsi3       ALIAS CatAsi
USE IteCla   IN 18  ORDER TAG IteCla1       ALIAS IteCla

*- Mensajes de aviso al usuario
Vmens01 = ' Recibos de Ingreso : REVISION '
Vmens02 = ' °    Registro de Recibos de Ingreso   ° '
Vmens04 = 'Dicho R/I no fue encontrado'
Vmens05 = 'No existe R/I anterior'
Vmens06 = 'No existe R/I siguiente'
Vmens07 = '¨ Desea Anular este R/I ?'
Vmens08 = 'No hay registros para procesar'
Vmens09 = 'Este R/I ha sido anulado'
Vmens10 = 'El R/I ya est  atendido'
Vmens11 = 'El R/I ha sido devuelto'
Vmens12 = 'El R/I ya tiene cheque'

SELE AstPat
Idx1 = SYS(3)+'.Idx'
INDEX ON Periodo+NumMes+NumRef+TipDoc to (Idx1)		&&Este es para Asientos de Factura
SET ORDER TO AstPat14

SELECT Ri
GO BOTTOM

*- VaRiables de trabajo (registro a trabajar)
PUBLIC aa,vOrden,vOrd,vRec,vAli,vCli,vMes,vTipPro,vToCli,vCta,vAlo,vMesT,vKey,vTot1,M.TipAux,wCodPart,Mdescr,w_TipCtc,wclase,Vnumero,wtiprev
PUBLIC vcodprg,vcodsub,vproyec,vsubpry,vcodact,vflag1,vscta,vofig,vctc,Vdeb,vhab,w_ctaD,w_ctaH,w_clas,w_asip,vctadeb,vctahab,vvaldeb,vvalhab,wuser_id
PUBLIC fruc,fdescri,fdirecc,figv,fserie,fnumero,fconcepto,vconcurso,Dconcurso
PUBLIC mOpc
*vUser_ID = ALLTRIM(LEFT(SYS(0),15))
*wUser_ID= CHRTRAN(vUser_ID,'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789',;
          'XWAQSD!R$1Z2LH)^CEP&67UIYMTxw%/-+}{?')
STORE SPACE(1)  TO Vorden,w_asip
STORE SPACE(40) TO aa,vKey
STORE SPACE(2)  TO vMes,vMesT,vcodprg,vofig
STORE SPACE(3)  TO vcodsub,vproyec,vcodact
STORE SPACE(11) TO wCodPart
STORE SPACE(12) TO vdeb,vhab,w_ctaD,w_ctaH,vctadeb,vctahab
STORE SPACE(8)  TO vscta
STORE SPACE(9)  TO w_clas
STORE 0         TO vflag1,vvaldeb,vvalhab
STORE SPACE(4)  TO vsubpry
STORE SPACE(14) TO vctc
vhab  ='9607000700'
*w_ctaD='9307000000'   
SCATTER MEMVAR BLANK         && Crea variables en blanco

*- Inicia proceso
DO Inicia                    && Define ventanas, men£s, t¡tulos
HIDE POPUP ALL
DO Pantalla                  && Muestra pantalla inicial
DO Vista
ON KEY LABEL F2 DO VisObs
*- Activa men£ mientras vEn_accion es .T.
STORE .T. TO vEn_accion
DO WHILE vEn_accion
  ACTIVATE SCREEN
  ACTIVATE MENU mMenu
ENDDO
DO Fin_opcion
RETURN
*
PROCEDURE Inicia             && Crea ventanas, men£s y t¡tulos
*---------------
 ACTIVATE SCREEN
 vTempo = ' Revisa  Busca  AnteRior  Siguiente  CorRige  Ingresa  Anular   Listar  Termina '
 DO Logos WITH Rotulo1,vTempo

 DEFINE WINDOW Wind_0 FROM 00,00 TO 23,79  DOUBLE ;
 TITLE Vmens01 COLOR SCHEME 10

 DEFINE WINDOW Wind_1 FROM 00,00 TO 16,79  DOUBLE ;
 TITLE Vmens02 COLOR SCHEME 10 

 DEFINE WINDOW Wind_2 FROM 17,00 TO 23,79 DOUBLE ;
 TITLE 'Detalle: Rec.Ing.' ;
 COLOR SCHEME 10

 DEFINE WINDOW Wind_3 FROM 17,00 TO 23,79 DOUBLE ;
 TITLE 'Detalle: Bol.Dep.' ;
 COLOR SCHEME 10

 DEFINE WINDOW Wind_4 FROM 06,00 TO 23,79 DOUBLE ;
 TITLE 'Detalle: Factura [F10] para terminar' ;
 COLOR SCHEME 10

 DEFINE WINDOW wind_6 FROM 13,10 TO 18,70 ;
 TITLE ' ASIENTOS PRESUPUESTALES' COLOR SCHEME 02

 DEFINE WINDOW Wind_7 FROM 00,00 TO 23,79  DOUBLE ;
 TITLE Vmens01 COLOR SCHEME 10

 DEFINE WINDOW Wind_8 FROM 13,10 TO 17,70  ;
 TITLE 'Concurso de Licitaci¢n'  COLOR SCHEME 10

 DEFINE WINDOW Wind_9 FROM 13,10 TO 17,70  ;
 TITLE 'Actividades'  COLOR SCHEME 10

 DEFINE MENU mMenu COLOR SCHEME 3
 DEFINE PAD revis   OF mMenu PROMPT '\<Revisa'     AT 24,00
 DEFINE PAD busca   OF mMenu PROMPT '\<Busca'      AT 24,08
 DEFINE PAD anter   OF mMenu PROMPT '\<AnteRior'   AT 24,15
 DEFINE PAD proxi   OF mMenu PROMPT '\<Siguiente'  AT 24,25
 DEFINE PAD corRi   OF mMenu PROMPT '\<CorRige'    AT 24,36
 DEFINE PAD ingre   OF mMenu PROMPT '\<Ingresa'    AT 24,45
 DEFINE PAD anula   OF mMenu PROMPT 'a\<Nular '    AT 24,54
 DEFINE PAD lista   OF mMenu PROMPT '\<Listar '    AT 24,63
 DEFINE PAD termi   OF mMenu PROMPT '\<Termina'    AT 24,71

 ON SELECTION PAD revis  OF mMenu DO revis
 ON SELECTION PAD busca  OF mMenu DO busca
 ON SELECTION PAD anter  OF mMenu DO anter
 ON SELECTION PAD proxi  OF mMenu DO proxi
 ON SELECTION PAD corRi  OF mMenu DO corRi
 ON SELECTION PAD ingre  OF mMenu DO ingre
 ON SELECTION PAD anula  OF mMenu DO anula
 ON SELECTION PAD lista  OF mMenu DO lista
 ON SELECTION PAD termi  OF mMenu DO termi
 ON KEY LABEL f4 DO imp_Ri
 ON KEY LABEL F9 DO cor_as
 RETURN

PROCEDURE Pantalla           && Pinta m scara de datos
*-----------------
 ACTIVATE WINDOW Wind_1
 CLEAR
 @  0, 2 SAY "       N£mero R/I :"
 @  0,41 SAY "Fec.R/I :"
 @  0,62 SAY "Per¡odo :"
* @  1, 2 SAY " Dep¢sito Cta.Cte.:"
 @  1,62 SAY "Per.Ref.:"
 @  2, 2 SAY "         Tipo R/I :"
 @  3, 2 SAY "    Tipo Auxiliar :" 
 @  4, 2 SAY "    C¢d. Auxiliar :" 
 @  5, 2 SAY "  Doc. Referencia :"
 @  5,40 SAY " Fecha Doc.Refer. :"
 @  6, 2 SAY " Cadena Funcional :" 
 @  7, 2 SAY "        Fte. Fto. :"
 @  8, 2 SAY "          Funci¢n :"
 @  9, 2 SAY "         Programa :"
 @ 10, 2 SAY "      SubPrograma :"
 @ 11, 2 SAY "  Activ./Proyecto :"
 @ 12, 2 SAY "       Componente :"
 @ 13, 2 SAY " Monto Depositado :"
 @ 14, 0 SAY PADC('° ®F2¯ Observaciones  ®F4¯ImpRime R/I  ®F9¯ Corrige Asientos Patrimoniales °',79,' ') COLOR W+/B
RETURN

PROCEDURE Vista              && Coloca valores de BD en vaRiables y pinta datos
*--------------
 ACTIVATE WINDOW Wind_1
 SELECT Ri
 IF EOF()
    DO standby WITH Vmens08
    RETURN
 ENDIF

 SCATTER MEMVAR
 ON KEY LABEL F3 DO Tra_Hijo
 ON KEY LABEL F9 DO cor_as
 IF !EMPTY(m.codcad)
	IF newsistem='1'
		=val_codcad(ALLTRIM(m.codcad),m.periodo+'01001','C')
	ELSE
		=val_codca1(ALLTRIM(m.codcad),m.periodo,'C')
	ENDIF
 ENDIF
 @  0,22 SAY m.NumRi
 @  0,27 SAY m.numMes
 @  0,50 SAY m.FecRi
 @  0,72 SAY m.Periodo
* @  1,22 SAY m.CodCtc 
 @  1,72 SAY m.PerRef   PICTURE "!!" 
 @  2,22 SAY Val_TipRI(2,25)
* @  2,22 SAY Val_Para(m.TipRi,"TIPRI ","V",22,30)
 @  2,60 SAY IIF(ALLT(m.tipRi) = '50','REFERENCIAL',IIF(m.estado='99','  ANULADO ',IIF(m.EstCon='50',"Contabilizado",'  ATENDIDO '))) COLOR SCHEME 2
 @  3,22 SAY Val_Para(m.TipAux,"AUXIL ","V",22,30)
 @  4,22 say Val_Auxi(m.CodPrv,m.TipAux,'V')
 @  5,22 SAY m.DocRef   PICTURE "@S18"
 @  5,60 SAY m.FecDig
 IF !EMPTY(m.codcad) 
 	@  6,22 SAY m.codcad
	IF newsistem='1'
		@  6,28 SAY val_codcad(ALLTRIM(m.codcad),m.periodo+'01001','D',28,47)
	ELSE
		@  6,28 SAY val_codca1(ALLTRIM(m.codcad),m.periodo,'D',28,47)
	ENDIF
 	
 ELSE
 	@  6,22 CLEAR TO 6,78
 ENDIF
 @  7,22 SAY Val_para(m.CodFte,'CODFTE','V',22) 
 IF !EMPTY(m.codcad)
 	@  8,22 SAY Val_para(maepre.codfun,'CODFUN','V',22,47)
 	@  9,22 SAY Val_para1(maepre.CodPrg,'CODPRG'+maepre.CodFun,'V',22,47)
 	@ 10,22 SAY Val_para1(maepre.CodSPr,'CODSPR'+maepre.CodPrg,'V',22,47)
 	@ 11,22 SAY Val_para(maepre.actpry,'ACTPRY','V',22,47)
 	@ 12,22 SAY Val_para(maepre.codcom,'CODCOM','V',22,47)
 ELSE
  	@  8,22 CLEAR TO 8,78
 	@  9,22 CLEAR TO 9,78 
 	@ 10,22 CLEAR TO 10,78
 	@ 11,22 CLEAR TO 11,78 
 	@ 12,22 CLEAR TO 12,78 
 ENDIF
 @ 13,22 SAY m.CanRi    PICTURE "99,999,999.99"
 DO Vista_Hijo
  IF !vFlag2$'J*'
	DO SubOpc
  ENDIF

 RETURN

PROCEDURE Vista_Hijo
*-------------------
SCATTER MEMVAR
xdesmov=SPACE(6)
xdesmov='MovBco'
SELE CAJA
SEEK ALLT(m.codctc)
IF FOUND() AND caja.clase='T'
   xdesmov='Revers'
ENDIF  
SELECT IteRi
SEEK m.Periodo+ALLTRiM(m.NumMes)+ALLTRiM(m.NumRi)
IF !empty(ALLT(docref))
   IF allt(xdesmov)#'Revers'
	   @ 3,58 SAY 'Mov.Bco Autom tico' COLOR SCHEME 2
	ELSE   
	   @ 3,58 SAY 'Revers. Autom tica' COLOR SCHEME 2
	ENDIF   
ELSE	
	   @ 3,58 SAY 'Pendiente Mov.Bco ' COLOR SCHEME 5
ENDIF
BROWSE ;
   NOCLEAR NOREFRESH NOOPTIMIZE NOEDIT TIMEOUT 0.005;
   WINDOW Wind_2 KEY m.Periodo+ALLTRiM(m.NumMes)+ALLTRiM(m.NumRi);
   FIELDS;
   docref  :H= xdesmov ,;
   BolDep  :H= 'Boleta',;
   FecDep  :H= 'FecDep',;
   ImpParc :H= 'Nombre Part.',;
   CodPart :H= 'C¢d.Par',;
   aa = IIF(!EMPTY(CodPart),ValAsi1(ALIAS(),CodPart,"8","Descri",'R'),' ') :H='Descripci¢n' :40 :W=!EMPTY(CodPart)
   SELECT Ri

*   aa = IIF(!EMPTY(CODPART),VAL_ING(SUBSTR(CodPart,10,3),LEFT(CodPart,9),'Z'),' ') :H='DescRipci¢n' :40 :W=!EMPTY(CodPart)

RETURN

PROCEDURE Revis              && Revisi¢n de BD en browse
*--------------
 SELE Ri
 IF EOF()
    DO standby WITH Vmens08
    RETURN
 ENDIF
 SET RELATION TO PERiODO+NumMes+NumRi INTO IteRi
 SET SKIP TO IteRi
 Vtemp = RECNO()
 HIDE MENU mMenu
 ACTIVATE SCREEN
 vTempo = '°°°°°°°°°°°Presione ®F10¯ para seleccionar  o  ®Esc¯ para cancelar°°°°°°°°°°°°'
 DO Logos WITH Rotulo1,vTempo
 ON KEY LABEL F10 KEYBOARD CHR(23)
 BROWSE WINDOW Wind_0 NOEDIT NOAPPEND NODELETE NOMENU FIELDS ;
 NumRi         :H=' N§ Ri',;
 NumMes        :H='Mes',;
 FecRi         :H='FecRi',;
 CodCtc        :H='CtaCte',;
 IteRi.BolDep  :H='Boleta',;
 IteRi.FecDep  :H='Fec.B/D',;
 IteRi.Impparc :H='Monto B/D',;
 CanRi         :H='Total R/I',;
 DocRef        :H='Referencia'
 vTempo = '°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°'
 DO Logos WITH Rotulo1,vTempo
 IF LASTKEY()=27
   GOTO Vtemp
 ENDIF
 SHOW MENU mMenu
 ON KEY LABEL F10
 SET RELATION OFF INTO Ri
 SELE Ri
 SET RELATION OFF INTO IteRi
 DO Vista
 RETURN

PROCEDURE Busca              && Realiza b£squeda directa
*--------------
Vtemp=RECNO()
IF EOF()
   DO standby WITH Vmens08
   RETURN
ENDIF
vano=space(2)
vano=Right(str(year(date())),2)
ACTIVATE WINDOW standby
 @ 1,01 SAY 'Ingrese N£mero Ri: ' GET vRi PICTURE '@!' DEFAULT SPACE(4)
 @ 1,26 SAY 'Mes:' GET vMes
 @ 1,36 SAY 'A¤O:' GET vano
READ
DEACTIVATE WINDOW standby
 IF EMPTY(vRi) .or. LASTKEY()=27
    RETURN
 ELSE
    vRi = PADL(ALLTRiM(vRi),4,'0')
    SEEK vano+ALLTRiM(vMes)+ALLTRiM(vRi)
    IF !FOUND()
       DO standby WITH Vmens04
       GOTO Vtemp
    ELSE
       DO Vista
    ENDIF
 ENDIF
RETURN

PROCEDURE Anter
*--------------
 IF EOF()
    DO standby WITH Vmens08
    RETURN
 ENDIF
 IF !BOF()
    SKIP -1
 ENDIF
 IF BOF()
    GO TOP
    DO standby WITH Vmens05
 ELSE
    DO Vista
 ENDIF
 RETURN

PROCEDURE Proxi
*--------------
 IF EOF()
    DO standby WITH Vmens08
    RETURN
 ENDIF
 IF !EOF()
   SKIP
 ENDIF
 IF EOF()
   DO standby WITH Vmens06
   GO BOTTOM
 ELSE
   DO Vista
 ENDIF
 RETURN


PROCEDURE Corri
*--------------
ON KEY LABEL F3
ON KEY LABEL F9
mOpc=2
DO CASE
	CASE EOF()
		DO standby WITH Vmens08
		RETURN
	CASE Estado = '99'  && Anulada
		DO STANDBY WITH Vmens09
		RETURN
	CASE EstCon = "50"
		DO STANDBY WITH "El Recibo ya esta Contabilizado"
		RETURN
ENDCASE
STORE .F. TO ingreso
SELECT Ri
vnreg=RECNO()
vorde=ORDER()
SCATTER MEMVAR
ACTIVATE WINDOW Wind_1
DO PANTALLA
IF RLOCK() OR F_LOCK(1)
	@  0,22 SAY m.NumRi
	@  0,27 GET m.NumMes   PICTURE '!!'  VALID Val_Para(m.NUmMes  ,'FECMES',' ',27,9)  DISABLE
	@  0,50 GET m.FecRi    VALID(MONTH(m.fecRi)=VAL(m.nummes)) 
	@  0,72 GET m.Periodo  PICTURE '!!'  VALID valf(m.fecRi)  DISABLE
*	@  1,22 GET m.CodCtc   PICTURE "@!" VALID Val_Fun("Caja","CodCtc","CodCtc+' '+DescRi",m.CodCtc,1,2,22) DISABLE
	@  1,72 GET m.PerRef   PICTURE "!!"
	READ
	IF LASTKEY()=27
		SELECT Ri
		GO vnreg
		SET ORDER TO (vorde)
		DO vista
		RETURN
	ENDIF
	@  2,22 GET m.TipRi    PICTURE "@!"  	VALID Val_TipRI(2,25)	WHEN .F.
	@  2,22 SAY Val_TipRI(2,25)
	@  3,22 GET m.TipAux   PICTURE "!!"  	VALID Val_ParaD(ALLTRIM(m.TipAux),"AUXIL "," ",22,47) 
*	@  4,22 GET m.CodPrv   PICTURE "@!"  	VALID Val_AuxiD(m.CodPrv,m.TipAux,"A",30)
	@  4,22 GET m.CodPrv   PICTURE '!!!!!!' VALID iif(m.tipaux="20",Val_prv1(m.Codprv,'20',' ',22),iif(m.tipaux="30",Val_prv1(m.Codprv,'30',' ',22),IIF(m.tipaux="06",Val_AuxiD(m.CodPrv,m.TipAux,"A",30),Val_prv1(m.Codprv,'09',' ',22))))
	@  5,22 GET m.DocRef   PICTURE "@S18"
	@  5,60 GET m.FecDig
	IF newsistem='1'
		@ 6,22 GET m.CodCad  PICTURE '9999' VALID Val_CodCad(m.codcad,m.periodo+'01001',' ',22,47)
	 ELSE
		@ 6,22 GET m.CodCad  PICTURE '9999' VALID Val_CodCa1(m.codcad,m.periodo,' ',22,47)
	ENDIF
	@  7,22 GET m.codfte   PICTURE '!!'  VALID Val_Para(m.codfte ,'CODFTE',' ',22,47) WHEN .F.
	@  7,22 SAY Val_Para(m.codfte ,'CODFTE',' ',22,47)
	READ VALID Val_Read()
	IF LASTKEY()=27
		SELECT Ri
		GO vnreg
		SET ORDER TO (vorde)
		DO vista
		RETURN
	ENDIF
	@  8,22 SAY Val_para(maepre.codfun,'CODFUN','V',22,47)
	@  9,22 SAY Val_para1(maepre.CodPrg,'CODPRG'+maepre.CodFun,'V',22,47)
	@ 10,22 SAY Val_para1(maepre.CodSPr,'CODSPR'+maepre.CodPrg,'V',22,47)
	@ 11,22 SAY Val_para(maepre.actpry,'ACTPRY','V',22,47)
	@ 12,22 SAY Val_para(maepre.codcom,'CODCOM','V',22,47)
	@ 13,22 GET m.CanRi  PICTURE "99,999,999.99"
	READ VALID Val_Read()
	
	m.usuario = vUser_ID
	SELE CAJA
	SEEK m.CodCtc
	w_TipCtc=Caja.Tipo
	wbanco = Caja.banco
	wclase = Caja.clase
	vdeb   = Caja.CuentaH
	
	SELE AsiAut
	SEEK 'R/I'+m.tipri
*	w_ctaD = dAstPat
*	w_ctaH = hAstPat
*	w_clas = AsiAut.Partida
*	w_asip = IIF(!EMPTY(w_clas),"S","N")
*	w_PreD = ALLTRIM(dAstPre)
*	w_PreH = ALLTRIM(hAstPre)
*	w_OrdD = dAstOrd
*	w_OrdH = hAstOrd
	
	SEEK 'FAC'+m.tipri
	IF FOUND()
	*	w_ctaD = dAstPat
	*	w_ctaH = hAstPat
	*	w_clas = AsiAut.Partida
	*	w_asip = IIF(!EMPTY(w_clas),"S","N")
*		w_PreDF = ALLTRIM(dAstPre)
*		w_PreHF = ALLTRIM(hAstPre)
	*	w_OrdD = dAstOrd
	*	w_OrdH = hAstOrd
	*	w_Obs  = Descri
	ELSE
*		w_PreDF = SPACE(10)
*		w_PreHF = SPACE(10)
	ENDIF
	
	SELE Ri
	IF LASTKEY() # 27
		***************************************************
		* QUEDA PENDIENTE EL REGISTRO DE FACTURAS         *
		* VER VOMO REF. LE PROC. "Concurso" y "Inscribe"  *
		***************************************************
		
		=Observa()
		SELECT Ri
		IF RLOCK()
			GATHER MEMVAR
		ENDIF
		SELECT IteRi
*		DO IngAp

		IF ALLT(wclase)='T'  &&Cta Unica Tesoro P£blico
			DO CASE
				CASE ALLT(m.tipri)='03'
					wtiprev='03'
				CASE ALLT(m.tipri)='12'
					wtiprev='01'
				CASE ALLT(m.tipri)='15'
					wtiprev='02'
				CASE ALLT(m.tipri)='17'
					wtiprev='04'
				CASE ALLT(m.tipri)='29'
					wtiprev='06'
				OTHER
					wtiprev='07'
			ENDCASE
			DO Tra_Hijo
			=Valida()
		 ELSE
			DO Trabaja_Hijo
			=Valida()
		ENDIF
		
		DO Agr_Enl
		
		SELECT IteRi
		DO IngAp

*		IF ALLT(w_asip)='S'
			DO compre
*		ENDIF
		
		***************************************************
		* QUEDA PENDIENTE EL REGISTRO DE FACTURAS         *
		* VER VOMO REF. LE PROC. "Factura"                *
		***************************************************
		*IF ALLT(m.tipri)='02' .OR. ALLT(m.tipri)='73'
		*	DO factura WITH ALLT(m.tipri),'2'
		*ENDIF
		
*		IF !EMPTY(w_OrdD) AND !EMPTY(w_OrdH)
			DO AsiOrd
*		ENDIF
		
		SELE AsiAut
		SEEK "FAC"+PADR(ALLTRIM(m.TipRI),3,' ')
		
		IF FOUND()
*			DFacAPa = DastPat
*			HFacAPa = HAstPat
*			cIgv    = AsiAut.IGV
*			DFacAPr = ALLTRIM(DAstPre)
*			HFacAPr = ALLTRIM(HAstPre)
*			DFacAOr = DAstOrd
*			HFacAOr = HAstOrd
		 ELSE
*			DFacAPa = ""
*			HFacAPa = ""
*			cIgv    = ""
*			DFacAPr = ""
*			HFacAPr = ""
*			DFacAOr = ""
*			HFacAOr = ""
		ENDIF
		
*		IF !EMPTY(DFacAPa) AND !EMPTY(HFacAPa)
			DO AsiFac
*		ENDIF
		
*		IF !EMPTY(DFacAPr) AND !EMPTY(HFacAPr)
			DO ComPreF
*		ENDIF
		
*		IF !EMPTY(DFacAOr) AND !EMPTY(HFacAOr)
			DO AsiOrdFac
*		ENDIF
	 ELSE
		DO STANDBY WITH 'Proceso cancelado'
	ENDIF
 ELSE
	DO STANDBY WITH 'Registro bloqueado'
ENDIF
UNLOCK ALL
ON KEY LABEL F2 DO VisObs
ON KEY LABEL f4 DO imp_Ri
DO Vista                    && Muestra nuevos datos
RETURN

PROCEDURE Agr_Enl
*----------------
PRIVATE cAlias
cAlias = ALIAS()

SELE IteRi
SEEK m.Periodo+m.Nummes+m.NumRI
PUBLIC DECLARE aCadEnl(1,9)
I = 0
SCAN WHILE Periodo+NumMes+NumRI = m.Periodo+m.Nummes+m.NumRI
	IF Iteri.Tipo = 'P'
		SELE IteCla
		IF SEEK(IteRi.CodPart+Iteri.CodCla)
			SCAN WHILE CodPart+CodCla = IteRi.CodPart+Iteri.CodCla
				IF TipDoc = 'R/I'
					I = I + 1
					PUBLIC DECLARE aCadEnl(i,9)
					aCadEnl(i,1) = "R"
					aCadEnl(i,2) = IteCla.CuentaD
					aCadEnl(i,3) = IteCla.CuentaH
					aCadEnl(i,4) = IteCla.DAstPre
					aCadEnl(i,5) = IteCla.HAstPre
					aCadEnl(i,6) = IteCla.DAstOrd
					aCadEnl(i,7) = IteCla.HAstOrd
					aCadEnl(i,8) = IteRI.ImpParc
				ENDIF
			ENDSCAN
		ENDIF
		IF SEEK(IteRi.CodPart)
			SCAN WHILE CodPart = IteRi.CodPart
				IF TipDoc = 'FAC'
					I = I + 1
					DECLARE aCadEnl(i,9)
					aCadEnl(i,1) = "F"
					aCadEnl(i,2) = IteCla.CuentaD
					aCadEnl(i,3) = IteCla.CuentaH
					aCadEnl(i,4) = IteCla.DAstPre
					aCadEnl(i,5) = IteCla.HAstPre
					aCadEnl(i,6) = IteCla.DAstOrd
					aCadEnl(i,7) = IteCla.HAstOrd
					aCadEnl(i,8) = IteRI.ImpParc
					aCadEnl(i,9) = IteCla.IGV
				ENDIF
			ENDSCAN
		ENDIF
	ENDIF
	IF Iteri.Tipo = 'O'
		SELE AsiAut
		IF SEEK("R/I"+m.TipRI)
			I = I + 1
			PUBLIC DECLARE aCadEnl(i,9)
			aCadEnl(i,1) = "R"
			aCadEnl(i,2) = AsiAut.DAstPat
			aCadEnl(i,3) = AsiAut.HAstPat
			aCadEnl(i,4) = ""					&&AsiAut.DAstPre
			aCadEnl(i,5) = ""					&&AsiAut.HAstPre
			aCadEnl(i,6) = ""					&&AsiAut.DAstOrd
			aCadEnl(i,7) = ""					&&AsiAut.HAstOrd
			aCadEnl(i,8) = IteRI.ImpParc
		ENDIF
		
		IF SEEK("FAC"+m.TipRI)
			I = I + 1
			DECLARE aCadEnl(i,9)
			aCadEnl(i,1) = "F"
			aCadEnl(i,2) = AsiAut.DAstPat
			aCadEnl(i,3) = AsiAut.HAstPat
			aCadEnl(i,4) = ""					&&AsiAut.DAstPre
			aCadEnl(i,5) = ""					&&AsiAut.HAstPre
			aCadEnl(i,6) = ""					&&AsiAut.DAstOrd
			aCadEnl(i,7) = ""					&&AsiAut.HAstOrd
			aCadEnl(i,8) = IteRI.ImpParc
		ENDIF
	ENDIF
ENDSCAN

RETURN

*PROCEDURE Agr_Enl
*----------------
PRIVATE cAlias
cAlias = ALIAS()

SELE IteRi
SEEK m.Periodo+m.Nummes+m.NumRI
PUBLIC DECLARE aCadEnl(1,9)
I = 0
SCAN WHILE Periodo+NumMes+NumRI = m.Periodo+m.Nummes+m.NumRI
	IF Iteri.Tipo = 'P'
		SELE IteCla
		IF SEEK(IteRi.CodPart+Iteri.CodCla)
			SCAN WHILE CodPart+CodCla = IteRi.CodPart+Iteri.CodCla
				IF TipDoc = 'R/I'
					I = I + 1
					PUBLIC DECLARE aCadEnl(i,9)
					aCadEnl(i,1) = "R"
					aCadEnl(i,2) = IteCla.CuentaD
					aCadEnl(i,3) = IteCla.CuentaH
					aCadEnl(i,4) = IteCla.DAstPre
					aCadEnl(i,5) = IteCla.HAstPre
					aCadEnl(i,6) = IteCla.DAstOrd
					aCadEnl(i,7) = IteCla.HAstOrd
					aCadEnl(i,8) = IteRI.ImpParc
				ENDIF
				IF TipDoc = 'FAC'
					I = I + 1
					DECLARE aCadEnl(i,9)
					aCadEnl(i,1) = "F"
					aCadEnl(i,2) = IteCla.CuentaD
					aCadEnl(i,3) = IteCla.CuentaH
					aCadEnl(i,4) = IteCla.DAstPre
					aCadEnl(i,5) = IteCla.HAstPre
					aCadEnl(i,6) = IteCla.DAstOrd
					aCadEnl(i,7) = IteCla.HAstOrd
					aCadEnl(i,8) = IteRI.ImpParc
					aCadEnl(i,9) = IteCla.IGV
				ENDIF
			ENDSCAN
		ENDIF
	ENDIF
	IF Iteri.Tipo = 'O'
		SELE AsiAut
		IF SEEK("R/I"+m.TipRI)
			I = I + 1
			PUBLIC DECLARE aCadEnl(i,9)
			aCadEnl(i,1) = "R"
			aCadEnl(i,2) = AsiAut.DAstPat
			aCadEnl(i,3) = AsiAut.HAstPat
			aCadEnl(i,4) = 0					&&AsiAut.DAstPre
			aCadEnl(i,5) = 0					&&AsiAut.HAstPre
			aCadEnl(i,6) = 0					&&AsiAut.DAstOrd
			aCadEnl(i,7) = 0					&&AsiAut.HAstOrd
			aCadEnl(i,8) = IteRI.ImpParc
		ENDIF
		
		IF SEEK("FAC"+m.TipRI)
			I = I + 1
			DECLARE aCadEnl(i,9)
			aCadEnl(i,1) = "F"
			aCadEnl(i,2) = AsiAut.DAstPat
			aCadEnl(i,3) = AsiAut.HAstPat
			aCadEnl(i,4) = 0					&&AsiAut.DAstPre
			aCadEnl(i,5) = 0					&&AsiAut.HAstPre
			aCadEnl(i,6) = 0					&&AsiAut.DAstOrd
			aCadEnl(i,7) = 0					&&AsiAut.HAstOrd
			aCadEnl(i,8) = IteRI.ImpParc
		ENDIF
	ENDIF
ENDSCAN

RETURN

PROCEDURE Ingre              && Crea nuevo registro en BD
*--------------
ON KEY LABEL F3
ON KEY LABEL F9

AstOrdF = .F.
mOpc=1
SELECT Ri
vnreg=RECNO()
vorde=ORDER()
DO Pantalla
SCATTER MEMVAR BLANK
SELECT Parma
SEEK 'CORRELRECING'
m.NumRi = PADL(NumEnt+1,4,'0')
m.CodCad = '0003'
STORE DATE() TO m.FecRi, m.FecDep, m.fecdig
m.Estado= '00'
STORE .T. TO ingreso
@  0,22 GET m.NumRi    PICTURE '!!!!'	&&WHEN .F.
@  0,26 SAY '.'
@  0,27 GET m.NumMes   PICTURE '!!'   VALID Val_Para(m.NUmMes  ,'FECMES',' ',27,9) .AND. IGUAL()
@  0,50 GET m.FecRi    VALID(MONTH(m.fecRi)=VAL(m.nummes)) AND VALF(m.fecri)
@  0,72 GET m.Periodo  PICTURE '!!'	VALID m.Periodo = RIGHT(STR(YEAR(m.FecRI),4),2)
*@  1,22 GET m.CodCtc   PICTURE "@!"   VALID Val_Fun("Caja","CodCTc","CodCtc+' '+DescRi",m.CodCtc,1,1,22,"CodCtc+' '+DescRi",38)
@  1,72 GET m.PerRef   PICTURE "!!"
READ

IF LASTKEY()=27
	SELECT Ri
	GO vnreg
	SET ORDER TO (vorde)
	DO vista
	RETURN
ENDIF

@  2,22 GET m.TipRi    PICTURE "@!"  VALID Val_TipRI(2,25)
@  3,22 GET m.TipAux   PICTURE "!!"  VALID Val_ParaD(m.TipAux,"AUXIL "," ",22,47)
*@  4,22 GET m.CodPrv   PICTURE "@!"  VALID Val_AuxiD(m.CodPrv,m.TipAux,"A",30)
@  4,22 GET m.CodPrv   PICTURE '!!!!!!'   VALID iif(m.tipaux="20",Val_prv1(m.Codprv,'20',' ',22),iif(m.tipaux="30",Val_prv1(m.Codprv,'30',' ',22),IIF(m.tipaux="06",Val_AuxiD(m.CodPrv,m.TipAux,"A",30),Val_prv1(m.Codprv,'09',' ',22))))
@  5,22 GET m.DocRef   PICTURE "@S18"
@  5,60 GET m.FecDig

IF newsistem='1'
	@ 6,22 GET m.CodCad    PICTURE '9999' VALID Val_CodCad(m.codcad,m.periodo+'01001',' ',22,47)	WHEN .F.
 ELSE
	@ 6,22 GET m.CodCad    PICTURE '9999' VALID Val_CodCa1(m.codcad,m.periodo,' ',22,47)			WHEN .F.
ENDIF

@  7,22 GET m.codfte   PICTURE '!!!'  VALID Val_Para(m.codfte ,'CODFTE',' ',22,47)
READ VALID Val_Read()
IF LASTKEY()=27
	SELECT Ri
	GO vnreg
	SET ORDER TO (vorde)
	DO vista
	RETURN
ENDIF
@  8,22 SAY Val_para(maepre.codfun,'CODFUN','V',22,47)
@  9,22 SAY Val_para1(maepre.CodPrg,'CODPRG'+maepre.CodFun,'V',22,47)
@ 10,22 SAY Val_para1(maepre.CodSPr,'CODSPR'+maepre.CodPrg,'V',22,47)
@ 11,22 SAY Val_para(maepre.actpry,'ACTPRY','V',22,47)
@ 12,22 SAY Val_para(maepre.codcom,'CODCOM','V',22,47)
@ 13,22 GET m.CanRi  PICTURE "99,999,999.99"
READ VALID Val_Read()

m.usuario = vUser_ID
SELE Caja
SEEK ALLTRiM(m.CodCtc)
IF FOUND()
	w_TipCtc=Caja.tipo
	wbanco = Caja.banco
	wclase = Caja.Clase
	vdeb   = Caja.CuentaH
ENDIF

SELE AsiAut
SEEK 'R/I'+m.tipri
*w_ctaD = dAstPat
*w_ctaH = hAstPat
*w_clas = AsiAut.Partida
*w_asip = IIF(!EMPTY(w_clas),"S","N")
*w_PreD = ALLTRIM(dAstPre)
*w_PreH = ALLTRIM(hAstPre)
*w_OrdD = dAstOrd
*w_OrdH = hAstOrd
w_Obs  = Descri

SEEK 'FAC'+m.tipri
IF FOUND()
*	w_ctaD = dAstPat
*	w_ctaH = hAstPat
*	w_clas = AsiAut.Partida
*	w_asip = IIF(!EMPTY(w_clas),"S","N")
*	w_PreDF = ALLTRIM(dAstPre)
*	w_PreHF = ALLTRIM(hAstPre)
*	w_OrdD = dAstOrd
*	w_OrdH = hAstOrd
*	w_Obs  = Descri
ELSE
ENDIF

SELE Ri

IF LASTKEY()#27
	vAnula = .F.
	SELECT Ri
	IF F_Appd()
		GATHER MEMVAR
		UNLOCK ALL
		SELECT Parma
		SEEK 'CORREL'+'RECING'
		REPLACE NumEnt WITH NumEnt + 1
		SELECT Ri
		IF ALLTRIM(wclase)='T'
			SELECT Parma
			SEEK "CORREL"+"REVERS"
			vNUMERO=PADL(NUMENT+1,4,'0')
			DO Agreg1
		 ELSE
			SELECT Parma
			SEEK "CORREL"+"MOVBCO"
			vNUMERO=PADL(NUMENT+1,4,'0')
			
			DO Agreg_item
		ENDIF
		
		***************************************************
		* QUEDA PENDIENTE EL REGISTRO DE FACTURAS         *
		* VER VOMO REF. LE PROC. "Concurso" y "Inscribe"  *
		***************************************************
		
		= Observa()
		
		SCATTER MEMVAR
		DO WHILE .T.
			SELECT IteRi
*			DO IngAp
			IF ALLT(wclase)='T'  &&Cta Unica Tesoro P£blico
				DO CASE
					CASE ALLT(m.tipri)='03'
						wtiprev='03'
					CASE ALLT(m.tipri)='12'
						wtiprev='01'
					CASE ALLT(m.tipri)='15'
						wtiprev='02'
					CASE ALLT(m.tipri)='17'
						wtiprev='04'
					CASE ALLT(m.tipri)='29'
						wtiprev='06'
					OTHER
						wtiprev='07'
				ENDCASE
				DO Tra_hijo
			 ELSE
				DO Trabaja_Hijo
			ENDIF
			
			DO Agr_Enl
			
			SELECT IteRi
			DO IngAp

*			IF ALLT(w_asip)='S'
				DO compre
*			ENDIF
			
			***************************************************
			* QUEDA PENDIENTE EL REGISTRO DE FACTURAS         *
			* VER VOMO REF. LE PROC. "Factura"                *
			***************************************************
			*IF ALLT(m.tipri)='02' .OR. ALLT(m.tipri)='73'   &&Venta de Bases/Inscripciones eventos
			*	DO factura WITH ALLT(m.tipri),'1'
			*ENDIF
			
*			IF !EMPTY(ALLTRIM(w_OrdD)) AND !EMPTY(ALLTRIM(w_OrdH))
				DO AsiOrd
*			ENDIF
			
			SELE AsiAut
			SEEK "FAC"+PADR(ALLTRIM(m.TipRI),3,' ')
			
			IF FOUND()
				DFacAPa = DastPat
				HFacAPa = HAstPat
				cIgv    = AsiAut.IGV
				DFacAPr = DAstPre
				HFacAPr = HAstPre
				DFacAOr = DAstOrd
				HFacAOr = HAstOrd
			 ELSE
				DFacAPa = ""
				HFacAPa = ""
				cIgv    = ""
				DFacAPr = ""
				HFacAPr = ""
				DFacAOr = ""
				HFacAOr = ""
			ENDIF
			
*			IF !EMPTY(DFacAPa) AND !EMPTY(HFacAPa)
				DO AsiFac
*			ENDIF
			
*			IF !EMPTY(DFacAPr) AND !EMPTY(HFacAPr)
				DO ComPreF
*			ENDIF
			
*			IF !EMPTY(DFacAOr) AND !EMPTY(HFacAOr)
				DO AsiOrdFac
*			ENDIF
			
			IF LASTKEY() = 27
				IF YESNO( '¨ Cancela el Ingreso ?' )
					vAnula = .T.
					EXIT
				ENDIF
			 ELSE
				IF YESNO( '¨ Est n correctos los datos ?')
					EXIT
					=Valida()
				ENDIF
			ENDIF
		ENDDO
		IF vAnula
			DO Anula
		ENDIF
	 ELSE
		GO BOTTOM
	ENDIF
 ELSE
	DO STANDBY WITH 'Proceso cancelado'
ENDIF
UNLOCK ALL
SELECT Ri
*GO BOTT
ON KEY LABEL F2 DO VisObs
ON KEY LABEL f4 DO imp_Ri
DO Vista
RETURN

FUNCTION ValF
*-----------------
PARAMETERS xfec
m.Periodo=RiGHT(STR(YEAR(xfec)),2)
m.PerRef=m.Periodo
RETURN 


PROCEDURE Trabaja_Hijo
*---------------------
ACTIVATE SCREEN
HIDE MENU mMenu
vTempo = '°°°°°°°°F5->Agregar°°°°°°°°°°°°°°F8->Eliminar°°°°°°°°°°°°°°F10->Terminar°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
ON KEY LABEL F5  DO Agreg_item
ON KEY LABEL F8  DO Elimi_item
ON KEY LABEL F10 KEYBOARD CHR(23)
SELE IteRi
SEEK ALLTRiM(m.Periodo)+ALLTRiM(m.NumMes)+ALLTRiM(m.NumRi)
IF !FOUND()
	DO Agreg_Item
ENDIF

*	CodPart    :H= 'Partida':V=V_Part(CodPart) AND Val_Niv() :F:W=Tipo='P'

BROWSE NOAPPEND NODELETE NOMENU NOREFRESH NOOPTIMIZE WINDOW Wind_2;
	KEY m.Periodo+ALLTRiM(m.NumMes) + ALLTRiM(m.NumRi) FIELD ;
	Tipo       :H= 'T':P='@M O,P',;
	CodPart    :H= 'Partida':V=V_Part(CodPart) :F:W=Tipo='P',;
	CODCLA     : H= 'Cla.':V=Val_cla(codpart,CODPART+codcla,'codcla'):F :F:W=Tipo='P' AND !empty(CodPart),;
    aa = IIF(!EMPTY(CodPart),ValAsi1(ALIAS(),CodPart,'8','Descri','R'),' ') :H='Descripci¢n' :40 :W=!EMPTY(CodPart),;
	BolDep     :H= 'N§ Bol./Dep.': P='@!',;
	FecDep     :H= 'FechaDep',;
	Glosa      :H= 'Ingreso en': P='@!',;
	ImpParc    :H='Monto' : P='999,999,999,999.99',;
	DocRef     :H='B/D' :R :F

*	aa = IIF(!EMPTY(CODPART),ValAsi1(ALIAS(),CodPart,'6','Descri','R'),' ') :H='DescRipci¢n' :40 :W=!EMPTY(CodPart),;
*BROWSE NOAPPEND NODELETE NOMENU NOREFRESH NOOPTIMIZE WINDOW Wind_2;
*	KEY m.Periodo+ALLTRiM(m.NumMes) + ALLTRiM(m.NumRi) FIELD ;
*	Tipo       :H= 'T':P='@M O,P',;
*	CodPart    :H= 'Partida':V=VAL_ING2(SUBSTR(CodPart,10,3),LEFT(CodPart,9),'codpart'):F:W=Tipo='P',;
*	aa = IIF(!EMPTY(CODPART),VAL_ING(SUBSTR(CodPart,10,3),LEFT(CodPart,9),'Z'),' ') :H='DescRipci¢n' :40 :W=!EMPTY(CodPart),;
*	BolDep     :H= 'N§ Bol./Dep.': P='@!',;
*	FecDep     :H= 'FechaDep',;
*	Glosa      :H= 'Ingreso en': P='@!',;
*	ImpParc    :H='Monto' : P='999,999,999,999.99',;
*	DocRef     :H='B/D' :R :F

* aqui me quedo
	
SELECT IteRi
ON KEY LABEL F10
ON KEY LABEL F8
ON KEY LABEL F5
UNLOCK ALL
SELECT Ri
ACTIVATE SCREEN
vTempo = '°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
SHOW MENU mMenu
RETURN


FUNCTION ValPrIng
*----------------
PARAMETERS mValor, mVariable, TipRet
*PARAMETERS vAli, mValor, Nivel, mVariable, TipRet
PRIVATE cAlias,cOrd,vIdx,mRet

cAlias = ALIAS()
vIdx = SYS(3) + '.Idx'
mret = .T.

SELECT ItePari

*set step on
SEEK m.Periodo+'01001'+m.CodCad+m.CodFte+mValor

IF !FOUND() OR EMPTY(mValor)

    _OldWnd = WOUTPUT()
    ACTIVATE SCREEN
    
    GO TOP
    
    ON KEY LABEL f10 KEYBOARD CHR(23)
    DEFINE WINDOW wind_CAD FROM 04,07 TO 17,70  DOUBLE ;
		TITLE  ' ± CLASE ± ' FOOTER ' ° ®F10¯ Graba ° ' COLOR SCHEME 15
	ACTIVATE WINDOWS wind_cad
	BROWSE ;
		NOAPPEND NOEDIT NODELETE NOMENU NOCLEAR NOOPTIMIZE NOREFRESH ;
		WINDOW wind_cad  FIELD ;
		CODPart	:H='Partida',;
		aa = ValAsi1(ALIAS(),CodPart,"8","Descri",'R') :H='Descripci¢n'
		
    RELEASE WINDOWS wind_cad
    
*    IF !EMPTY( _OldWnd)
*       ACTIVATE WINDOW &_OldWnd
*    ENDIF
    
    RELEASE POPUP parametro
    SET FILTER TO
ENDIF

mRet = &mvariable

IF !EMPTY(cAlias)
	SELECT (cAlias)
ENDIF

DO CASE
    CASE TipRet=='C'   && Campo
      REPLACE &mVariable WITH mRet
*      RETURN .T.
*    CASE TipRet=='R'   && Retorna valor
*      RETURN mRet
ENDCASE

RETURN 


FUNCTION v_part
*--------------
PARAMETERS vPar
lValida = .F.
IF !EMPTY(vPar)
	IF SEEK(vPar,"CatAsi") AND CatAsi.Detalle = 'S'
		REPLACE Iteri.concep  WITH CatAsi.Descri
	ELSE
		lValida = .T.
	ENDIF
ELSE
	lValida = .T.
ENDIF	

IF lValida
	vPar = SPACE(14)
	= ValPrIng(CodPart,"CodPart",'C')
	vPar = IteParI.CodPart
	SELE CatAsi
	IF SEEK(vPar)
		REPLACE Iteri.concep  WITH CatAsi.Descri
	ELSE
		REPLACE Iteri.concep  WITH 'Error En Partida'
	ENDIF
ENDIF

RETURN .T.

FUNCTION Des_Par
*---------------
PARAMETERS vPar
PRIVATE cAlias
cAlias = ALIAS()
IF !EMPTY(vPar)
	IF SEEK(vPar,"CatAsi")
		mRet = CatAsi.Descri
	 ELSE
	 	mRet = "Error en Descripci¢n"
	ENDIF
 ELSE
	mRet = SPACE(15)
ENDIF

*wait wind mRet

RETURN mRet

PROCEDURE Anula
*--------------
ON KEY LABEL F3
ON KEY LABEL F9

 SELECT Ri
 IF EOF()
    DO standby WITH Vmens08
    RETURN
 ENDIF
 IF Estado = '99' && ya pas¢
    DO STANDBY WITH Vmens09
    RETURN
 ENDIF
 velimina = YESNO('¨ Desea ANULAR este R/I ?')
 IF vElimina .AND. ( RLOCK() .OR. F_Lock(1) )
   REPLACE ESTADO WITH '99'
   REPLACE usuario WITH vUser_ID
 ELSE
   *DO Vista
   RETURN
 ENDIF
 UNLOCK
 
 SELE AstPat
 SEEK m.Periodo+ALLTRiM(m.nummes)+m.numRi+ALLTRIM(m.CodCtc)
 IF FOUND()
   	SCAN WHILE Periodo=m.Periodo AND nummes=ALLTRIM(m.nummes) AND numref=m.numRi AND codctc=m.CodCtc AND tipdoc="R/I" 
	    IF RLOCK() .OR. F_LOCK(1)
    		   DELETE NEXT 1
		ENDIF       
	    UNLOCK
    ENDSCAN
 ENDIF	    
    USE astpre   IN 9  ORDER TAG astpre20      ALIAS astpre  
    SELE AstPre
    SEEK m.Periodo+ALLTRiM(m.nummes)+m.numRi+ALLTRIM(m.CodCtc)
    IF FOUND()
    	SCAN WHILE Periodo=m.Periodo AND nummes=ALLTRIM(m.nummes) AND numref=m.numRi AND codctc=m.CodCtc AND tipdoc="R/I" 
		    IF RLOCK() .OR. F_LOCK(1)
		       DELETE NEXT 1
		    ENDIF       
		    UNLOCK
	    ENDSCAN
    ENDIF
	
	SELE Iteri
	SEEK m.Periodo+ALLTRiM(m.nummes)+m.numRi
    IF FOUND()
    	SCAN WHILE Periodo=m.Periodo AND nummes=ALLTRIM(m.nummes) AND numri=m.numRi
		    IF RLOCK() .OR. F_LOCK(1)
		       REPLACE ESTADO WITH '99'
		    ENDIF
		    SELE MovBco
		    SEEK ALLT(IteRi.nummes)+ALLTRIM(IteRi.docRef)
		    IF RLOCK() .OR. F_LOCK(1)
		       REPLACE MovBco.monto WITH 0
		       REPLACE ESTADO WITH '99'
		    ENDIF       
		    UNLOCK
		    SELE Iteri
	    ENDSCAN
    ENDIF
	

    SELE Ri
   DO Vista
 RETURN

PROCEDURE Agreg_Item
*-------------------
SELECT Parma
SEEK "CORREL"+"MOVBCO"
vNUMERO=PADL(NUMENT+1,4,'0')
SELECT IteRi
IF mOpc=1
	IF F_Appd()
	   REPLACE Periodo WITH m.Periodo,;
   		   NumRi   WITH m.NumRi ,;
   		   NumMes  WITH m.NumMes,;
   		   ImpParc WITH 0,;
   		   Estado  WITH m.Estado,;
   		   Fecdep  WITH m.fecRi,;
   		   docref  WITH vnumero,;
   		   tipo    WITH "P"				&&IIF(EMPTY(w_clas),'O','P'),;
   		   codpart WITH w_clas,;
   		   impparc WITH m.canri
*	   SELECT Parma
*	   SEEK "CORREL"+"MOVBCO"
*	   REPLACE NUMENT WITH NUMENT+1
	   SELE ITERI
	ENDIF
	mOpc=2
 ELSE
	IF F_Appd()
	   REPLACE Periodo WITH m.Periodo,;
   		   NumRi   WITH m.NumRi ,;
   		   NumMes  WITH m.NumMes,;
   		   ImpParc WITH 0,;
   		   Estado  WITH m.Estado,;
   		   Fecdep  WITH m.fecRi,;
   		   docref  WITH vnumero,;
   		   tipo    WITH IIF(EMPTY(w_clas),'O','P')
	   SELECT Parma
*	   SEEK "CORREL"+"MOVBCO"
*	   REPLACE NUMENT WITH NUMENT+1
*	   SELE ITERI
	ENDIF
ENDIF

RETURN



PROCEDURE Elimi_Item
*-------------------
SELECT IteRi
if rlock()
   SELECT IteRi
   DELETE NEXT 1
else
   do standby with 'No puede eliminar este Item.'
endif

return


PROCEDURE Lista  &&Reportes varios
*--------------
vAli=ALIAS()
vOrd=ORDER()
IF EOF()
   DO standby WITH Vmens08
   RETURN
ENDIF
IF LASTKEY()=27
   RETURN
ENDIF
vTemp=RECNO()
PRIVATE Vfte
DEFINE WINDOW Lis FROM 4,15 TO 24,65 FLOAT DOUBLE TITLE 'Listado Recibo de Ingresos' COLOR SCHEME 5
ACTIVATE WINDOW LIS
STORE 1         TO vToCli,Vorden,vTipPro,vToCta,vLista
STORE SPACE(4)  TO vCli
STORE SPACE(2)  TO vMes,vMesT,vtipaux,VPER,vFte
STORE SPACE(3)  TO VTIPRI
STORE SPACE(10) to vauxiliar
STORE SPACE(14) TO vcta
vMesT='0'+ALLTRiM(STR(MONTH(DATE())))
vMest = PADL(ALLTRiM(vMest),2,'0')
STORE DATE() to vfecini,vfecfin
Vper=m.Periodo
Vcli=m.numri
Vmes=m.nummes
@ 01,01 SAY "     Tipo Listado : " GET vlista  FUNCTION '^ Documento;CtaCte;FteFto;Fecha de Emisi¢n;Concepto;Auxiliar'
@ 05,01 SAY "           N§ R/I : "
@ 05,22 GET vCli    WHEN Vlista=1  PICTURE '!!!!'
@ 05,27 GET vMesT   WHEN Vlista=1  PICTURE '!!'  
@ 05,30 GET Vper    WHEN Vlista=1  PICTURE '!!'   VALID ValRes()
*@ 06,01 SAY "   Cta. Corriente : "
*@ 06,22 GET vcta  VALID val_fun('Caja', 'CodCtc', "CodCtC+' '+DescRi",vcta,1,8,12) AND vctc() WHEN  vlista=2  OR VLISTA=5
@ 07,01 SAY "      Fte. Financ.: " GET vfte  VALID Val_Para(Vfte,"CODFTE"," ",22,30) WHEN Vlista=3 
@ 09,01 SAY "         Concepto : " GET vTipRi  VALID Val_ParaD(VTipRI, 'TIPRI ', ' ',22) WHEN Vlista=5 
@ 10,01 SAY "     Tipo Auxiliar: " GET vTipAux VALID Val_ParaD(vtipaux,"AUXIL "," ",22,30) WHEN Vlista=6
@ 11,01 SAY "   C¢digo Auxiliar: " GET vAuxiliar VALID Val_AuxiD(Vauxiliar,VTIPAUX," ",30) WHEN Vlista=6
@ 13,01 SAY "           Estado : " GET vTipPro  FUNCTION '^ Registrados;Anulados' WHEN vlista=2
@ 15,01 SAY " Fecha de Emisi¢n : "
@ 16,22 GET vfecini  PICTURE '@D' COLOR SCHEME 7   WHEN vlista<>1 
@ 16,34 GET vfecfin  PICTURE '@D' VALID (vfecfin >= vfecini) COLOR SCHEME 7 WHEN vlista<>1 
@ 18,10 GET OKCANCEL FUNCTION '*TH \!\<OK;\?\<Cancela' DEFAULT 1 SIZE 1,11,8
READ CYCLE
RELEASE WINDOW LIS
IF OKCANCEL = 1
   ACTIVATE WINDOW STANDBY
   @ 01,04 SAY 'Espere un momento........'
   SELECT Ri
   SET MEMOWIDTH TO 50
   vInd = SYS(3) + '.IDX'
   DEACTIVATE WINDOW STANDBY
      DO CASE
	   CASE vLista = 1
		    Vkey=PERiODO+ALLTRiM(VMES)+VCLI
    		SELE Ri
    		SEEK Vkey
    		DO repPRG WITH "LISRi"," Listado Recibo de Ingreso ",2
    		
       CASE vLista=2
		      vTitulo=IIF(vTipPro=1,'Registrados ',' Anulados ')
	          DO CASE
	           CASE Vtippro=1
		     	   SELECT DISTINCT I.*, R.TIPRi, R.CODCTC  ;
		     	   FROM IteRi I, RECING R;
		     	   WHERE !EMPTY(R.PERiODO+R.NumMes+R.NumRi) AND ;
		     	    (R.PERiODO+R.NumMes+R.NumRi=I.PERiODO+I.NumMes+I.NumRi) ;
		     	   	AND (R.codctc=vcta AND BETWEEN(R.fecRi,vfecini,vfecfin);
		     	   	AND R.ESTADO#"99");
		     	   ORDER BY I.numRi ;
		     	   INTO CURSOR ITRi
		     	   SELECT ITRi
		     	   VIND = SYS(3)+'.IDX'
		     	   INDEX ON PERiODO+NumMes+NumRi TO (VIND)
				   SELECT Ri
		     	   SET FILTER TO codctc=vcta AND BETWEEN(fecRi,vfecini,vfecfin) AND ESTADO#"99"
				   SELECT ItRi
	  		       SET RELATION TO PERiODO+NumMes+NumRi INTO Ri
				   SELECT ITRi
		     	   IF EOF()
		     	      DO STANDBY WITH "Registros no existen"
		     	      SELE  Ri
		     	      SET FILT TO
		     	      GO BOTT
		     	      RETURN
		     	   ENDIF   
               CASE Vtippro=2
		     	   SELECT DISTINCT I.*, R.TIPRi, R.CODCTC  ;
		     	   FROM IteRi I, RECING R;
		     	   WHERE !EMPTY(R.PERiODO+R.NumMes+R.NumRi) AND ;
		     	    (R.PERiODO+R.NumMes+R.NumRi=I.PERiODO+I.NumMes+I.NumRi) ;
		     	   	AND (R.codctc=vcta AND BETWEEN(R.fecRi,vfecini,vfecfin);
		     	   	AND R.ESTADO="99");
		     	   ORDER BY I.numRi ;
		     	   INTO CURSOR ITRi
		     	   SELECT ITRi
		     	   VIND = SYS(3)+'.IDX'
		     	   INDEX ON PERiODO+NumMes+NumRi TO (VIND)
				   SELECT Ri
		     	   SET FILTER TO codctc=vcta AND BETWEEN(fecRi,vfecini,vfecfin) AND ESTADO="99"
				   SELECT ItRi
	  		       SET RELATION TO PERiODO+NumMes+NumRi INTO Ri
				   SELECT ITRi
		     	   IF EOF()
		     	      DO STANDBY WITH "Registros no existen"
		     	      SELE Ri
		     	      SET FILT TO
		     	      GO BOTT
		     	      RETURN
		     	   ENDIF   
		     ENDCASE	   
             DO REPORTE WITH 2,"LisRiCt",' Reporte de R/I por Cuentas CorRientes ',1,.F.,.T.
             vflag1=0
             SELE ri
             set filter to
         CASE vLista=3
       	      SELE ri
              SET FILT TO  ri.codfte=ALLT(vfte) AND BETWEEN(Ri.fecRi,vfecini,vfecfin) AND Ri.ESTADO#'99' 
     	      SET RELATION TO Periodo+NumMes+NumRi INTO IteRi
              GO TOP
		      IF EOF()
		     	      DO STANDBY WITH "Registros no existen"
		     	      SET FILT TO
		     	      SET ORDER TO RECING1
		     	      SELE Ri
		     	      GO BOTT
		     	      RETURN
	     	   ENDIF   
              DO REPORTE WITH 2,"LisRiFte",' Reporte de R/I por Fuente de Financiamiento ',1,.F.,.T.
              SET FILT TO
              SET RELATION TO
         CASE vLista=4
		     	   SELECT DISTINCT I.*, R.TIPRi, R.CODCTC  ;
		     	   FROM IteRi I, RECING R;
		     	   WHERE !EMPTY(R.PERiODO+R.NumMes+R.NumRi) AND ;
		     	    (R.PERiODO+R.NumMes+R.NumRi=I.PERiODO+I.NumMes+I.NumRi) ;
		     	   	AND BETWEEN(R.fecRi,vfecini,vfecfin);
		     	   ORDER BY I.numRi ;
		     	   INTO CURSOR ITRi
		     	   SELECT ITRi
		     	   VIND = SYS(3)+'.IDX'
		     	   INDEX ON PERiODO+NumMes+NumRi TO (VIND)
				   SELECT Ri
		     	   SET FILTER TO BETWEEN(fecRi,vfecini,vfecfin) 
				   SELECT ItRi
	  		       SET RELATION TO PERiODO+NumMes+NumRi INTO Ri
				   SELECT ITRi
		     	   IF EOF()
		     	      DO STANDBY WITH "Registros no existen"
		     	      SELE Ri
		     	      SET FILT TO
		     	      GO BOTT
		     	      RETURN
		     	   ENDIF   
	              DO REPORTE WITH 2,"LisRifec",' Reporte de R/I por Fecha ',1,.F.,.T.
         CASE vLista=5
          	   VIND = SYS(3)+'.IDX'
              INDEX ON Ri.TipRi TO (vInd)  FOR  Ri.TIPRi = ALLTRiM(VTIPRi) AND BETWEEN(Ri.fecRi,vfecini,vfecfin) AND Ri.ESTADO<>'99' 
              *AND Ri.CODCTC=ALLTRiM(VCTA)
		     	   IF EOF()
		     	      DO STANDBY WITH "Registros no existen"
		     	      SET INDEX TO
		     	      SET ORDER TO RECING1
		     	      SELE Ri
		     	      GO BOTT
		     	      RETURN
		     	   ENDIF   
              DO REPORTE WITH 2,"LisRiCON",' Reporte por Tipo de Recibo de Ingreso ',1,.F.,.T.
              SELE ri
              set filter to
         CASE vLista=6
	     	   VIND = SYS(3)+'.IDX'
              INDEX ON Ri.Tipaux+Ri.codprv TO (vInd) FOR BETWEEN(Ri.fecRi,vfecini,vfecfin) AND Ri.ESTADO#'99' .AND. Ri.TIPAUX = ALLTRiM(VTIPAUX) AND Ri.CODPRV = ALLTRiM(VAUXILIAR) 
         	   IF EOF()
		     	      DO STANDBY WITH "Registros no existen"
		     	      SET INDEX TO
		     	      SET ORDER TO RECING1
		     	      SELE Ri
		     	      GO BOTT
		     	      RETURN
 	     	   ENDIF   
               DO REPORTE WITH 2,"LisRiAux",' Reporte por Tipo de AUXILIAR ',1,.F.,.T.
               SET INDEX TO
      ENDCASE
      sele Ri
      SET MEMOWIDTH TO 50
ENDIF
IF vTemp>0
   GO vTemp
ENDIF
DO vista
RETURN


PROCEDURE ValRes
*--------------
 SELECT Ri
 vTemp=recno()
 IF EOF()
    DO standby WITH Vmens08
    RETURN
 ENDIF
 SEEK Vper+vMes+vCli
 IF !FOUND()
    SET ORDER TO RecIng1
    HIDE MENU mMenu
    ACTIVATE SCREEN
    vTempo = '°°°°°°°°°°°Presione ®F10¯ para seleccionar  o  ®Esc¯ para cancelar°°°°°°°°°°°°'
    DO Logos WITH Rotulo1,vTempo    
    ON KEY LABEL F10 KEYBOARD CHR(23)    
    BROWSE WINDOW Wind_0 NOEDIT NOAPPEND NODELETE NOMENU FIELDS ;
    PERiODO,;
    NumMes :H='Mes',;
    NumRi  :H=' N§ Ri' ,;
    FecRi  :H='Fecha' ,;
    CanRi  :H='Total R/I',;
    Observ :H='Observaci¢n',;
    CodCtc :H='CtaCte'

    vTempo = '°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°'
    DO Logos WITH Rotulo1,vTempo
    IF LASTKEY()=27
       GO Vtemp
    ENDIF

    SHOW MENU mMenu
    ON KEY LABEL F10
    SET RELATION TO
    GO Vtemp
 ENDIF
 vMes=NumMes
 vCli=NumRi
 RETURN .t.


PROCEDURE LisRi                  &&Programa Reporte usa repprg
*--------------
PARAMETERS xcop
PRIVATE fila,vdebpre,vhabpre,vfte
DO CASE
	CASE _Dest1=1
		SET DEVICE TO FILE (P_FIL)
	CASE _Dest1=2
		SET DEVICE TO PRINTER
	CASE _Dest1=3
		SET DEVICE TO FILE (P_FIL)
ENDCASE	
STORE 0 TO xval,tval
vdebpre=SPACE(12)
habpre=SPACE(12)
SELE Ri
SET MEMOWIDTH TO 50
Vper=Ri.Periodo
vMes=ALLTRIM(nummes)
vcli=numRi
vcta=ALLTRIM(codctc)
Vkey= Ri.periodo+ALLTRIM(Ri.NumMes)+Ri.NumRi
vfte=ALLT(Ri.codfte)
SELE astPre
SEEK Ri.Periodo+Ri.NumMes+Ri.NumRi
vCtaD = ""
vCtaH = ""
IF !EMPTY(AstPre.CtaDeb)
	vCtaD = AstPre.CtaDeb
 ELSE
	vCtaH = AstPre.CtaHab
ENDIF
IF !EOF()
	SKIP
ENDIF
IF !EMPTY(AstPre.CtaHab)
	vCtaH = AstPre.CtaHab
 ELSE
	vCtaD = AstPre.CtaDeb
ENDIF
@ 00,00 SAY CHR(27)+CHR(64)
@1,46  SAY CHR(15)
@1,48  SAY "<< RECIBO DE INGRESOS N§ "+NumRi+'.'+NumMes+" >>"
@1,104 SAY "P g.:"
@1,112 SAY ALLTRiM(STR(_PAGENO,8))
@2,19  SAY ALLTRIM(cia)
@2,86  SAY IIF(ALLT(m.tipRi)='50','R E F E R E N C I A L',IIF(Ri.Estado='99','A N U L A D O',' A T E N D I D O'))
@3,19  SAY "LisRi"
@3,51  SAY "Presupuestado A¤o "+STR(YEAR(DATE()),4)
@3,104 SAY "FECHA:"
@3,112 SAY fecRi
fila=4
@fila,17 SAY "Ú"
@fila,18 SAY REPLICATE("Ä",103)
@fila,121 SAY "¿"
fila=fila+1
@fila,17 SAY "³"
@fila,21 SAY "CODIGO"
@fila,30 SAY "³"
@fila,53 SAY "C O N C E P T O"
@fila,82 SAY "³"
@fila,95 SAY "I M P O R T E"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,82 SAY "³"
@fila,88 SAY "PARCIAL"
@fila,107 SAY "TOTAL"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "À"
@fila,18 SAY REPLICATE("Ä",103)
@fila,121 SAY "Ù"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,31 SAY CHR(27)+'G'
@fila,32 SAY MLINE(Ri.Observ,1)
@fila,80 SAY CHR(27)+'H'
@fila,86 SAY "³"
@fila,105 SAY "³"
@fila,125 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,2)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,3)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,4)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,5)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,6)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,7)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,8)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,9)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,10)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,11)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,12)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,13)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,32 SAY MLINE(Ri.Observ,14)
@fila,82 SAY "³"
@fila,101 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,31 SAY CHR(27)+'G'
@fila,33 SAY "Cta:"+m.codctc
@fila,54 SAY val_fun('Caja','codctc','LEFT(Descri,28)',m.codctc)
@fila,80 SAY CHR(27)+'H'
@fila,86 SAY "³"
@fila,105 SAY "³"
@fila,125 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,31 SAY CHR(27)+'G'
@fila,33 SAY "Contrat/Usuario: "+val_Auxi(ALLT(m.CodPrv),ALLT(m.TipAux),'D',37)
@fila,80 SAY CHR(27)+'H'
@fila,84 SAY "³"
@fila,103 SAY "³"
@fila,123 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,31 SAY CHR(27)+'G'
@fila,33 SAY factu(m.periodo,m.nummes,m.numri)
@fila,80 SAY CHR(27)+'H'
@fila,84 SAY "³"
@fila,103 SAY "³"
@fila,123 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,31 SAY CHR(27)+'G'
figv=18
*IF ALLT(m.tipri)='02'
*	@fila,33 SAY "L¡quido  :"
*	@fila,44 SAY ROUND((m.canri*100)/(figv+100),2) PICTURE "999,999.99"
*ENDIF
@fila,80 SAY CHR(27)+'H'
@fila,86 SAY "³"
@fila,105 SAY "³"
@fila,125 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,31 SAY CHR(27)+'G'
*IF ALLT(m.tipri)='02'
*	@fila,33 SAY "I.G.V.   :"
*	@fila,44 SAY ROUND(((m.canri*100)/(figv+100))*(figv/100),2) PICTURE "999,999.99"
*ENDIF
@fila,80 SAY CHR(27)+'H'
@fila,86 SAY "³"
@fila,105 SAY "³"
@fila,125 SAY "³"
*fila=fila+1
*@fila,17 SAY "³"
*@fila,30 SAY "³"
*@fila,82 SAY "³"
*@fila,101 SAY "³"
*@fila,121 SAY "³"
*fila=fila+1
*@fila,17 SAY "³"
*@fila,30 SAY "³"
*@fila,82 SAY "³"
*@fila,101 SAY "³"
*@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
SELE IteRi
SEEK VKEY 
IF FOUND()
	IF iteri.tipo='P'
		vdebpre = vCtaD
		vhabpre = vCtaH
	ELSE
       STORE ' ' TO vdebpre,vhabpre
	ENDIF
	SCAN WHILE vKey=IteRi.Periodo+Iteri.NumMes+Iteri.NumRi
		@fila,17 SAY "³"
		@fila,18 SAY IteRi.CodPart
		@fila,30 SAY "³"
		@fila,32 SAY IIF(!EMPTY(IteRi.concep),LEFT(IteRi.ConCep,48),LEFT(IteRi.Glosa,48))
		@fila,84 SAY "³"
		@fila,85 SAY IteRi.ImpParc PICTURE '@z 999,999,999.99'
		@fila,101 SAY "³"
		@fila,121 SAY "³"
		Fila=Fila+1
	ENDSCAN
ELSE
	@fila,30 SAY "³"
ENDIF
SELE Ri
*@fila,82 SAY "³"
*@fila,83 say Ri.canRi picture '@z 999,999,999.99'
*@fila,101 SAY  "³"
*@fila,121 SAY "³"
*fila=fila+1
@fila,17 SAY  "³"
@fila,30 SAY  "³"
@fila,82 SAY  "Ú"
@fila,83 SAY REPLICATE("Ä",38)
@fila,121 SAY "¿" 
fila=fila+1
@fila,17 SAY "³"
@fila,30 SAY "³"
@fila,82 SAY "³"
@fila,88 SAY "TOTAL  --->"
@fila,103 SAY Ri.Canri picture '@z 999,999,999,999.99'
@fila,121 SAY "³"
fila=fila+1
 @fila,17 SAY "³"
@fila,30 SAY "³"
@fila,82 SAY "À"
@fila,83 SAY REPLICATE("Ä",38) 
@fila,121 SAY "Ù"
fila=fila+1
@fila,17 SAY "<<<<<< CODIGO DE LA CONTABILIDAD PRESUPUESTAL Y CLASIFICACION PROGRAMATICA DEL GASTO PUBLICO  >>>>>>>>>"
fila=fila+4
@fila,17 SAY "Ú"
@fila,19 SAY REPLICATE("Ä",103)
@fila,121 SAY "¿" 
fila=fila+1
 @fila,17 SAY "³"
 @fila,25 SAY "Cuenta Mayor"
 @fila,48 SAY "³"
 @fila,56 SAY "³"
 @fila,65 SAY "³"
 @fila,70 SAY "³"
 @fila,75 SAY "³"
 @fila,80 SAY "³"
 @fila,86 SAY "³"
 @fila,92 SAY "³"
 @fila,102 SAY "³"
 @fila,112 SAY "³"
 @fila,121 SAY "³"
 fila=fila+1
 @fila,17 SAY "³"
 @fila,22 SAY "Debe"
 @fila,33 SAY "³"
 @fila,38 SAY "Haber"
 @fila,48 SAY "³"
 @fila,50 SAY "Sector"
 @fila,56 SAY "³"
 @fila,58 SAY "Pliego"
 @fila,65 SAY "³"
 @fila,67 SAY "UG"					&& "Prg"        
 @fila,70 SAY "³"
 @fila,72 SAY "UE"					&&"Spg"
 @fila,75 SAY "³"
 @fila,77 SAY "FUN"					&&"Pry"
 @fila,80 SAY "³"
 @fila,82 SAY "PRG"					&&"Obra"
 @fila,86 SAY "³"
 @fila,88 SAY "SPG"					&&"Act"
 @fila,92 SAY "³"
 @fila,94 SAY "ACT/PROY"			&&"Tarea"
 @fila,102 SAY "³"
 @fila,104 SAY "Cadena"				&&"Funcional"
 @fila,112 SAY "³"
 @fila,114 SAY "FteFto"
 @fila,121 SAY "³"
 fila=fila+1
 @fila,17 SAY "³"
 @fila,18 say replicate("-",29)
 @fila,48 SAY "³"
 @fila,49 say replicate("-",6)
 @fila,56 SAY "³"
 @fila,57 say replicate("-",7)
 @fila,65 SAY "³"
 @fila,66 say replicate("-",3)
 @fila,70 SAY "³"
 @fila,71 say replicate("-",3)
 @fila,75 SAY "³"
 @fila,76 say replicate("-",3)
 @fila,80 SAY "³"
 @fila,81 say replicate("-",4)
 @fila,86 SAY "³"
 @fila,87 say replicate("-",4)
 @fila,92 SAY "³"
 @fila,93 say replicate("-",8)
 @fila,102 SAY "³"
 @fila,103 say replicate("-",8)
 @fila,112 SAY "³"
 @fila,113 say replicate("-",8)
 @fila,121 SAY "³"
 fila=fila+1
 IF newsistem='1'
 	=val_codcad(ALLTRIM(Ri.codcad),Ri.periodo+'01001','C')
 ELSE
 	=val_codca1(ALLTRIM(Ri.codcad),Ri.periodo,'C')
 ENDIF

 @fila,17 SAY "³"
 @fila,19 SAY Vdebpre
 @fila,33 SAY "³"
 @fila,35 SAY Vhabpre
 @fila,48 SAY "³"
 @fila,51 SAY "25"
 @fila,56 SAY "³"
 @fila,59 SAY "401"
 @fila,65 SAY "³"
 @fila,67 SAY maepre.uniges                &&SUBSTR(Ri.CodCal,8,2)
 @fila,70 SAY "³"
 @fila,72 SAY maepre.unieje                &&SUBSTR(Ri.CodCal,10,3)
 @fila,75 SAY "³"
 @fila,77 SAY maepre.codfun                &&SUBSTR(Ri.CodCal,13,3)
 @fila,80 SAY "³"
 @fila,82 SAY maepre.codprg                &&SUBSTR(Ri.CodCal,16,2)
 @fila,86 SAY "³"
 @fila,88 SAY maepre.codspr
 @fila,92 SAY "³"
 @fila,95 SAY maepre.actpry
 @fila,102 SAY "³"
 @fila,105 SAY maepre.codCad
 @fila,112 SAY "³"
 @fila,115 SAY Ri.CodFte                  &&SUBSTR(Ri.CodCal,5,3)
 @fila,121 SAY "³"
 fila=fila+1
@fila,17 SAY "À"
@fila,18 SAY REPLICATE("Ä",103) 
@fila,121 SAY "Ù"
fila=fila+1
@fila,17 SAY "Ú"
@fila,18 SAY REPLICATE("Ä",64)
@fila,82 SAY "¿" 
@fila,84 SAY "Ú"
@fila,85 SAY REPLICATE("Ä",36)
@fila,121 SAY "¿" 
fila=fila+1
 @fila,17 SAY "³"
 @fila,18   SAY "C O N T A B I L I D A D   P A T R I M O N I A L"
 @fila,82 SAY "³"
 @fila,84 SAY "³"
 @fila,121 SAY "³"
 fila=fila+1
 @fila,17 SAY "³"
 @fila,24 SAY "C O D I G O                           I M P O R T E"
 @fila,82 SAY "³"
 @fila,84 SAY "³"
 @fila,121 SAY "³"
 fila=fila+1
 @fila,17 SAY "³"
 @fila,18 SAY REPLICATE('-',64)
 @fila,82 SAY "³"
 @fila,84 SAY "³"
 @fila,121 SAY "³"
 fila=fila+1
 @fila,17 SAY "³"
 @fila,18 SAY "CUENTA"
 @fila,24 SAY "³"
 @fila,29 SAY "SUB-CTAS"
 @fila,46 SAY "³"
 @fila,52 SAY "DEBE"
 @fila,66 SAY "³"
 @fila,72 SAY "HABER"
 @fila,82 SAY "³"
 @fila,84 SAY "³"
 @fila,85 SAY "1.----------------------------------"
 @fila,121 SAY "³"
 fila=fila+1
 @fila,17 SAY "³"
 @fila,18 SAY "MAYOR"
 @fila,24 SAY "³"
 @fila,46 SAY "³"
 @fila,66 SAY "³"
 @fila,82 SAY "³"
 @fila,84 SAY "³"
 @fila,85 SAY "       Director de tesorer¡a        "
 @fila,121 SAY "³"
 fila=fila+1
@fila,17 SAY "À"
@fila,18 SAY REPLICATE("Ä",64) 
@fila,82 SAY "Ù"
@fila,84 SAY "À"
@fila,85 SAY REPLICATE("Ä",36) 
@fila,121 SAY "Ù"
 fila=fila+1
@fila,17 SAY "Ú"
@fila,18 SAY REPLICATE("Ä",64)
@fila,82 SAY "¿" 
@fila,84 SAY "Ú"
@fila,85 SAY REPLICATE("Ä",36)
@fila,121 SAY "¿" 
XKEY=Ri.PERiODO+ALLTRiM(Ri.NUMMES)+Ri.NUMRi+ALLTRiM(Ri.CODCTC)
SELE ASTPAT
SEEK XKEY
fila=fila+1
SCAN WHILE PERiODO=VPER AND NUMMES=ALLTRiM(VMES) AND NUMREF=VCLI AND CODCTC=ALLTRiM(VCTA)
     @fila,17 SAY "³"
     IF TIPCTA="D"
     	  @fila,18 SAY SUBSTR(ASTPAT.CODCTA,1,2)
		  @fila,24 SAY "³"
     	  @fila,25 SAY ASTPAT.CODCTA
		  @fila,35 SAY "³"
		  @fila,46 SAY "³"
          @fila,47 SAY ASTPAT.MTODEB  PICTURE "@z 999,999,999,999.99"
		  @fila,66 SAY "³"
     ELSE     
     	  @fila,21 SAY SUBSTR(ASTPAT.CODCTA,1,2)
		  @fila,24 SAY "³"
		  @fila,35 SAY "³"
     	  @fila,36 SAY ASTPAT.CODCTA
		  @fila,46 SAY "³"
		  @fila,66 SAY "³"
          @fila,67 SAY ASTPAT.MTOHAB  PICTURE "@z 999,999,999.99"
     ENDIF
     @fila,82 SAY "³"
     @fila,84 SAY "³"
     @fila,121 SAY "³"
     fila=fila+1
ENDSCAN
SELE Ri
@fila,17 SAY "À"
@fila,18 SAY REPLICATE("Ä",64) 
@fila,82 SAY "Ù"
@fila,84 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "Ú"
@fila,18 SAY REPLICATE("Ä",44)
@fila,62 SAY "¿" 
@fila,84 SAY "³"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "³"
@fila,19 SAY "VoBo"
@fila,62 SAY "³"
@fila,84 SAY "³"
@fila,85 SAY "2.----------------------------------"
@fila,121 SAY "³"
fila=fila+1
@fila,17 SAY "À"
@fila,19 SAY REPLICATE("Ä",44) 
@fila,62 SAY "Ù"
@fila,84 SAY "³"
@fila,85 SAY "    Recepcionista del Dep¢sito      "
@fila,121 SAY "³"
fila=fila+1
@fila,84 SAY "À"
@fila,85 SAY REPLICATE("Ä",36) 
@fila,121 SAY "Ù"
fila = fila + 1
@ FILA, 1 SAY CHR(12)
*IF _DEST1=2
*  	EJECT
*ENDIF
*ENDFOR
SET DEVICE TO SCREEN 
RETURN


FUNCTION Observa
*---------------
vAlias = ALIAS()
SELECT Ri
SET MEMOWIDTH TO 50
ON KEY LABEL F10 KEYBOARD CHR(23)
IF !WEXIST("Observa")
   DEFINE WINDOW Observa FROM 03,14 TO 20,66 FLOAT NOCLOSE SHADOW DOUBLE TITLE '± Observaciones ±' FOOTER ' ° ®F10¯ Graba ° ' COLOR SCHEME 1
ENDIF
IF WVISIBLE("Observa")
   ACTIVATE WINDOW Observa SAME
ELSE
   ACTIVATE WINDOW Observa NOSHOW
ENDIF
IF ingreso
	REPLACE observ WITH SPACE(12)+w_Obs
ENDIF

MODIFY MEMO OBSERV WINDOW OBSERVA
IF !WVISIBLE("Observa")
	ACTIVATE WINDOW Observa
ENDIF
RELEASE WINDOW Observa
IF LASTKEY()=27
	DO STANDBY WITH 'Proceso cancelado. No graba la Observaci¢n '
ENDIF
SELECT (vAlias)
RETURN .T.


FUNCTION concepto
*---------------
vAlias = ALIAS()
SELECT Rever
SET MEMOWIDTH TO 50
ON KEY LABEL F10 KEYBOARD CHR(23)
IF !WEXIST("Concepto")
   DEFINE WINDOW Concepto FROM 03,14 TO 20,66 FLOAT NOCLOSE SHADOW DOUBLE TITLE '± Observaciones ±' FOOTER ' ° ®F10¯ Graba ° ' COLOR SCHEME 1
ENDIF
IF WVISIBLE("Concepto")
   ACTIVATE WINDOW concepto SAME
ELSE
   ACTIVATE WINDOW concepto NOSHOW
ENDIF
MODIFY MEMO concepto WINDOW concepto
IF !WVISIBLE("Concepto")
   ACTIVATE WINDOW concepto
ENDIF
RELEASE WINDOW concepto
IF LASTKEY()=27
   DO STANDBY WITH 'Proceso cancelado. No graba la Observaci¢n '
ENDIF
SELECT (vAlias)
RETURN .T.


FUNCTION VisObs
*--------------
vAlias = ALIAS()
SELECT Ri
IF !WEXIST("Observa")
   DEFINE WINDOW Observa FROM 03,14 TO 20,66 FLOAT NOCLOSE SHADOW DOUBLE TITLE '± Observaciones ±' FOOTER ' ° ®Esc¯ Sale ° ' COLOR SCHEME 1
ENDIF

IF WVISIBLE("Observa")
   ACTIVATE WINDOW Observa SAME
ELSE
   ACTIVATE WINDOW Observa NOSHOW
ENDIF

MODIFY MEMO OBSERV NOEDIT WINDOW OBSERVA

IF !WVISIBLE("Observa")
   ACTIVATE WINDOW Observa
ENDIF
RELEASE WINDOW Observa
RETURN .T.


FUNCTION VALFECHA
*----------------
an=Right(str(year(date()),4),2)
vMe = val(m.Nummes)+1
me = padl(alltRim(str(vMe,2)),2,'0')
vFec = '01/&ME/&AN'
m.FecRi = ctod(vFec) - 1
return .t.


FUNCTION Valida        && Suma todos los Items ingresados.
*--------------
PRiVATE vAcum
vAcum=0
SELE IteRi
SEEK m.Periodo+ALLTRiM(m.NumMes)+m.NumRi
SCAN WHILE Periodo=m.Periodo AND ALLTRiM(m.NumMes)=IteRi.NumMes AND m.NumRi=IteRi.NumRi
     vAcum = vAcum + IteRi.impparc
ENDSCAN
SELE Ri
IF vAcum > Ri.CANRi
   DO StandBy WITH 'ERROR! El importe excede el monto depositado... CORREGIR'
ENDIF
IF vAcum < Ri.CANRi
   DO StandBy WITH 'ERROR! El importe es menor al monto depositado... CORREGIR'
ENDIF
RETURN


PROCEDURE ingap   && Ingresa asientos patrimoniales
*--------------
ACTIVATE SCREEN
HIDE MENU mMenu

vTempo = '°°°°°°°°F5->Agregar°°°°°°°°°°°°°°F8->Eliminar°°°°°°°°°°°°°°F10->Terminar°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
ON KEY LABEL F5 DO AgRite
ON KEY LABEL F8 DO EliIte
ON KEY LABEL F10 KEYBOARD CHR(23)
SELECT astpat
SEEK m.Periodo+ALLTRiM(m.nummes)+m.numRi+m.CodCtc
IF !FOUND()
	DO agRiaut
ENDIF

IF FOUND()
	SEEK m.Periodo+ALLTRiM(m.nummes)+m.numRi+m.CodCtc
	IF FOUND()
		BROWSE FIELDS ;
			codcta :H='Cuenta':v=val_fun('Cuenta','Cuenta',"Cuenta+' '+DescRi",codcta,2):F ,;
			tipcta :H='D/H' :P='@M D,H',;
			mtodeb :H='Monto Debe'  :W=tipcta='D' :P='999,999,999.99',;
			mtohab :H='Monto Haber' :W=tipcta='H' :P='999,999,999.99';
			WINDOW wind_2 KEY m.Periodo+ALLTRiM(m.NumMes)+m.NumRi+m.CodCtc
		STORE 0 TO vdebe, vhaber ,vRet
		SEEK m.Periodo+ALLTRiM(m.nummes)+m.numRi		&&+m.CodCtc
		SCAN WHILE PERiODO=m.Periodo AND nummes=ALLTRiM(m.nummes) AND numRef=m.numRi		&& AND m.CodCtc=codctc
			IF IIF(TipCta='D',MtoDeb,MtoHab)=0
				dele next 1
			 else
				vdebe = vdebe  + IIF(tipcta='D',mtodeb,0)
				vhaber= vhaber + IIF(tipcta='H',mtohab,0)
			ENDIF
		ENDSCAN
		IF vdebe#vhaber
		   DO standby WITH 'Ojo: No cuadra debe con haber'
		ENDIF
	ENDIF
ENDIF

ON KEY
SELECT Ri
ON KEY LABEL F10
ON KEY LABEL F8
ON KEY LABEL F5
UNLOCK
ACTIVATE SCREEN
vTempo = '°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
SHOW MENU mMenu
RETURN

PROCEDURE agRite
*---------------
SELECT astpat
IF f_appd()
	REPLACE peRiodo WITH m.Periodo,;
	     	nummes WITH m.nummes,;
	        numref WITH m.numRi,;
	        tipdoc WITH 'R/I',;
	        codctc WITH m.CodCtc,;
	        fecha  WITH m.FecRi,;
	        TipCtc WITH w_TipCtc
ENDIF
RETURN

PROCEDURE AgeIteF
*---------------
SELECT astpat
IF f_appd()
	REPLACE peRiodo WITH m.Periodo,;
	     	nummes WITH m.nummes,;
	        numref WITH m.numRi,;
	        tipdoc WITH 'FAC',;
	        codctc WITH m.CodCtc,;
	        fecha  WITH m.FecRi,;
	        TipCtc WITH w_TipCtc
ENDIF
RETURN

PROCEDURE agRiaut
*---------------
PRIVATE i,j
*SELECT astpat

laCadEnl = ALEN(acadenl)/9

IF type("acadenl")#'L'
	FOR i = 1 TO laCadEnl
		IF acadenl(i,1) = 'R'
			SELE AstPat
			IF !SEEK(m.Periodo+m.NumMes+m.NumRI)
				IF f_appd()
					REPLACE peRiodo WITH m.Periodo,;
							nummes WITH m.nummes,;
	        				numref WITH m.numRi,;
							tipdoc WITH 'R/I',;
							codctc WITH m.CodCtc,;
							fecha  WITH m.FecRi,;
							tipctc WITH w_TipCtc,;
							tipcta  WITH 'D',;
							Codcta  WITH aCadenl(i,2),;
							mtodeb  WITH aCadenl(i,8)
				ENDIF
				IF f_appd()
					REPLACE peRiodo WITH m.Periodo,;
				    	 	nummes WITH m.nummes,;
					        numref WITH m.numRi,;
					        tipdoc WITH 'R/I',;
					        codctc WITH m.CodCtc,;
					        fecha  WITH m.FecRi,;
					        tipctc WITH w_TipCtc,;
				        	tipcta  WITH 'H',;
				    	    Codcta  WITH aCadEnl(i,3),;
					        mtoHab  WITH aCadEnl(i,8)
				ENDIF
			ELSE
				FOR j = 1 to 2
					IF j = 1
						SEEK m.Periodo+m.NumMes+m.NumRI
						xNvo = .T.
						SCAN WHILE Periodo+NumMes+NumRef = m.Periodo+m.NumMes+m.NumRI
							IF CodCta = aCadEnl(i,2) AND TipCta = 'D'
								REPLACE MtoDeb WITH MtoDeb + aCadEnl(i,8)
								xNvo = .F.
								LOOP
							ENDIF
						ENDSCAN
						IF xNvo AND !EMPTY(aCadenl(i,2))
							IF f_appd()
								REPLACE peRiodo WITH m.Periodo,;
										nummes WITH m.nummes,;
	    	    						numref WITH m.numRi,;
										tipdoc WITH 'R/I',;
										codctc WITH m.CodCtc,;
										fecha  WITH m.FecRi,;
										tipctc WITH w_TipCtc,;
										tipcta  WITH 'D',;
										Codcta  WITH aCadEnl(i,2),;
										mtodeb  WITH aCadEnl(i,8)
							ENDIF
						ENDIF
					ENDIF
					IF j = 2
						SEEK m.Periodo+m.NumMes+m.NumRI
						xNvo = .T.
						SCAN WHILE Periodo+NumMes+NumRef = m.Periodo+m.NumMes+m.NumRI
							IF CodCta = aCadEnl(i,3) AND TipCta = 'H'
								REPLACE MtoHab WITH MtoHab + aCadEnl(i,8)
								xNvo = .F.
								LOOP
							ENDIF
						ENDSCAN
						IF xNvo AND !EMPTY(aCadenl(i,3))
							IF f_appd()
								REPLACE peRiodo WITH m.Periodo,;
				    	 				nummes WITH m.nummes,;
								        numref WITH m.numRi,;
								        tipdoc WITH 'R/I',;
								        codctc WITH m.CodCtc,;
				        				fecha  WITH m.FecRi,;
								        tipctc WITH w_TipCtc,;
						    	    	tipcta  WITH 'H',;
						        		Codcta  WITH aCadEnl(i,3),;
								        mtoHab  WITH aCadEnl(i,8)
							ENDIF
						ENDIF
					ENDIF
				ENDFOR
			ENDIF
		ENDIF
	ENDFOR
ENDIF

RETURN


PROCEDURE EliIte
*---------------
SELECT AstPat
IF RLOCK()
	DELETE NEXT 1
ENDIF
RETURN

FUNCTION Separa  &&Para el reporte
*--------------
As=ALIAS()
VKEY = Periodo+NumMes+NumRi
SELECT ASTPAT
vInd = SYS(3) + '.Idx'
INDEX ON PERiODO+NumMes+NumREF+CodCtc+TipCta to (vInd) for PERiODO+NUMMES+NUMREF = VKEY .AND. TipDoc = 'R/I'
SELECT (AS)
RETURN ' '


FUNCTION Cuenta  &&Para el reporte
*--------------
PARAMETER TIPO
AS=ALIAS()
VKEY = PERiODO+NUMMES+NUMRi
SELECT ASTPAT
VCTA=IIF(TIPO='D',ASTPAT.CODCTA,ASTPAT.CODCTA)
VALO=IIF(TIPO='D',ASTPAT.MTODEB,ASTPAT.MTOHAB)
IF !EOF()
   SKIP
ENDIF
SELECT (AS)
RETURN ' '


FUNCTION TotalRi && Suma todos los Items ingresados.
*---------------
PUBLIC vTot1
vAli=ALIAS()
vOrd=ORDER()
SELECT IteRi
vRec=RECNO()
vNumRi=Ri.NumRi
vNumMes=Ri.NumMes
VPER=Ri.PERiODO
vTot1=0
SEEK VPER+ALLTRiM(VNUMRi+VNUMMES)
*SET FILTER TO ALLTRiM(Ri.NumMes)=vNumMes .AND. ALLTRiM(Ri.NumRi)=vNumRi
*GO TOP
SUM IteRi.IMPPARC TO VTOT1 FOR vNumMes=ALLTRiM(IteRi.NumMes) .AND. vnumRi=ALLTRiM(IteRi.NumRi)
*SET FILTER TO
SELECT (vAli)
SET ORDER TO vOrd
RETURN vTot1


*- 5 Codigo auxiliar
FUNCTION v_aux
*-------------
 _ALI_ = ALIAS()
 resx  = .F.
 IF m.TipAux='05' OR m.TipAux='25' OR m.TipAux='20'
    vAli=ALIAS()
    vOrd=ORDER()
    SELECT AUXIL
    SET ORDE TO AUXIL1
    vReturn = Val_fun('AUXIL','Codigo',"Codigo+' '+DescRi",CodPrv,1,7,20,'SUBSTR(descRi,1,22)')
    SELECT (vAli)
    SET ORDE TO vOrd
    RETURN vReturn
 ELSE
    IF EMPTY(m.CodPrv)
       xaux = SPACE(30)  && Temporalmente guarda la descRipci¢n
       SELECT Auxil
       vidx = SYS(3) + '.idx'
       INDEX ON DescRi TO &vidx FOR m.Tipaux = Tipo
       resx = val_fun('Auxil','DescRi','descRi',xaux,1)       
        SELECT Auxil
       SEEK xAux
       xaux = Auxil.Codigo
       SET INDEX TO
       SET ORDER TO TAG AUXIL1
       ERASE (vidx)
       SELECT Ri
       IF resx
          REPLACE CodPrv WITH xaux
       ENDIF
    ELSE
       SELECT Auxil
       IF !SEEK(m.tipaux + Ri.CodPrv)
          IF yesno("Auxiliar no existe. ¨Crea nuevo?")
             IF ap_aux(m.Registro)
                resx = .T.
             ENDIF
          ENDIF
       ELSE
          resx = .T.
       ENDIF
    ENDIF
 ENDIF

 SELECT Auxil
 SEEK m.tipaux + SUBSTR(Ri.CodPrv,1,6)
 @ 4,68 SAY SUBSTR(Auxil.descRi,1,18)

 SELECT (_ali_)

RETURN resx


* 13.- Apertura de Auxiliares
FUNCTION ap_aux
*--------------
PARAMETER xxcta
*- apertura de auxiliares en l¡nea
 DEFINE WINDOW ap_aux FROM 3,5 TO 20,75 TITLE " APERTURA DE AUXILIARES " COLOR SCHEME 10
 ACTIVATE WINDOW ap_aux
 CLEAR

 PRiVATE m.Tipo,     m.DescRi,  m.Direccion, m.Codigo
 PRiVATE m.Telefono, m.Ruc      m.Observ

 *- Aqu¡ coloca valores por omisi¢n (default)

 SELECT Auxil
 SCATTER MEMVAR BLANK
 m.Tipo   = Ri.TipAux
 m.Codigo = Ri.CodPrv
 xxalias = ALIAS()

 vreg = IIF(!EOF(),RECNO(),0)

 @  3, 2 SAY "            C¢digo:" + m.Codigo
 @  5, 2 SAY "       DescRipci¢n:" GET m.DescRi
 @  7, 2 SAY "         Direcci¢n:" GET m.Direccion
 @  9, 2 SAY "          Telfono:" GET m.Telefono
 @ 11, 2 SAY "             R.U.C:" GET m.Ruc
 @ 13, 2 SAY "     Observaciones:" GET m.Observ

 READ

 IF vreg # 0 .AND. vreg <= RECCOUNT()
    GO vreg
 ENDIF

 IF LASTKEY() <> 27 .AND. yesno("Confirme el ingreso")
    IF f_appd()
       GATHER MEMVAR
    ENDIF
    UNLOCK
 ELSE
    RELEASE WINDOW ap_aux
    SELECT Ri
    RETURN .F.
 ENDIF

 RELEASE WINDOW ap_aux
 SELECT Ri

RETURN .T.


FUNCTION Igual
*-------------
vAli=ALIAS()
vOrd=ORDER()
IF VAL(m.NumMes)#MONT(m.FecRi)
	DO StandBy WITH "Atencion el Mes no coincide con la fecha"
ENDIF
SELE Ri
SEEK m.Periodo+ALLTRiM(m.NumMes)+ALLTRiM(m.NumRi)
IF FOUND()
   DO StandBy WITH "El Documento YA EXISTE"
   SELECT (vAli)
   SET ORDER TO vOrd
   RETURN .F.
ENDIF
SELECT (vAli)
SET ORDER TO vOrd
RETURN


PROCEDURE Termi
*--------------
  vEn_accion = .F.
  ON KEY LABEL F2    
  ON KEY LABEL f4 
  ON KEY LABEL f9 
  DEACTIVATE MENU
  RETURN


PROCEDURE Fin_opcion
*-------------------
  CLOSE DATA
  ON KEY LABEL F2    
  ON KEY
  RELEASE    WINDOW wind_0
  RELEASE    WINDOW wind_1
  RELEASE    WINDOW wind_c1
  RELEASE    MENU   mMenu
  RESTORE SCREEN FROM PRiNCIPAL
  RETURN


FUNCTION val_resp
*----------------
parameter vcampo
IF empty(vcampo)
   DO StandBy WITH "Ingrese 05 ¢ 20 ¢ 25 para ver Prove/Cont. y 03 Trabajador"
   _Curobj=objnum(vcampo)
else
 IF VCAMPO#'05'
 	 IF VCAMPO#'20'
  	 	IF VCAMPO#'25'
 			IF VCAMPO#'03' 	 	
  	 			DO StandBy WITH "Ingrese 05 ¢ 20 ¢ 25 para ver Prove/Cont. y 03 Trabajador"
  	 			_Curobj=objnum(vcampo)
  	 		endif	
  	 	endif
  	 endif
  endif 	
endif  
RETURN

FUNCTION Val_IngE
*---------------
  PARAMETERS mValor, Filtro, mVaRiable, mCol, mLong
  PRiVATE mAlias
  DO CASE
    CASE PARAMETERS() = 2
      mCol = 0
      mVaRiable = ' '
      mLong = 40
    CASE PARAMETERS() = 3
      mCol = 0
      mLong = 40
    CASE PARAMETERS() = 4
      mLong = 40               && Longitud campo DESCRi
  ENDCASE
  mAlias  = ALIAS()
  SELECT IngR
  SEEK Filtro+mValor

  IF !FOUND() AND !mVaRiable $'VZ'
      _OldWnd = WOUTPUT()
      ACTIVATE SCREEN
      IF !EMPTY(FILTRO)
         SET FILTER TO CodIng >= Filtro
      ENDIF
      GO TOP
      IF EOF() 
         DO STANDBY WITH 'No existen partidas definidas'
         SET FILTER TO
         sele (malias)
         return &&.f.
      endif
      DEFINE POPUP parametro FROM 03,40 PROMPT FIELD ALLTRiM(CODING)+'.'+ALLTRiM(SUBING)+' '+SUBSTR(DESING,1,40)
      ON SELECTION POPUP parametro DEACTIVATE POPUP
      ACTIVATE POPUP parametro
      IF !EMPTY( _OldWnd)
         ACTIVATE WINDOW &_OldWnd
      ENDIF

      RELEASE POPUP parametro
      SET FILTER TO
 ENDIF
 mValor = IngR.CodIng 
 mDescr = SUBSTR( IngR.DesIng, 1, mLong )
 SET ORDE TO 1
  IF !EMPTY( mAlias )
    SELECT (mAlias)
  ENDIF
  DO CASE
    CASE mVaRiable=' '   && En edici¢n
      @ ROW(),mCol   SAY mValor
      @ ROW(),mCol+7 SAY mDescr
      RETURN .T.
    CASE mVaRiable='A'   && En edici¢n SOLO DESCRiPCION
      @ ROW(),mCol SAY mDescr
      RETURN
    CASE mVaRiable='V'   && En vista
      @ ROW(),COL()  SAY mValor
      RETURN mDescr
    CASE mVaRiable='D'   && En vista
      RETURN mDescr
    CASE mVaRiable='Z'   && En vista SIN PINTAR
      RETURN mDescr
    CASE mVaRiable='C'   && Solo codigo
      RETURN .T.
    CASE mVaRiable='T'
      &mVaRiable = mValor
      @ ROW(),mCol+7 SAY mDescr
      RETURN  mValor
    OTHERWISE            && En browse de edici¢n
      REPLACE &mVaRiable WITH mValor
      wCodPart=MVALOR
      RETURN .T.
  ENDCASE


PROCEDURE ComPre
*---------------
PRIVATE i,j
AS=ALIAS()
nTotD = 0
nTotH = 0
lMuestra = .F.
*wait wind type("acadenl")

SELE AstPre
cOrd = ORDER()
SET ORDER TO astpre5

IF !SEEK(ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+'R/I')
	IF type("acadenl")#'L'
		laCadEnl = ALEN(acadenl)/9
		FOR i = 1 TO laCadEnl
			IF acadenl(i,1) = 'R'
				SELE AstPre
				IF !SEEK(m.NumMes+m.NumRI+'R/I') AND !EMPTY(aCadenl(i,4)) AND !EMPTY(aCadenl(i,5))
					IF f_appd()
						REPLACE Periodo WITH m.Periodo,;
						        nummes  WITH m.nummes,;
								tipdoc  WITH 'R/I',;
								numref  WITH m.numRi ,;
								tipo    WITH 'D',;
								fecref  WITH m.fecRi,;
								CodCtc  WITH ALLTRiM(m.CodCtc),;
								CodCad  WITH m.CodCad,;
								ctadeb  WITH aCadenl(i,4),;
							    ctahab  WITH SPACE(10),;
								cuenta  WITH aCadenl(i,4),;
						    	valdeb  WITH aCadenl(i,8),;
							    valhab  WITH 0
					ENDIF
					IF f_appd()
						REPLACE Periodo WITH m.Periodo,;
								nummes WITH m.nummes,;
								tipdoc WITH 'R/I',;
								numref WITH m.numRi ,;
								tipo WITH 'H',;
								fecRef WITH m.fecRi,;
								CodCtc WITH ALLTRiM(m.CodCtc),;
								CodCad WITH m.CodCad,;
		    				    ctadeb WITH SPACE(12),;
								ctahab WITH aCadEnl(i,5),;
								cuenta WITH aCadEnl(i,5),;
								valdeb WITH 0 ,;
								valhab WITH aCadEnl(i,8)
					ENDIF
					lMuestra = .T.
				ELSE
					FOR j = 1 to 2
						IF j = 1
							xNvo = .T.
							IF SEEK(m.NumMes+m.NumRI+'R/I') AND !EMPTY(aCadenl(i,4))
								SCAN WHILE NumMes+NumRef+TipDoc = m.NumMes+m.NumRI+'R/I'
									IF CtaDeb = aCadEnl(i,4) AND Tipo = 'D'
										REPLACE ValDeb WITH ValDeb + aCadEnl(i,8)
										lMuestra = .T.
										xNvo = .F.
										LOOP
									ENDIF
								ENDSCAN
							ENDIF
							IF xNvo AND !EMPTY(aCadenl(i,4))
								IF f_appd()
									REPLACE Periodo WITH m.Periodo,;
									        nummes  WITH m.nummes,;
											tipdoc  WITH 'R/I',;
											numref  WITH m.numRi ,;
											tipo    WITH 'D',;
											fecref  WITH m.fecRi,;
											CodCtc  WITH ALLTRiM(m.CodCtc),;
											CodCad  WITH m.CodCad,;
											ctadeb  WITH aCadenl(i,4),;
										    ctahab  WITH SPACE(10),;
											cuenta  WITH aCadenl(i,4),;
										    valdeb  WITH aCadenl(i,8),;
										    valhab  WITH 0
								ENDIF
								lMuestra = .T.
							ENDIF
						ENDIF
						IF j = 2
							xNvo = .T.
							IF SEEK(m.NumMes+m.NumRI+'R/I') AND !EMPTY(aCadenl(i,5))
								SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'R/I'
									IF CtaHab = aCadEnl(i,5) AND Tipo = 'H'
										REPLACE ValHab WITH ValHab + aCadEnl(i,8)
										lMuestra = .T.
										xNvo = .F.
										LOOP
									ENDIF
								ENDSCAN
							ENDIF
							IF xNvo AND !EMPTY(aCadenl(i,5))
								IF f_appd()
									REPLACE Periodo WITH m.Periodo,;
											nummes WITH m.nummes,;
											tipdoc WITH 'R/I',;
											numref WITH m.numRi ,;
											tipo WITH 'H',;
											fecRef WITH m.fecRi,;
											CodCtc WITH ALLTRiM(m.CodCtc),;
											CodCad WITH m.CodCad,;
			    						    ctadeb WITH SPACE(12),;
											ctahab WITH aCadEnl(i,5),;
											cuenta WITH aCadEnl(i,5),;
											valdeb WITH 0 ,;
											valhab WITH aCadEnl(i,8)
								ENDIF
								lMuestra = .T.
							ENDIF
						ENDIF
					ENDFOR
				ENDIF
			ENDIF
		ENDFOR
	ENDIF
ELSE
	IF SEEK(ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+'R/I')
		SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'R/I'
			IF Tipo = 'D'
				REPLACE ValDeb WITH 0
			ELSE
				REPLACE ValHab WITH 0
			ENDIF
		ENDSCAN
	ENDIF

	IF type("acadenl")#'L'
		laCadEnl = ALEN(acadenl)/9
		FOR i = 1 TO laCadEnl
			IF acadenl(i,1) = 'R'
				SELE AstPre
				FOR j = 1 to 2
					IF j = 1
						xNvo = .T.
						IF  SEEK(m.NumMes+m.NumRI+'R/I') AND !EMPTY(aCadenl(i,4))
							SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'R/I'
								IF CtaDeb = aCadEnl(i,4) AND Tipo = 'D'
									REPLACE ValDeb WITH ValDeb + aCadEnl(i,8)
									lMuestra = .T.
									xNvo = .F.
									LOOP
								ENDIF
							ENDSCAN
						ENDIF
						IF xNvo AND !EMPTY(aCadenl(i,4))
							IF f_appd()
								REPLACE Periodo WITH m.Periodo,;
								        nummes  WITH m.nummes,;
										tipdoc  WITH 'R/I',;
										numref  WITH m.numRi ,;
										tipo    WITH 'D',;
										fecref  WITH m.fecRi,;
										CodCtc  WITH ALLTRiM(m.CodCtc),;
										CodCad  WITH m.CodCad,;
										ctadeb  WITH aCadenl(i,4),;
									    ctahab  WITH SPACE(10),;
										cuenta  WITH aCadenl(i,4),;
									    valdeb  WITH aCadenl(i,8),;
									    valhab  WITH 0
							ENDIF
							lMuestra = .T.
						ENDIF
					ENDIF
					IF j = 2
						xNvo = .T.
						IF  SEEK(m.NumMes+m.NumRI+'R/I') AND !EMPTY(aCadenl(i,5))
							SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'R/I'
								IF CtaHab = aCadEnl(i,5) AND Tipo = 'H'
									REPLACE ValHab WITH ValHab + aCadEnl(i,8)
									lMuestra = .T.
									xNvo = .F.
									LOOP
								ENDIF
							ENDSCAN
						ENDIF
						IF xNvo AND !EMPTY(aCadenl(i,5))
							IF f_appd()
								REPLACE Periodo WITH m.Periodo,;
										nummes WITH m.nummes,;
										tipdoc WITH 'R/I',;
										numref WITH m.numRi ,;
										tipo WITH 'H',;
										fecRef WITH m.fecRi,;
										CodCtc WITH ALLTRiM(m.CodCtc),;
										CodCad WITH m.CodCad,;
			    					    ctadeb WITH SPACE(12),;
										ctahab WITH aCadEnl(i,5),;
										cuenta WITH aCadEnl(i,5),;
										valdeb WITH 0 ,;
										valhab WITH aCadEnl(i,8)
							ENDIF
							lMuestra = .T.
						ENDIF
					ENDIF
				ENDFOR
			ENDIF
		ENDFOR
	ENDIF
ENDIF

IF lMuestra
	IF SEEK(ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+'R/I')
		SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'R/I'
			IF Tipo = 'D'
				w_PreD = CtaDeb
				nTotD  = nTotD + ValDeb
			ELSE
				w_PreH = CtaHab
				nTotH  = nTotH + ValHab
			ENDIF
		ENDSCAN
	ENDIF
	
	SET ORDER TO (cOrd)
	SELE (AS)
	ACTIVATE WINDOW wind_6
	@ 00,08  SAY 'Cuentas '
	@ 00,18  SAY 'Debe '
	@ 00,34  SAY 'Haber '
	@ 01,04  SAY w_PreD PICTURE '!!!!!!!!!!!!' 
	@ 01,18  SAY nTotD  PICTURE '999,999,999.99' 
	@ 02,12  SAY w_PreH PICTURE '!!!!!!!!!!!!' 
	@ 02,34  SAY nTotH  PICTURE '999,999,999.99'
	WAIT ' '
	DEACTIVATE WINDOW wind_6
	vValdeb = nTotD
	vValhab = nTotH
ENDIF

SELE AstPre
SET ORDER TO (cOrd)
SELE (AS)

RETURN


*PROCEDURE ComPre
*---------------
AS=ALIAS()
*BROWS

w_PreD =   PADR("8501"+IIF(m.CodFte="09","0201","0101"),15,"0")
w_PreH =   PADR("8201"+IIF(m.CodFte="09","0201","0101"),15,"0")

*w_PreD = PADR(w_PreD+CodCad,10,"0")
*w_PreH = PADR(w_PreH,10,"0")

SELE IteRI
SEEK m.Periodo+m.NumMes+m.NumRI
nTot = 0
IF FOUND()
	SCAN FOR Periodo = m.Periodo AND NumMes = m.NumMes AND NumRi = m.NumRI AND Tipo="P"
		nTot = nTot + ImpParc
	ENDSCAN
ENDIF

SELE AstPre
cOrd = ORDER()
SET ORDER TO astpre6

SEEK 'D'+m.Periodo+ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+ALLTRiM(w_PreD)
*SEEK 'D'+m.Periodo+ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+ALLTRiM(vctadeb)		&&+ALLTRiM(m.CodCtc)
IF !FOUND()
	IF f_appd()
		REPLACE Periodo WITH m.Periodo,;
		        nummes  WITH m.nummes,;
				tipdoc  WITH 'R/I',;
				numref  WITH m.numRi ,;
				tipo    WITH 'D',;
				fecref  WITH m.fecRi,;
				CodCtc  WITH ALLTRiM(m.CodCtc),;
				CodCad  WITH m.CodCad,;
				codpart WITH wCodPart,;
				ctadeb  WITH w_PreD ,;
			    ctahab  WITH SPACE(10),;
				cuenta  WITH w_PreD ,;
			    valdeb  WITH nTot ,;
			    valhab  WITH 0
	ENDIF
	UNLOCK
ELSE
	IF RLOCK()
		REPLACE Periodo WITH m.Periodo,;
		        nummes  WITH m.nummes,;
				tipdoc  WITH 'R/I',;
				numref  WITH m.numRi ,;
				tipo    WITH 'D',;
				fecref  WITH m.fecRi,;
				CodCtc  WITH ALLTRiM(m.CodCtc),;
				CodCad  WITH m.CodCad,;
				codpart WITH wCodPart,;
				ctadeb  WITH w_PreD ,;
			    ctahab  WITH SPACE(10),;
				cuenta  WITH w_PreD ,;
			    valdeb  WITH nTot ,;
			    valhab  WITH 0
	ENDIF
    UNLOCK
ENDIF    

SEEK 'H'+m.Periodo+ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+ALLTRiM(w_PreH)
*SEEK 'H'+m.Periodo+ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+ALLTRiM(vctahab)		&&ALLTRiM(m.CodCtc)
IF !FOUND()
	IF f_appd()
		REPLACE Periodo WITH m.Periodo,;
				nummes WITH m.nummes,;
				tipdoc WITH 'R/I',;
				numref WITH m.numRi ,;
				tipo WITH 'H',;
				fecRef WITH m.fecRi,;
				CodCtc WITH ALLTRiM(m.CodCtc),;
				CodCad WITH m.CodCad,;
				codpart WITH wCodPart,;
		        ctadeb WITH SPACE(12),;
				ctahab WITH w_PreH ,;
				cuenta WITH w_PreH ,;
				valdeb WITH 0 ,;
				valhab WITH nTot
	ENDIF
	UNLOCK
ELSE
	IF RLOCK()
		REPLACE Periodo WITH m.Periodo,;
				nummes  WITH m.nummes,;
				tipdoc  WITH 'R/I',;
				numref  WITH m.numRi ,;
				tipo    WITH 'H',;
				fecRef  WITH m.fecRi,;
				CodCtc  WITH ALLTRiM(m.CodCtc),;
				CodCad  WITH m.CodCad,;
				codpart WITH wCodPart,;
		        ctadeb  WITH SPACE(12),;
				ctahab  WITH w_PreH ,;
				cuenta  WITH w_PreH ,;
				valdeb  WITH 0 ,;
				valhab  WITH nTot
	ENDIF
	UNLOCK
ENDIF	
SET ORDER TO (cOrd)
SELE (AS)
ACTIVATE WINDOW wind_6
	@ 00,08  SAY 'Cuentas '
	@ 00,18  SAY 'Debe '
	@ 00,34  SAY 'Haber '
	@ 01,04  SAY w_PreD PICTURE '!!!!!!!!!!!!' 
	@ 01,18  SAY nTot  PICTURE '999,999,999.99' 
	@ 02,12  SAY w_PreH PICTURE '!!!!!!!!!!!!' 
	@ 02,34  SAY nTot  PICTURE '999,999,999.99' 
	WAIT ' '
	DEACTIVATE WINDOW wind_6
	vValdeb = nTot  
	vValhab = nTot 
RETURN

PROCEDURE ComPreF
*----------------
PRIVATE i,j
AS=ALIAS()
nTotD = 0
nTotH = 0
lMuestra = .F.
*wait wind type("acadenl")
SELE AstPre
cOrd = ORDER()
SET ORDER TO astpre5
IF !SEEK(ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+'FAC')
	IF type("acadenl")#'L'
		laCadEnl = ALEN(acadenl)/9
		FOR i = 1 TO laCadEnl
			IF acadenl(i,1) = 'F'
				SELE AstPre
				IF !SEEK(m.NumMes+m.NumRI+'FAC')
					IF f_appd()
						REPLACE Periodo WITH m.Periodo,;
						        nummes  WITH m.nummes,;
								tipdoc  WITH 'FAC',;
								numref  WITH m.numRi ,;
								tipo    WITH 'D',;
								fecref  WITH m.fecRi,;
								CodCtc  WITH ALLTRiM(m.CodCtc),;
								CodCad  WITH m.CodCad,;
								ctadeb  WITH aCadenl(i,4),;
							    ctahab  WITH SPACE(10),;
								cuenta  WITH aCadenl(i,4),;
						    	valdeb  WITH aCadenl(i,8),;
							    valhab  WITH 0
					ENDIF
					IF f_appd()
						REPLACE Periodo WITH m.Periodo,;
								nummes WITH m.nummes,;
								tipdoc WITH 'FAC',;
								numref WITH m.numRi ,;
								tipo WITH 'H',;
								fecRef WITH m.fecRi,;
								CodCtc WITH ALLTRiM(m.CodCtc),;
								CodCad WITH m.CodCad,;
		    				    ctadeb WITH SPACE(12),;
								ctahab WITH aCadEnl(i,5),;
								cuenta WITH aCadEnl(i,5),;
								valdeb WITH 0 ,;
								valhab WITH aCadEnl(i,8)
					ENDIF
					lMuestra = .T.
				ELSE
					FOR j = 1 to 2
						IF j = 1
							xNvo = .T.
							IF SEEK(m.NumMes+m.NumRI+'FAC') AND !EMPTY(aCadenl(i,4))
								SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'FAC'
									IF CtaDeb = aCadEnl(i,4) AND Tipo = 'D'
										REPLACE ValDeb WITH ValDeb + aCadEnl(i,8)
										lMuestra = .T.
										xNvo = .F.
										LOOP
									ENDIF
								ENDSCAN
							ENDIF
							IF xNvo AND !EMPTY(aCadenl(i,4))
								IF f_appd()
									REPLACE Periodo WITH m.Periodo,;
									        nummes  WITH m.nummes,;
											tipdoc  WITH 'FAC',;
											numref  WITH m.numRi ,;
											tipo    WITH 'D',;
											fecref  WITH m.fecRi,;
											CodCtc  WITH ALLTRiM(m.CodCtc),;
											CodCad  WITH m.CodCad,;
											ctadeb  WITH aCadenl(i,4),;
										    ctahab  WITH SPACE(10),;
											cuenta  WITH aCadenl(i,4),;
										    valdeb  WITH aCadenl(i,8),;
										    valhab  WITH 0
								ENDIF
								lMuestra = .T.
							ENDIF
						ENDIF
						IF j = 2
							xNvo = .T.
							IF SEEK(m.NumMes+m.NumRI+'FAC') AND !EMPTY(aCadenl(i,5))
								SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'FAC'
									IF CtaHab = aCadEnl(i,5) AND Tipo = 'H'
										REPLACE ValHab WITH ValHab + aCadEnl(i,8)
										lMuestra = .T.
										xNvo = .F.
										LOOP
									ENDIF
								ENDSCAN
							ENDIF
							IF xNvo AND !EMPTY(aCadenl(i,5))
								IF f_appd()
									REPLACE Periodo WITH m.Periodo,;
											nummes WITH m.nummes,;
											tipdoc WITH 'FAC',;
											numref WITH m.numRi ,;
											tipo WITH 'H',;
											fecRef WITH m.fecRi,;
											CodCtc WITH ALLTRiM(m.CodCtc),;
											CodCad WITH m.CodCad,;
			    						    ctadeb WITH SPACE(12),;
											ctahab WITH aCadEnl(i,5),;
											cuenta WITH aCadEnl(i,5),;
											valdeb WITH 0 ,;
											valhab WITH aCadEnl(i,8)
								ENDIF
								lMuestra = .T.
							ENDIF
						ENDIF
					ENDFOR
				ENDIF
			ENDIF
		ENDFOR
	ENDIF
ELSE
	IF SEEK(ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+'FAC')
		SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'FAC'
			IF Tipo = 'D'
				REPLACE ValDeb WITH 0
			ELSE
				REPLACE ValHab WITH 0
			ENDIF
		ENDSCAN
	ENDIF
	IF type("acadenl")#'L'
		laCadEnl = ALEN(acadenl)/9
		FOR i = 1 TO laCadEnl
			IF acadenl(i,1) = 'F'
				SELE AstPre
				FOR j = 1 to 2
					IF j = 1
						xNvo = .T.
						IF SEEK(m.NumMes+m.NumRI+'FAC') AND !EMPTY(aCadenl(i,4))
							SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'FAC'
								IF CtaDeb = aCadEnl(i,4) AND Tipo = 'D'
									REPLACE ValDeb WITH ValDeb + aCadEnl(i,8)
									lMuestra = .T.
									xNvo = .F.
									LOOP
								ENDIF
							ENDSCAN
						ENDIF
						IF xNvo AND !EMPTY(aCadenl(i,4))
							IF f_appd()
								REPLACE Periodo WITH m.Periodo,;
								        nummes  WITH m.nummes,;
										tipdoc  WITH 'FAC',;
										numref  WITH m.numRi ,;
										tipo    WITH 'D',;
										fecref  WITH m.fecRi,;
										CodCtc  WITH ALLTRiM(m.CodCtc),;
										CodCad  WITH m.CodCad,;
										ctadeb  WITH aCadenl(i,4),;
									    ctahab  WITH SPACE(10),;
										cuenta  WITH aCadenl(i,4),;
									    valdeb  WITH aCadenl(i,8),;
									    valhab  WITH 0
							ENDIF
							lMuestra = .T.
						ENDIF
					ENDIF
					IF j = 2
						xNvo = .T.
						IF SEEK(m.NumMes+m.NumRI+'FAC') AND !EMPTY(aCadenl(i,5))
							SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'FAC'
								IF Ctahab = aCadEnl(i,5) AND Tipo = 'H'
									REPLACE ValHab WITH ValHab + aCadEnl(i,8)
									lMuestra = .T.
									xNvo = .F.
									LOOP
								ENDIF
							ENDSCAN
						ENDIF
						IF xNvo AND !EMPTY(aCadenl(i,5))
							IF f_appd()
								REPLACE Periodo WITH m.Periodo,;
										nummes WITH m.nummes,;
										tipdoc WITH 'FAC',;
										numref WITH m.numRi ,;
										tipo WITH 'H',;
										fecRef WITH m.fecRi,;
										CodCtc WITH ALLTRiM(m.CodCtc),;
										CodCad WITH m.CodCad,;
			    					    ctadeb WITH SPACE(12),;
										ctahab WITH aCadEnl(i,5),;
										cuenta WITH aCadEnl(i,5),;
										valdeb WITH 0 ,;
										valhab WITH aCadEnl(i,8)
							ENDIF
							lMuestra = .T.
						ENDIF
					ENDIF
				ENDFOR
			ENDIF
		ENDFOR
	ENDIF
ENDIF

IF lMuestra = .T.
	IF SEEK(ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+'FAC')
		SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'FAC'
			IF Tipo = 'D'
				w_PreD = CtaDeb
				nTotD  = nTotD + ValDeb
			ELSE
				w_PreH = CtaHab
				nTotH  = nTotH + ValHab
			ENDIF
		ENDSCAN
	ENDIF

	SET ORDER TO (cOrd)
	SELE (AS)
	ACTIVATE WINDOW wind_6
		@ 00,08  SAY 'Cuentas '
		@ 00,18  SAY 'Debe '
		@ 00,34  SAY 'Haber '
		@ 01,04  SAY w_PreD PICTURE '!!!!!!!!!!!!' 
		@ 01,18  SAY nTotD  PICTURE '999,999,999.99' 
		@ 02,12  SAY w_PreH PICTURE '!!!!!!!!!!!!' 
		@ 02,34  SAY nTotH  PICTURE '999,999,999.99'
		WAIT ' '
		DEACTIVATE WINDOW wind_6
		vValdeb = nTotD
		vValhab = nTotH
	
ENDIF

SELE AstPre
SET ORDER TO (cOrd)
SELE (AS)

RETURN


*PROCEDURE ComPreF
*----------------
PRIVATE i,j

SELE AstPre
cOrd = ORDER()
SET ORDER TO astpre5
IF !SEEK(ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+'FAC')
	laCadEnl = ALEN(acadenl)/8
	FOR i = 1 TO laCadEnl
		IF acadenl(i,1) = 'R'
			SELE AstPre
			IF !SEEK(m.NumMes+m.NumRI+'FAC')
				IF f_appd()
					REPLACE Periodo WITH m.Periodo,;
					        nummes  WITH m.nummes,;
							tipdoc  WITH 'R/I',;
							numref  WITH m.numRi ,;
							tipo    WITH 'D',;
							fecref  WITH m.fecRi,;
							CodCtc  WITH ALLTRiM(m.CodCtc),;
							CodCad  WITH m.CodCad,;
							ctadeb  WITH aCadenl(i,4),;
						    ctahab  WITH SPACE(10),;
							cuenta  WITH aCadenl(i,4),;
						    valdeb  WITH aCadenl(i,8),;
						    valhab  WITH 0
						    
*							codpart WITH wCodPart
				ENDIF
				IF f_appd()
					REPLACE Periodo WITH m.Periodo,;
							nummes WITH m.nummes,;
							tipdoc WITH 'FAC',;
							numref WITH m.numRi ,;
							tipo WITH 'H',;
							fecRef WITH m.fecRi,;
							CodCtc WITH ALLTRiM(m.CodCtc),;
							CodCad WITH m.CodCad,;
		    			    ctadeb WITH SPACE(12),;
							ctahab WITH aCadEnl(i,5),;
							cuenta WITH aCadEnl(i,5),;
							valdeb WITH 0 ,;
							valhab WITH aCadEnl(i,8)
							
*							codpart WITH wCodPart
				ENDIF
			ELSE
				FOR j = 1 to 2
					IF j = 1
						SEEK m.Periodo+m.NumMes+m.NumRI
						xNvo = .T.
						SCAN WHILE Periodo+NumMes+NumRef = m.Periodo+m.NumMes+m.NumRI
							IF CodCta = aCadEnl(i,2) AND TipCta = 'D'
								REPLACE ValDeb WITH ValDeb + aCadEnl(i,8)
								xNvo = .F.
								LOOP
							ENDIF
						ENDSCAN
						IF xNvo
							IF f_appd()
								REPLACE Periodo WITH m.Periodo,;
								        nummes  WITH m.nummes,;
										tipdoc  WITH 'FAC',;
										numref  WITH m.numRi ,;
										tipo    WITH 'D',;
										fecref  WITH m.fecRi,;
										CodCtc  WITH ALLTRiM(m.CodCtc),;
										CodCad  WITH m.CodCad,;
										ctadeb  WITH aCadenl(i,4),;
									    ctahab  WITH SPACE(10),;
										cuenta  WITH aCadenl(i,4),;
									    valdeb  WITH aCadenl(i,8),;
									    valhab  WITH 0
							ENDIF
						ENDIF
					ENDIF
					IF j = 2
						SEEK m.Periodo+m.NumMes+m.NumRI
						xNvo = .T.
						SCAN WHILE Periodo+NumMes+NumRef = m.Periodo+m.NumMes+m.NumRI
							IF CodCta = aCadEnl(i,3) AND TipCta = 'H'
								REPLACE ValHab WITH ValHab + aCadEnl(i,8)
								xNvo = .F.
								LOOP
							ENDIF
						ENDSCAN
						IF xNvo
							IF f_appd()
								REPLACE Periodo WITH m.Periodo,;
										nummes WITH m.nummes,;
										tipdoc WITH 'FAC',;
										numref WITH m.numRi ,;
										tipo WITH 'H',;
										fecRef WITH m.fecRi,;
										CodCtc WITH ALLTRiM(m.CodCtc),;
										CodCad WITH m.CodCad,;
		    						    ctadeb WITH SPACE(12),;
										ctahab WITH aCadEnl(i,5),;
										cuenta WITH aCadEnl(i,5),;
										valdeb WITH 0 ,;
										valhab WITH aCadEnl(i,8)
							ENDIF
						ENDIF
					ENDIF
				ENDFOR
			ENDIF
		ENDIF
	ENDFOR
ENDIF

SET ORDER TO (cOrd)
SELE (AS)
ACTIVATE WINDOW wind_6
	@ 00,08  SAY 'Cuentas '
	@ 00,18  SAY 'Debe '
	@ 00,34  SAY 'Haber '
	@ 01,04  SAY w_PreD PICTURE '!!!!!!!!!!!!' 
	@ 01,18  SAY nTot  PICTURE '999,999,999.99' 
	@ 02,12  SAY w_PreH PICTURE '!!!!!!!!!!!!' 
	@ 02,34  SAY nTot  PICTURE '999,999,999.99' 
	WAIT ' '
	DEACTIVATE WINDOW wind_6
	vValdeb = nTot  
	vValhab = nTot 
RETURN

*PROCEDURE ComPreF
*---------------
AS=ALIAS()
*BROWS

w_PreDF =   PADR("8201"+IIF(m.CodFte="09","0201","0101"),15,"0")
w_PreHF =   PADR("8101"+IIF(m.CodFte="09","0201","0101"),15,"0")

*w_PreDF = PADR(w_PreDF,10,"0")
*w_PreHF = PADR(w_PreHF,10,"0")
SELE IteRI
SEEK m.Periodo+m.NumMes+m.NumRI
nTot = 0
IF FOUND()
	SCAN FOR Periodo = m.Periodo AND NumMes = m.NumMes AND NumRi = m.NumRI AND Tipo="P"
		nTot = nTot + ImpParc
	ENDSCAN
ENDIF

SELE AstPre
cOrd = ORDER()
SET ORDER TO astpre22

SEEK 'D'+m.Periodo+ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+ALLTRiM(w_PreDF)
*SEEK 'D'+m.Periodo+ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+ALLTRiM(vctadeb)		&&+ALLTRiM(m.CodCtc)
IF !FOUND()
	IF f_appd()
		REPLACE Periodo WITH m.Periodo,;
		        nummes  WITH m.nummes,;
				tipdoc  WITH 'FAC',;
				numref  WITH m.numRi ,;
				tipo    WITH 'D',;
				fecref  WITH m.fecRi,;
				CodCtc  WITH ALLTRiM(m.CodCtc),;
				CodCad  WITH m.CodCad,;
				codpart WITH wCodPart,;
				ctadeb  WITH w_PreDF ,;
			    ctahab  WITH SPACE(15),;
				cuenta  WITH w_PreDF ,;
			    valdeb  WITH nTot ,;
			    valhab  WITH 0
	ENDIF
	UNLOCK
ELSE
	IF RLOCK()
		REPLACE Periodo WITH m.Periodo,;
		        nummes  WITH m.nummes,;
				tipdoc  WITH 'FAC',;
				numref  WITH m.numRi ,;
				tipo    WITH 'D',;
				fecref  WITH m.fecRi,;
				CodCtc  WITH ALLTRiM(m.CodCtc),;
				CodCad  WITH m.CodCad,;
				codpart WITH wCodPart,;
				ctadeb  WITH w_PreDF ,;
			    ctahab  WITH SPACE(15),;
				cuenta  WITH w_PreDF ,;
			    valdeb  WITH nTot ,;
			    valhab  WITH 0
	ENDIF
    UNLOCK
ENDIF    

SEEK 'H'+m.Periodo+ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+ALLTRiM(w_PreHF)
*SEEK 'H'+m.Periodo+ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+ALLTRiM(vctahab)		&&ALLTRiM(m.CodCtc)
IF !FOUND()
	IF f_appd()
		REPLACE Periodo WITH m.Periodo,;
				nummes WITH m.nummes,;
				tipdoc WITH 'FAC',;
				numref WITH m.numRi ,;
				tipo WITH 'H',;
				fecRef WITH m.fecRi,;
				CodCtc WITH ALLTRiM(m.CodCtc),;
				CodCad WITH m.CodCad,;
				codpart WITH wCodPart,;
		        ctadeb WITH SPACE(15),;
				ctahab WITH w_PreHF ,;
				cuenta WITH w_PreHF ,;
				valdeb WITH 0 ,;
				valhab WITH nTot
	ENDIF
	UNLOCK
ELSE
	IF RLOCK()
		REPLACE Periodo WITH m.Periodo,;
				nummes  WITH m.nummes,;
				tipdoc  WITH 'FAC',;
				numref  WITH m.numRi ,;
				tipo    WITH 'H',;
				fecRef  WITH m.fecRi,;
				CodCtc  WITH ALLTRiM(m.CodCtc),;
				CodCad  WITH m.CodCad,;
				codpart WITH wCodPart,;
		        ctadeb  WITH SPACE(15),;
				ctahab  WITH w_PreHF ,;
				cuenta  WITH w_PreHF ,;
				valdeb  WITH 0 ,;
				valhab  WITH nTot
	ENDIF
	UNLOCK
ENDIF	
SET ORDER TO (cOrd)
SELE (AS)
ACTIVATE WINDOW wind_6
	@ 00,08  SAY 'Cuentas '
	@ 00,18  SAY 'Debe '
	@ 00,34  SAY 'Haber '
	@ 01,04  SAY w_PreDF PICTURE '!!!!!!!!!!!!!!!'
	@ 01,18  SAY nTot  PICTURE '999,999,999.99'
	@ 02,12  SAY w_PreHF PICTURE '!!!!!!!!!!!!!!!'
	@ 02,34  SAY nTot  PICTURE '999,999,999.99'
	WAIT ' '
	DEACTIVATE WINDOW wind_6
	vValdeb = nTot
	vValhab = nTot
RETURN


*PROCEDURE ComPreF
*---------------
AS=ALIAS()

vCtaDeb = PADR(ALLTRIM(DFacAPr),10,"0")
vCtaHab = PADR(ALLTRIM(HFacApr),10,"0")

*vCtaDeb = PADR(ALLTRIM(DFacAPr)+IIF(m.Codfte='13','10','07'),10,"0")
*vCtaHab = PADR(ALLTRIM(HFacApr)+IIF(m.Codfte='13','10','07'),10,"0")

SELE IteRI
SEEK m.Periodo+m.NumMes+m.NumRI
nTot = 0
IF FOUND()
	SCAN FOR Periodo = m.Periodo AND NumMes = m.NumMes AND NumRi = m.NumRI AND Tipo="P"
		nTot = nTot + ImpParc
	ENDSCAN
ENDIF

SELE AstPre
cOrd = ORDER()
SET ORDER TO astpre5

SEEK ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+"FAC"+"D"
IF !FOUND()
	IF f_appd()
		REPLACE Periodo WITH m.Periodo,;
				nummes  WITH m.nummes,;
				tipdoc  WITH 'FAC',;
				numref  WITH m.numRi ,;
				cuenta  WITH vctadeb,;
				tipo    WITH 'D',;
				fecref  WITH m.fecRi,;
				CodCtc  WITH ALLTRiM(m.CodCtc),;
				CodCad  WITH m.CodCad,;
				codpart WITH wCodPart,;
				ctadeb  WITH vctadeb ,;
				ctahab  WITH SPACE(10),;
				valdeb  WITH nTot ,;
				valhab  WITH 0
	ENDIF
	UNLOCK
 ELSE
	IF RLOCK()
		REPLACE Periodo WITH m.Periodo,;
				nummes  WITH m.nummes,;
				tipdoc  WITH 'FAC',;
				numref  WITH m.numRi ,;
				cuenta  WITH vctadeb,;
				tipo    WITH 'D',;
				fecref  WITH m.fecRi,;
				CodCtc  WITH ALLTRiM(m.CodCtc),;
				CodCad  WITH m.CodCad,;
				codpart WITH wCodPart,;
				ctadeb WITH vctadeb ,;
				ctahab WITH SPACE(10),;
				valdeb WITH nTot ,;
				valhab WITH 0
	ENDIF
    UNLOCK
ENDIF    

SEEK ALLTRiM(m.nummes)+ALLTRiM(m.numRi)+"FAC"+"H"
IF !FOUND()
	IF f_appd()
		REPLACE Periodo WITH m.Periodo,;
				nummes WITH m.nummes,;
				tipdoc WITH 'FAC',;
				numref WITH m.numRi ,;
				cuenta WITH vctahab,;
				tipo WITH 'H',;
				fecRef WITH m.fecRi,;
				CodCtc WITH ALLTRiM(m.CodCtc),;
				CodCad WITH m.CodCad,;
				codpart WITH wCodPart,;
		        ctadeb WITH SPACE(10),;
				ctahab WITH vctahab ,;
				valdeb WITH 0 ,;
				valhab WITH nTot
	ENDIF
	UNLOCK
 ELSE
	IF RLOCK()
		REPLACE Periodo WITH m.Periodo,;
				nummes WITH m.nummes,;
				tipdoc WITH 'FAC',;
				numref WITH m.numRi ,;
				cuenta WITH vctahab,;
				tipo WITH 'H',;
				fecRef WITH m.fecRi,;
				CodCtc WITH ALLTRiM(m.CodCtc),;
				CodCad WITH m.CodCad,;
				codpart WITH wCodPart,;
				ctadeb WITH SPACE(10),;
				ctahab WITH vctahab ,;
				valdeb WITH 0 ,;
				valhab WITH nTot
	ENDIF
	UNLOCK
ENDIF
SET ORDER TO (cOrd)
SELE (AS)
DEFINE WINDOW wAstPreF FROM 10,10 TO 15,70 ;
 TITLE ' ASIENTOS PRESUPUESTALES DE FACTURA' COLOR SCHEME 02
ACTIVATE WINDOW wAstPreF
	@ 00,08  SAY 'Cuentas '
	@ 00,18  SAY 'Debe '
	@ 00,34  SAY 'Haber '
	@ 01,04  SAY vctadeb PICTURE '!!!!!!!!!!!!' 
	@ 01,18  SAY nTot  PICTURE '999,999,999.99' 
	@ 02,12  SAY vctahab PICTURE '!!!!!!!!!!!!' 
	@ 02,34  SAY nTot  PICTURE '999,999,999.99' 
	WAIT ' '
	DEACTIVATE WINDOW wAstPreF
	RELEASE WINDOWS wAstPreF
RETURN


FUNCTION dismem
*---------------
SET MEMOWIDTH TO 100
RETURN

FUNCTION GLOSA
*--------------
PUBLIC _q
SET MEMOWIDTH TO 60
_Q=UPPER(ALLTRiM(MLINE(Ri.Observ,3)))
RETURN _q


PROCEDURE imp_Ri
*---------------
PUBLIC NUM_C
NUM_C=1
SET ESCAPE ON
ON ESCAPE STORE .F. TO PRiNTING
_DEST = 'Impresora'
P_FIL = SPACE(8)
_Dest1 = 2
P_FIL = sys(3)+".LST"
IMPRE = (_DEST='Impresora')
PRiNTING = .T.
DEFINE WINDOW Numcop FROM 20,50 TO 22,79 DOUBLE
ACTIVATE WINDOW Numcop
@ 0,3 SAY "N§ de Copias : " GET NUM_C PICTURE "99" VALID NUM_C>0 AND NUM_C<99
READ
RELEASE WINDOW Numcop
IF LASTKEY()=27
   RETUR
ENDIF 
IF IMPRE
   IF !EMPTY(LEFT(SYS(0),15))
     IF !YESNO("¨ImpRime en impresora local?  <NO = IMPRESORA DE RED>")
       **-- Impresora de red.
       SET PRiNTER TO \\IBM_PC\PRiNTQ_0=LPT1
       SET PRiNTER TO \\SPOOLER\NB
     ENDIF
   ENDIF
   IF !READY2PR()
       PRiNTING = .F.
   ENDIF
ENDIF   
IF PRiNTING
  IF IMPRE
   	 SET DEVICE TO PRiNT
     SET PRiNTER TO &p_fil
     DO LISRi WITH NUM_C
     SET PRiNTER TO
     IF READY2PR() 
     	FOR I=1 TO NUM_C
        	!TYPE &P_FIL >PRN
	    ENDFOR	
     ENDIF
     ERASE &p_fil
   ENDIF
 ELSE
   DO STANDBY WITH 'EL REPORTE HA SIDO CANCELADO.'
 ENDIF
 SET DEVICE TO SCREEN
 SELE Ri
RETURN


FUNCTION PidApBd
*---------------
 DEFINE WINDOW Wind_7 FROM 10,20 TO 15,60  DOUBLE ;
 TITLE " Asientos para B/D " COLOR SCHEME 10
 ACTIVATE WINDOW Wind_7
 alia  = ALIAS()
 SELECT ITERI
 SEEK ALLTRIM(m.periodo)+ALLTRiM(m.nummes)+m.numRi
 IF FOUND()
 	vnroref = Iteri.DocRef &&Nro de la Boleta de Dep¢sito
 	SELECT ASTPAT
    Vord = ORDER()
    SET ORDER TO AstPat7
    SEEK ALLTRIM(m.nummes)+ALLTRIM(VnroRef)+ALLTRIM(m.CodCtc)
    IF FOUND()
       Vdeb=CodCta         && ORIGINAL
       SKIP                && ORIGINAL 
       Vhab=CodCta         && ORIGINAL
    ENDIF
    SELECT ASTPAT
    SET ORDER TO (Vord)   
 ENDIF   
 @ 1, 10 SAY "Debe"
 @ 1, 25 SAY "Haber"
 @ 2, 10 GET vdeb VALID val_fun('Cuenta','Cuenta',"Cuenta+' '+DescRi",vdeb,1)
 @ 2, 25 GET vhab VALID val_fun('Cuenta','Cuenta',"Cuenta+' '+DescRi",vhab,1)
 READ VALID Val_read()
 DEACTIVATE WINDOW Wind_7
 SELECT (alia)
 RETURN vdeb+vhab


PROCEDURE ingap1   && Ingresa asientos patrimoniales para boletas de dep¢sito
*-------------------
PARAMETERS vasiento
ACTIVATE SCREEN
HIDE MENU mMenu
vTempo = '°°°°°°°°F5->Agregar°°°°°°°°°°°°°°F8->Eliminar°°°°°°°°°°°°°°F10->Terminar°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
ON KEY LABEL F5 DO AgRite
ON KEY LABEL F8 DO EliIte
ON KEY LABEL F10 KEYBOARD CHR(23)

SELE ASTPAT
xord = ORDER()
SET ORDER TO ASTPAT7

SELECT IteRi
SEEK m.Periodo+ALLTRiM(m.NumMes) + ALLTRiM(m.NumRi)
vpeRiodo = m.Periodo
vnummes  = m.nummes
vnumRi   = m.numRi
SCAN WHILE vPERiODO+ALLTRiM(vNumMes) + ALLTRiM(vNumRi) =PERiODO+ALLTRiM(NumMes) + ALLTRiM(NumRi)
	SELECT Movbco
	SEEK ALLT(IteRi.nummes)+ALLTRIM(IteRi.docRef)
	IF !FOUND()
		APPEND BLANK
		REPLACE PeRiodo 	WITH vpeRiodo ,;
				Nummes  	WITH vnummes ,;
				NummesC 	WITH vnummes ,;
				numero  	WITH Iteri.docRef ,;
				Transa  	WITH 'ABO' ,;
				Fecha   	WITH Iteri.fecdep,;
				FechaC  	WITH iteri.fecdep,;
				Tipdoc  	WITH 'B/D' ,;
				Numref  	WITH IteRi.boldep ,;
				codfte  	WITH m.codfte ,;
				codctc  	WITH m.CodCtc ,;
				nombre  	WITH 'DEPOSITO AUTOMATICO R/I '+m.numRi+'.'+m.nummes ,;
				forma   	WITH 'EF' ,;
				Monto   	WITH IteRi.impparc ,;
				codcad  	WITH m.codcad ,;
				perRi   	WITH IteRi.peRiodo,;
				nummesRi    WITH IteRi.nummes ,;
				numRi   	WITH IteRi.numRi ,;
				estado      WITH '00' ,;
				motivo      WITH '19',;				
				codban   	WITH wbanco,;
				usuario     WITH vUser_ID
				
	ELSE
		REPLACE PeRiodo 	WITH IteRi.peRiodo ,;
				Fecha   	WITH iteri.fecdep ,;
				FechaC  	WITH iteri.fecdep,;
				Numref  	WITH IteRi.boldep ,;
				codfte  	WITH m.codfte ,;
				codctc  	WITH m.CodCtc ,;
				nombre  	WITH 'DEPOSITO AUTOMATICO R/I '+m.numRi+'.'+m.nummes ,;
				Monto   	WITH IteRi.impparc ,;
				codcad  	WITH m.codcad,;
				perRi   	WITH IteRi.peRiodo,;
				nummesRi    WITH IteRi.nummes ,;
				numRi   	WITH IteRi.numRi ,;
				estado      WITH '00' ,;
				motivo      WITH '19',;				
				Codban      WITH wbanco,;
				usuario     WITH vUser_ID
	ENDIF		
	SELECT Astpat
	SEEK ALLT(IteRi.Nummes)+ALLTRIM(Iteri.DocRef)+m.CodCtc
	IF !FOUND()
		APPEND BLANK
		REPLACE PeRiodo WITH IteRi.peRiodo ,;
				tipdoc  WITH 'B/D' ,; 
				fecha   WITH iteri.fecdep ,;
				Nummes  WITH IteRi.Nummes ,;
				Numref  WITH IteRi.DocRef;
				tipcta  WITH 'D',;
				codctc  WITH m.CodCtc ,;
				codcta  WITH LEFT(vasiento,12),;
				Mtodeb  WITH IteRi.impparc ,;
				tipctc  WITH w_tipctc
		APPEND BLANK
		REPLACE PeRiodo WITH IteRi.peRiodo ,;
				tipdoc  WITH 'B/D' ,; 
				fecha   WITH iteri.fecdep ,;
				Nummes  WITH IteRi.Nummes ,;
				Numref  WITH IteRi.DocRef ,;
				tipcta  WITH 'H',;
				codctc  WITH m.CodCtc ,;
				codcta  WITH RiGHT(vasiento,12),;
				Mtohab  WITH IteRi.impparc ,;
				tipctc  WITH w_tipctc
	ELSE
		REPLACE PeRiodo WITH IteRi.peRiodo ,;
				tipdoc  WITH 'B/D' ,; 
				fecha   WITH iteri.fecdep ,;
				Nummes  WITH IteRi.Nummes ,;
				Numref  WITH IteRi.DocRef,;
				tipcta  WITH 'D',;
				codctc  WITH m.CodCtc ,;
				codcta  WITH LEFT(vasiento,12),;
				Mtodeb  WITH IteRi.impparc ,;
				tipctc  WITH w_tipctc
		SKIP
		REPLACE PeRiodo WITH IteRi.peRiodo ,;
				tipdoc  WITH 'B/D' ,; 
				fecha   WITH iteri.fecdep ,;
				Nummes  WITH IteRi.Nummes ,;
				Numref  WITH IteRi.DocRef,;
				tipcta  WITH 'H',;
				codctc  WITH m.CodCtc ,;
				codcta  WITH RiGHT(vasiento,12),;
				Mtohab  WITH IteRi.impparc ,;
				tipctc  WITH w_tipctc
	ENDIF
	SELECT IteRi
ENDSCAN	
SELECT Astpat
SET ORDER TO (xord)
SELE RI
RETURN

FUNCTION PidApRev
*---------------
 DEFINE WINDOW Wind_7 FROM 10,10 TO 18,70  DOUBLE ;
 TITLE " Asientos para Reversiones " COLOR SCHEME 10
 vdeb = SPACE(12)
 vhab = SPACE(12)
 *vscta= SPACE(8)
 vofig= SPACE(02)
 *vctc = SPACE(14)
 vctc = '         '
 vscta= '        '
 vofig= '01'
 ACTIVATE WINDOW Wind_7
 alia  = ALIAS()
 STORE SPACE(1) TO vgas
*SELE Ri
*vgas  = tipgas
 SELECT ITERI
 SEEK ALLTRIM(m.periodo)+ALLTRiM(m.nummes)+m.numRi
 IF FOUND()
 	vnroref = Iteri.DocRef &&Nro de la Boleta de Dep¢sito
 	SELECT ASTPAT
    Vord = ORDER()
    SET ORDER TO AstPat15
    SEEK m.nummes+ALLT(VnroRef)+m.codctc
    
    IF FOUND()
     IF m.numri <='0663'
       REPLACE codcta WITH vdeb
       Vscta =  ALLTRIM(numdoc)
       Vofig =  ALLTRIM(doc)
       Vctc  =  ALLTRIM(codctc)
       skip
       REPLACE codcta WITH vhab
     ELSE
       Vdeb  =  CodCta
       Vscta =  ALLTRIM(numdoc)
       Vofig =  ALLTRIM(doc)
       Vctc  =  ALLTRIM(codctc)
       SKIP
       Vhab=CodCta
     ENDIF
    ENDIF
    ON KEY LABEL ESC DO escap
*deFINE WINDOW Wind_7a FROM 12,12 TO 16,68  DOUBLE ;
 *TITLE " Tipo de Gasto " COLOR SCHEME 10
*ACTIVATE WINDOW Wind_7a
*@ 1,05 SAY "Gasto            :" GET vgas  VALID Val_Para(vgas,'CATGAS',' ',24,20)
*READ VALID Val_read()
  * DEACTIVATE WINDOW Wind_7a
    vdeb=IIF(ALLT(m.tipri)='04','302010101000',IIF(ALLTRIM(vgas)='5','751010101000','302010101000'))
  *  vhab='101010101000'
    vhab='            '
*   SELE Ri
 *  REPLACE Tipgas WITH ALLTRIM(vgas)
	ON KEY LABEL ESC
    SELECT ASTPAT
    SET ORDER TO (Vord)   
 ENDIF 	
 @ 1, 05 SAY "Debe            :" GET vdeb  VALID val_fun('Cuenta','Cuenta',"Cuenta+' '+DescRi",vdeb,1)
 @ 2, 05 SAY "Haber           :" GET vhab  VALID val_fun('Cuenta','Cuenta',"Cuenta+' '+DescRi",vhab,1)
 @ 4, 05 SAY "Cuenta Corriente:" GET Vctc  VALID Val_Fun("Caja","Codctc","Codctc+' '+Descri",Vctc,1) 
*@ 5, 05 SAY "SubCuenta       :" GET vscta VALID Val_Fun("SubCta","Subcta","Subcta+' '+Descri",Vscta,1) 
*@ 6, 05 SAY "Oficina Giradora:" GET Vofig VALID Val_Para(vofig,'OFIGIR',' ',20,10)
 READ VALID Val_read()
 DEACTIVATE WINDOW Wind_7
 SELECT (alia)
 RETURN vdeb+vhab

PROCEDURE escap
*--------------
RETURN

PROCEDURE ingap2   && Ingresa asientos patRimoniales para Reversiones
*-------------------
PARAMETERS vasiento
ACTIVATE SCREEN
HIDE MENU mMenu
vTempo = '°°°°°°°°F5->Agregar°°°°°°°°°°°°°°F8->Eliminar°°°°°°°°°°°°°°F10->Terminar°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
ON KEY LABEL F5 DO AgRite
ON KEY LABEL F8 DO EliIte
ON KEY LABEL F10 KEYBOARD CHR(23)

SELECT Astpat
xord = ORDER()
SET ORDER TO Astpat15

SELECT IteRi
SEEK m.Periodo+ALLTRiM(m.NumMes) + ALLTRiM(m.NumRi)
vpeRiodo = m.Periodo
vnummes  = m.nummes
vnumRi   = m.numRi
SCAN WHILE vPERiODO+ALLTRiM(vNumMes) + ALLTRiM(vNumRi) =PERiODO+ALLTRiM(NumMes) + ALLTRiM(NumRi)
	SELECT Rever
	SEEK ALLT(IteRi.nummes)+Allt(Iteri.Docref)
	IF !FOUND()
		APPEND BLANK
		REPLACE PeRiodo 	WITH vpeRiodo ,;
				Nummes  	WITH vnummes ,;
				numRev  	WITH allt(Iteri.DocRef) ,;
				Fecha   	WITH IteRi.fecdep ,;
				Tipo    	WITH 'M' ,;
				TipRev  	WITH wtiprev ,;
				Glosa   	WITH 'DEPOSITO R/I '+m.numRi ,;
				ctates  	WITH m.CodCtc ,;
				Monto   	WITH IteRi.impparc ,;
				Tipdoc  	WITH 'R/I',;
				perdoc  	WITH IteRi.peRiodo,;
				mesdoc      WITH IteRi.nummes ,;
				numdoc  	WITH IteRi.numRi ,;
				estado      WITH '00' ,;
				Codctc      WITH vctc,;
				Codscta     WITH vscta,;
				concepto    WITH '   RUBRO A: REVERSIONES POR MENORES GASTOS.-             '+Ri.observ,;
				flag        WITH 'I',;
				codofg      WITH vofig,;
				usuario     WITH vUser_ID
	ELSE
		REPLACE PeRiodo 	WITH vpeRiodo ,;
				Fecha   	WITH IteRi.fecdep ,;
				Tipo    	WITH 'M' ,;
				TipRev  	WITH wtiprev ,;
				Glosa   	WITH 'DEPOSITO R/I '+m.numRi ,;
				ctates  	WITH m.CodCtc ,;
				Monto   	WITH IteRi.impparc ,;
				Tipdoc  	WITH 'R/I',;
				perdoc  	WITH IteRi.peRiodo,;
				mesdoc      WITH IteRi.nummes ,;
				numdoc  	WITH IteRi.numRi ,;
				estado      WITH '00' ,;
				codscta     WITH vscta,;
				Codctc      WITH vctc,;
				concepto    WITH '   RUBRO A: REVERSIONES POR MENORES GASTOS.-             '+Ri.observ,;
				flag        WITH 'I',;
				codofg      WITH vofig,;
				usuario     WITH vUser_ID
	ENDIF		
	=concepto()
	SELECT Astpat
	SEEK ALLT(IteRi.Nummes)+Iteri.DocRef+vctc
	IF !FOUND()
		APPEND BLANK
		REPLACE PeRiodo WITH IteRi.peRiodo ,;
				tipdoc  WITH 'REV' ,; 
				fecha   WITH IteRi.fecdep ,;
				Nummes  WITH IteRi.Nummes ,;
				Numref  WITH Iteri.Docref ,;
				tipcta  WITH 'D',;
				codctc  WITH vctc ,;
				codcta  WITH LEFT(vasiento,12),;
				Mtodeb  WITH IteRi.impparc ,;
				tipctc  WITH w_tipctc,;
				numdoc  WITH vscta,;
				doc     WITH vofig
		APPEND BLANK
		REPLACE PeRiodo WITH IteRi.peRiodo ,;
				tipdoc  WITH 'REV' ,; 
				fecha   WITH IteRi.fecdep ,;
				Nummes  WITH IteRi.Nummes ,;
				Numref  WITH Iteri.DocRef ,;
				tipcta  WITH 'H',;
				codctc  WITH vctc ,;
				codcta  WITH RiGHT(vasiento,12),;
				Mtohab  WITH IteRi.impparc ,;
				tipctc  WITH w_tipctc,;
				numdoc  WITH vscta,;
				doc     WITH vofig
	ELSE
		REPLACE PeRiodo WITH IteRi.peRiodo ,;
				tipdoc  WITH 'REV' ,; 
				fecha   WITH IteRi.fecdep ,;
				Nummes  WITH IteRi.Nummes ,;
				Numref  WITH Iteri.Docref ,;
				tipcta  WITH 'D',;
				codctc  WITH vctc ,;
				codcta  WITH LEFT(vasiento,12),;
				Mtodeb  WITH IteRi.impparc ,;
				tipctc  WITH w_tipctc,;
				numdoc  WITH vscta,;
				doc     WITH vofig
		SKIP
		REPLACE PeRiodo WITH IteRi.peRiodo ,;
				tipdoc  WITH 'REV' ,; 
				fecha   WITH IteRi.fecdep ,;
				Nummes  WITH IteRi.Nummes ,;
				Numref  WITH Iteri.DocRef ,;
				tipcta  WITH 'H',;
				codctc  WITH vctc ,;
				codcta  WITH RiGHT(vasiento,12),;
				Mtohab  WITH IteRi.impparc,;
				tipctc  WITH w_tipctc,;
				numdoc  WITH vscta,;
				doc     WITH vofig
	ENDIF
	SELECT IteRi
ENDSCAN	
SELECT Astpat
SET ORDER TO (xord)
SELE RI
RETURN

PROCEDURE Tra_Hijo
*---------------------
 ACTIVATE SCREEN
 HIDE MENU mMenu
 vTempo = '°°°°°°°°F5->Agregar°°°°°°°°°°°°°°F8->Eliminar°°°°°°°°°°°°°°F10->Terminar°°°°°°°°'
 DO Logos WITH Rotulo1,vTempo
 ON KEY LABEL F5  DO Agreg1
 ON KEY LABEL F8  DO Elimi_Item
 ON KEY LABEL F10 KEYBOARD CHR(23)
 SELE IteRi
 SEEK ALLTRiM(m.Periodo)+ALLTRiM(m.NumMes)+ALLTRiM(m.NumRi)
 IF !FOUND()
    DO Agreg1
 ENDIF
*   CodPart    :H= 'Partida':V=V_Part(CodPart) AND Val_Niv() :F:W=Tipo='P'

   BROWSE NOAPPEND NODELETE NOMENU NOREFRESH NOOPTIMIZE WINDOW Wind_2;
   KEY m.Periodo+ALLTRiM(m.NumMes) + ALLTRiM(m.NumRi) FIELD ;
   Tipo       :H= 'T':P='@M O,P',;
   CodPart    :H= 'Partida':V=V_Part(CodPart) :F:W=Tipo='P',;
   CODCLA     :H= 'Cla.':V=Val_cla(codpart,CODPART+codcla,'codcla'):F :F:W=Tipo='P' AND !empty(CodPart),;
   aa = IIF(!EMPTY(CodPart),ValAsi1(ALIAS(),CodPart,"8","Descri",'R'),' ') :H='Descripci¢n' :40 :W=!EMPTY(CodPart),;
   DocRef     :H= 'N§ Reversi¢n'  :R :F,;
   FecDep     :H= 'FechaRev.',;
   Glosa      :H= 'Ingreso en': P='@!',;
   ImpParc    :H='Monto' : P='999,999,999,999.99'
   
*   CodPart    :H= 'Partida':V=ValAsi1(ALIAS(),CodPart,'6','codpart','C'):F:W=Tipo='P',;
*   aa = IIF(!EMPTY(CODPART),VAL_ING(SUBSTR(CodPart,10,3),LEFT(CodPart,9),'Z'),' '):H='DescRipci¢n' :40 :W=!EMPTY(CodPart)
*   
*   BROWSE NOAPPEND NODELETE NOMENU NOREFRESH NOOPTIMIZE WINDOW Wind_2;
*	KEY m.Periodo+ALLTRiM(m.NumMes) + ALLTRiM(m.NumRi) FIELD ;
*	Tipo       :H= 'T':P='@M O,P',;
*	CodPart    :H= 'Partida':V=ValAsi1(ALIAS(),CodPart,'6','codpart','C'):F:W=Tipo='P',;
*	BolDep     :H= 'N§ Bol./Dep.': P='@!',;
*	FecDep     :H= 'FechaDep',;
*	Glosa      :H= 'Ingreso en': P='@!',;
*	ImpParc    :H='Monto' : P='999,999,999,999.99',;
*	DocRef     :H='B/D' :R :F

   
   
 SELECT IteRi
 ON KEY LABEL F10
 ON KEY LABEL F8
 ON KEY LABEL F5
 UNLOCK ALL
 SELECT Ri
 ACTIVATE SCREEN
 vTempo = '°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°'
 DO Logos WITH Rotulo1,vTempo
 SHOW MENU mMenu
 RETURN


PROCEDURE Agreg1
*-------------------
SELECT Parma
SEEK "CORREL"+"REVERS"
vNUMERO=PADL(NUMENT+1,4,'0')
SELECT IteRi
IF mOpc=1
	IF F_Appd()
	   REPLACE Periodo WITH m.Periodo,;
           NumRi   WITH m.NumRi ,;
           NumMes  WITH m.NumMes,;
           ImpParc WITH 0,;
           Estado  WITH m.Estado,;
           Fecdep  WITH m.fecRi,;
           docref  WITH vnumero,;
		   tipo    WITH IIF(EMPTY(w_clas),'O','P'),;
		   codpart WITH w_clas,;
		   impparc WITH m.canri
	   SELECT Parma
	   SEEK "CORREL"+"REVERS"
	   REPLACE NUMENT WITH NUMENT+1
	   SELE ITERI
	ENDIF
	mOpc=2
 ELSE
	IF F_Appd()
	   REPLACE Periodo WITH m.Periodo,;
           NumRi   WITH m.NumRi ,;
           NumMes  WITH m.NumMes,;
           ImpParc WITH 0,;
           Estado  WITH m.Estado,;
           Fecdep  WITH m.fecRi,;
           docref  WITH vnumero,;
		   tipo    WITH IIF(EMPTY(w_clas),'O','P')
	   SELECT Parma
	   SEEK "CORREL"+"REVERS"
	   REPLACE NUMENT WITH NUMENT+1
	   SELE ITERI
	ENDIF
ENDIF
RETURN


FUNCTION wdbco  &&Descripci¢n de Banco para el Repo
*-------------
PRIVATE wdbc,wcbc
SELE CAJA
SEEK RI.codctc
IF FOUND()
   wcbc=caja.banco
   wdbc=Val_Para(wcbc,"BANCOS","D",22,25)   
ELSE
   wdbc=SPACE(10)
ENDIF
RETURN wdbc      
  
FUNCTION wigv
*------------
PARAMETERS a
PRIVATE xigv,zigv,wigv,uigv
STORE 0 TO xigv,zigv,wigv,uigv
PRIVATE wdoc,wcod
SELE RI
GO TOP
IF (ALLT(RI.CODCTC)='210-01-2366423' AND (RI.tipri)='02') .OR. (ALLT(RI.CodCtc)='267-0200149648' AND allt(RI.tipri)='02') .OR.( ALLT(RI.CodCtc)='410123000' AND allt(RI.tipri)='20') .OR. (ALLT(RI.CodCtc)='720234807' AND allt(RI.tipri)='73')
* .OR. (ALLT(RI.CODCTC)='210-01-2366423' AND (RI.tipri)='02')
	SCAN WHILE !EOF()
	     yigv=ROUND((RI.CanRi)*(18/118),2)
	     uigv=ROUND((RI.CanRi)*(100/118),2)
	     zigv=zigv+yigv
	     wigv=wigv+uigv
	ENDSCAN
ELSE
	SCAN WHILE !EOF()
	    uigv=RI.CanRi
    	wigv=wigv+uigv
	ENDSCAN
ENDIF   
DO CASE
   CASE a=1
	   RETURN zigv
   CASE a=2
   		RETURN wigv
ENDCASE   


PROCEDURE cor_as  &&Corrige Asientos Patrimoniales
*---------------
SELE CAJA
SEEK ALLTRiM(m.CodCtc)
IF FOUND()
   w_TipCtc=CAJA.TIPO
ENDIF
SELE Ri
ACTIVATE SCREEN
HIDE MENU mMenu
vTempo = '°°°°°°°°F5->Agregar°°°°°°°°°°°°°°F8->Eliminar°°°°°°°°°°°°°°F10->Terminar°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
ON KEY LABEL F5 DO AgRite
ON KEY LABEL F8 DO EliIte
ON KEY LABEL F10 KEYBOARD CHR(23)
SELECT astpat
SEEK m.Periodo+ALLTRiM(m.nummes)+m.numRi+m.CodCtc
IF !FOUND()
	DO agRite
ENDIF
BROWSE FIELDS ;
	codcta :H='Cuenta':v=val_fun('Cuenta','Cuenta',"Cuenta+' '+DescRi",codcta,2):F ,;
	tipcta :H='D/H' :P='@M D,H',;
	mtodeb :H='Monto Debe'  :W=tipcta='D' :P='999,999,999.99',;
	mtohab :H='Monto Haber' :W=tipcta='H' :P='999,999,999.99';
	WINDOW wind_2 KEY m.Periodo+ALLTRiM(m.NumMes)+m.NumRi+m.CodCtc
STORE 0 TO vdebe, vhaber ,vRet
SEEK m.Periodo+ALLTRiM(m.nummes)+m.numRi+m.CodCtc
SCAN WHILE PERiODO=m.Periodo AND ALLTRiM(m.nummes)=nummes AND m.numRi=numRi AND m.CodCtc=codctc 
    IF IIF(TipCta='D',MtoDeb,MtoHab)=0
    	dele next 1
    else
		vdebe = vdebe  + IIF(tipcta='D',mtodeb,0)
		vhaber= vhaber + IIF(tipcta='H',mtohab,0)
    ENDIF		
ENDSCAN
IF vdebe#vhaber
   DO standby WITH 'Ojo: No cuadra debe con haber'
ENDIF
ON KEY
ON KEY LABEL f4 DO imp_Ri
SELECT Ri
ON KEY LABEL F10
ON KEY LABEL F8
ON KEY LABEL F5
UNLOCK
ACTIVATE SCREEN
vTempo = '°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°'
DO Logos WITH Rotulo1,vTempo
SHOW MENU mMenu
SELE Ri
DO vista
RETURN


FUNCTION vctc
*------------
SELE caja
SEEK vcta
IF FOUND()
   vflag1=IIF(caja.clase='T',1,0)
ENDIF
RETURN   


PROCEDURE factura
*----------------
PARAMETERS fconcepto,ftipo
IF ALLT(Ri.tipri)='02'
	vvtip ='C'
ELSE
	vvtip ='O'
ENDIF
STORE SPACE(8) TO fruc
IF ftipo='1'   &&agregar factura, capturar datos
   SELE Parma
   SEEK 'PARFAC'+'SERIE'
   fserie= PADL(Nument,3,'0')
   SEEK 'PARFAC'+'IGV'
   figv  = Nument
   SEEK 'CORREL'+'FACTUR'
   fNumero = PADL(NumEnt+1,7,'0')
   SELE Auxil
   IF SEEK (ALLT(m.tipaux)+ALLT(m.codprv)) 
      fdescri= Auxil.descri
      fdirecc= Auxil.direccion
      Fruc   = LEFT(ALLT(Auxil.ruc),8)
   ENDIF
   SET MEMOWIDTH TO 50
   fconcepto=MLINE(RI.observ,2)+MLINE(RI.observ,3)+MLINE(RI.observ,4)
   *foncepto=vconcurso
   SELE Fact
   IF f_appd()
      REPLACE periodo   WITH m.periodo ,;
              nummes    WITH m.nummes ,;
              serie     WITH fserie,;
              numero    WITH fnumero,;
              fecFac    WITH m.fecri,;
              tipaux    WITH m.tipaux,;
              codprv    WITH m.codprv,;
              ruc       WITH fruc,;
              cantidad  WITH 1,;
              unimed    WITH 'Unidad',;
              concepto  WITH fconcepto,;
              preuni    WITH ROUND((m.canri*100)/(figv+100),2),;
              importe   WITH ROUND((m.canri*100)/(figv+100),2),;
			  subtot    WITH ROUND((m.canri*100)/(figv+100),2),;
			  igv       WITH ROUND(((m.canri*100)/(figv+100))*(figv/100),2),;
			  Total     WITH m.canri,;
			  codcad    WITH m.codcad,;
              codfte    WITH m.codfte,;
              usuario   WITH vUser_ID,;
              fecreg    WITH DATE(),;
			  estado    WITH '00',;
			  perri     WITH m.periodo,;
			  nummesri  WITH m.nummes,;              
			  numri     WITH m.numri,;
			  nombre    WITH fdescri,;
			  direcc    WITH fdirecc,;
			  tipo      WITH vvtip,;
			  conlic    WITH vconcurso
	ENDIF
	UNLOCK
	SELE parma
    SEEK 'CORREL'+'FACTUR'
    REPLACE NumEnt WITH NumEnt + 1       
    SELE fact
    DO edita_fac WITH fserie,fnumero,vvtip
ELSE
   SELE Auxil
   IF SEEK (ALLT(m.tipaux)+ALLT(m.codprv)) AND RLOCK()
      fdescri= Auxil.descri
      fdirecc= Auxil.direccion
      Fruc   = LEFT(ALLT(Auxil.ruc),8)
   ENDIF
   UNLOCK
    SELE fact
    SET ORDER TO factura2
    IF SEEK (m.periodo+ALLT(m.nummes)+m.numri)     
       fserie  = fact.serie
       fnumero = fact.numero 
       SET ORDER TO factura1
       DO edita_fac WITH fserie,fnumero,vvtip
	ELSE    
	    SET ORDER TO factura1
	ENDIF    
ENDIF    
ACTIVATE SCREEN
RETURN


PROCEDURE edita_fac
*------------------
PARAMETERS wserie,wnumero,wtip
IF wtip='C'
   EDIT NOAPPEND NODELETE NOMENU NOOPTIMIZE WINDOW Wind_4;
   KEY wserie+wNumero FIELD ;
   serie       :R,;
   numero      :R,;
   nombre      :H= 'Se¤or (es) ' :P='@!' ,;
   direcc      :H= 'Direcci¢n '  :P='@!' ,;
   Ruc         :H='R.U.C. N§' :8 :P='@!' ,;
   Fecfac      :H= 'Fecha',;
   Cantidad    :H= 'Cantidad': P='@!' :5,;
   Unimed      :H= 'Unidad de Medida': P='@!' :R,;
   Concepto    :H='Descripci¢n' : P='@S60' ,;
   Preuni      :H='Precio Unitario' : P='999,999,999,999.99' :R,;
   Importe     :H='Importe' : P='999,999,999,999.99' :R,; 
   Subtot      :H='Subtotal' : P='999,999,999,999.99' :R,;
   Igv         :H='I.G.V.' : P='999,999,999,999.99' :R,;
   total       :H='Total' : P='999,999,999,999.99' :R
ELSE
   EDIT NOAPPEND NODELETE NOMENU NOOPTIMIZE WINDOW Wind_4;
   KEY wserie+wNumero FIELD ;
   serie       :R,;
   numero      :R,;
   nombre      :H= 'Se¤or (es) ' :P='@!' ,;
   direcc      :H= 'Direcci¢n '  :P='@!' ,;
   Ruc         :H='R.U.C. N§' :8 :P='@!' ,;
   Fecfac      :H= 'Fecha',;
   Cantidad    :H= 'Cantidad' : P='99' :V=Calcula() ,;   
   Unimed      :H= 'Unidad de Medida': P='@!' :R,;   
   Concepto    :H='Descripci¢n' : P='@S60' ,;   
   Preuni      :H='Precio Unitario' : P='999,999,999,999.99' :R,;
   Importe     :H='Importe' : P='999,999,999,999.99' :R,; 
   Subtot      :H='Subtotal' : P='999,999,999,999.99' :R,;
   Igv         :H='I.G.V.' : P='999,999,999,999.99' :R,;
   total       :H='Total' : P='999,999,999,999.99' :R
ENDIF


IF YESNO( '¨ Imprime la Factura ?' )
   SET FILT TO serie=wserie AND numero=wnumero
   DO REPORTE WITH 2,"RepFac",' Reporte de Factura'
   SET FILT TO
ENDIF   
SELE Ri
RETURN


PROCEDURE Calcula
*----------------
vcant1 = ROUND(total/cantidad,2)
vcant2 = ROUND(((vcant1*100)/(figv+100))*(figv/100),2)

REPLACE preuni  WITH ROUND(vcant1-vcant2,2)
REPLACE importe WITH ROUND(preuni*cantidad,2)
REPLACE subtot  WITH ROUND(preuni*cantidad,2)
REPLACE igv     WITH ROUND(vcant2*cantidad,2)

RETURN


FUNCTION dmes
*------------
PARAMETER fmes
DO CASE
   CASE fmes=1
        v_d='Enero'
   CASE fmes=2
        v_d='Febrero'
   CASE fmes=3
        v_d='Marzo'
   CASE fmes=4
        v_d='Abril'
   CASE fmes=5
        v_d='Mayo' 
   CASE fmes=6
        v_d='Junio'
   CASE fmes=7
        v_d='Julio'
   CASE fmes=8
        v_d='Agosto'
   CASE fmes=9
        v_d='Setiembre'  
   CASE fmes=10
        v_d='Octubre' 
   CASE fmes=11
        v_d='Noviembre'
   CASE fmes=12
        v_d='Diciembre'        
ENDCASE
RETURN v_d        


FUNCTION factu  &&Displaya N§ de Factura
*------------- 
PARAMETERS vp,vm,vn
vali=ALIAS()
vord=ORDER()
SELE Fact
SET ORDER TO Factura2
PRIVATE vz
STORE SPACE(50) TO vz
IF SEEK(vp+ALLT(vm)+vn)
   vz="Factura :  "+Fact.serie+'.'+Fact.numero+'   '+DTOC(Fact.Fecfac)
ENDIF
SET ORDER TO Factura1
SELE (vali)
SET ORDER TO (vord)
RETURN vz


FUNCTION Concurso
*----------------
 vconcurso = SPACE(04)
 ACTIVATE WINDOW Wind_8
 alia  = ALIAS()
 SELE Fact
 SET ORDER TO Factura2
 SEEK ALLTRIM(m.periodo)+ALLTRiM(m.nummes)+m.numRi
 IF FOUND()
 	vconcurso = Fact.ConLic
 ENDIF 	
 SET ORDER TO Factura1
 USE ConLic IN 0 ORDER ConLic1 ALIAS ConLic
 SELECT ConLic
 @ 1, 05 SAY "Concurso        :" GET vconcurso  VALID val_fun('ConLic','ConLic',"ConLic+' '+Deslic",vconcurso,1)
 READ VALID Val_read()
 DEACTIVATE WINDOW Wind_8
 SELE conLic
 IF SEEK(vconcurso)
    dconcurso=ConLic.Deslic
 ENDIF   
 USE
 SELECT (alia)
 RETURN vconcurso
 
 
 FUNCTION Inscribe
*-----------------
 vconcurso = SPACE(04)
 ACTIVATE WINDOW Wind_9
 alia  = ALIAS()
 SELE Fact
 SET ORDER TO Factura2
 SEEK ALLTRIM(m.periodo)+ALLTRiM(m.nummes)+m.numRi
 IF FOUND()
 	vconcurso = Fact.ConLic
 ENDIF 	
 SET ORDER TO Factura1
 USE ConLic IN 0 ORDER ConLic2 ALIAS ConLic
 SELECT ConLic
 @ 1, 05 SAY "Actividad       :" GET vconcurso  VALID val_fun('ConLic','ConLic',"ConLic+' '+Deslic",vconcurso,1)
 READ VALID Val_read()
 DEACTIVATE WINDOW Wind_9
 SELE conLic
 IF SEEK(vconcurso)
    dconcurso=ConLic.Deslic
 ENDIF   
 USE
 SELECT (alia)
 RETURN vconcurso
 
 
 FUNCTION Val_Ing2
*-----------------
  PARAMETERS mValor, Filtro, mVaRiable, mCol, mLong
  PRiVATE mAlias
  DO CASE
    CASE PARAMETERS() = 2
      mCol = 0
      mVaRiable = ' '
      mLong = 40
    CASE PARAMETERS() = 3
      mCol = 0
      mLong = 40
    CASE PARAMETERS() = 4
      mLong = 40               && Longitud campo DESCRi
  ENDCASE

  mAlias  = ALIAS()
  SELECT IngR
  SEEK Filtro+mValor

  IF !FOUND() AND !mVaRiable $'VZ'
      _OldWnd = WOUTPUT()
      ACTIVATE SCREEN
      IF !EMPTY(FILTRO)
         SET FILTER TO CodIng >= Filtro
      ENDIF
      GO TOP
      IF EOF() 
         DO STANDBY WITH 'No existen partidas definidas'
         SET FILTER TO
         sele (malias)
         return &&.f.
      endif
      DEFINE POPUP parametro FROM 03,40 PROMPT FIELD ALLTRiM(CODING)+'.'+ALLTRiM(SUBING)+' '+SUBSTR(DESING,1,40)
      ON SELECTION POPUP parametro DEACTIVATE POPUP
      ACTIVATE POPUP parametro
      IF !EMPTY( _OldWnd)
         ACTIVATE WINDOW &_OldWnd
      ENDIF

      RELEASE POPUP parametro
      SET FILTER TO
 ENDIF
 mValor = IngR.CodIng 
 mDescr = SUBSTR( IngR.DesIng, 1, mLong )

 SET ORDE TO 1
  IF !EMPTY( mAlias )
    SELECT (mAlias)
  ENDIF
*  DO CASE
*    CASE mVaRiable=' '   && En edici¢n
*      @ ROW(),mCol   SAY mValor
*      @ ROW(),mCol+7 SAY mDescr
*      RETURN .T.
*    CASE mVaRiable='A'   && En edici¢n SOLO DESCRiPCION
*      @ ROW(),mCol SAY mDescr
*      RETURN
*    CASE mVaRiable='V'   && En vista
*      @ ROW(),COL()  SAY mValor
*      RETURN mDescr
*    CASE mVaRiable='D'   && En vista
*      RETURN mDescr
*    CASE mVaRiable='Z'   && En vista SIN PINTAR
*      RETURN mDescr
*    CASE mVaRiable='C'   && Solo codigo
*      RETURN .T.
*    CASE mVaRiable='T'
*      &mVaRiable = mValor
*      @ ROW(),mCol+7 SAY mDescr
 *     RETURN  mValor
 *   OTHERWISE            && En browse de edici¢n
 mValor = IngR.CodIng 
 mDescr = SUBSTR( IngR.DesIng, 1, mLong )
 SELECT (mAlias)
 REPLACE Iteri.codpart WITH mValor
 REPLACE Iteri.concep  WITH mdescr

 *     REPLACE codpart WITH mValor
*      replace concep with mdescr
*      CODPART=MVALOR
 *     wCodPart=MVALOR
      RETURN .t.
*  ENDCASE
RETURN

PROCEDURE AsiOrd
*---------------
PRIVATE i,j,nTotD,nTotH,w_PreD,w_PreH
AS=ALIAS()
nTotD = 0
nTotH = 0
lMuestra = .F.
SELE AstOrd

IF !SEEK(m.Periodo+m.nummes+m.numRi+'R/I')
	IF type("acadenl")#'L'
		laCadEnl = ALEN(acadenl)/9
		FOR i = 1 TO laCadEnl
			IF acadenl(i,1) = 'R'
				SELE AstOrd
				IF !SEEK(m.Periodo+m.NumMes+m.NumRI+'R/I') AND !EMPTY(aCadenl(i,6)) AND !EMPTY(aCadenl(i,7))
					IF f_appd()
						REPLACE Periodo WITH m.Periodo,;
						        nummes  WITH m.nummes,;
								tipdoc  WITH 'R/I',;
								numref  WITH m.numRi ,;
								TipCta	WITH "D",;
								fecha   WITH m.fecRi,;
								CodCta	WITH aCadenl(i,6),;
								MtoDeb	WITH aCadenl(i,8),;
								MtoHab	WITH 0
								
					ENDIF
					IF f_appd()
						REPLACE Periodo WITH m.Periodo,;
						        nummes  WITH m.nummes,;
								tipdoc  WITH 'R/I',;
								numref  WITH m.numRi ,;
								TipCta	WITH "H",;
								fecha   WITH m.fecRi,;
								CodCta	WITH aCadenl(i,7),;
								MtoDeb	WITH 0,;
								MtoHab	WITH aCadenl(i,8)
					ENDIF
					lMuestra = .T.
				ELSE
					FOR j = 1 to 2
						IF j = 1
							xNvo = .T.
							IF SEEK(m.Periodo+m.NumMes+m.NumRI+'R/I') AND !EMPTY(aCadenl(i,6))
								SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'R/I'
									IF CodCta = aCadEnl(i,6) AND TipCta = 'D'
										REPLACE MtoDeb WITH MtoDeb + aCadEnl(i,8)
										lMuestra = .T.
										xNvo = .F.
										LOOP
									ENDIF
								ENDSCAN
							ENDIF
							IF xNvo AND !EMPTY(aCadenl(i,6))
								IF f_appd()
									REPLACE Periodo WITH m.Periodo,;
									        nummes  WITH m.nummes,;
											tipdoc  WITH 'R/I',;
											numref  WITH m.numRi ,;
											TipCta	WITH "D",;
											fecha   WITH m.fecRi,;
											CodCta	WITH aCadenl(i,6),;
											MtoDeb	WITH aCadenl(i,8),;
											MtoHab	WITH 0
								ENDIF
								lMuestra = .T.
							ENDIF
						ENDIF
						IF j = 2
							xNvo = .T.
							IF SEEK(m.Periodo+m.NumMes+m.NumRI+'R/I') AND !EMPTY(aCadenl(i,7))
								SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'R/I'
									IF CodCta = aCadEnl(i,7) AND TipCta = 'H'
										REPLACE MtoHab WITH MtoHab + aCadEnl(i,8)
										lMuestra = .T.
										xNvo = .F.
										LOOP
									ENDIF
								ENDSCAN
							ENDIF
							IF xNvo AND !EMPTY(aCadenl(i,7))
								IF f_appd()
									REPLACE Periodo WITH m.Periodo,;
									        nummes  WITH m.nummes,;
											tipdoc  WITH 'R/I',;
											numref  WITH m.numRi ,;
											TipCta	WITH "H",;
											fecha   WITH m.fecRi,;
											CodCta	WITH aCadenl(i,7),;
											MtoDeb	WITH 0,;
											MtoHab	WITH aCadenl(i,8)
								ENDIF
								lMuestra = .T.
							ENDIF
						ENDIF
					ENDFOR
				ENDIF
			ENDIF
		ENDFOR
	ENDIF
ELSE
	IF SEEK(m.Periodo+m.nummes+m.numRi+'R/I')
		SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'R/I'
			IF TipCta='D'
				REPLACE MtoDeb WITH 0
			ELSE
				REPLACE MtoHab WITH 0
			ENDIF
		ENDSCAN
	ENDIF
	
	IF type("acadenl")#'L'
		laCadEnl = ALEN(acadenl)/9
		FOR i = 1 TO laCadEnl
			IF acadenl(i,1) = 'R'
				SELE AstOrd
				FOR j = 1 to 2
					IF j = 1
						xNvo = .T.
						IF SEEK(m.Periodo+m.NumMes+m.NumRI+'R/I') AND !EMPTY(aCadenl(i,6))
							SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'R/I'
								IF CodCta = aCadEnl(i,6) AND TipCta = 'D'
									REPLACE MtoDeb WITH MtoDeb + aCadEnl(i,8)
									lMuestra = .T.
									xNvo = .F.
									LOOP
								ENDIF
							ENDSCAN
						ENDIF
						IF xNvo AND !EMPTY(aCadenl(i,6))
							IF f_appd()
								REPLACE Periodo WITH m.Periodo,;
								        nummes  WITH m.nummes,;
										tipdoc  WITH 'R/I',;
										numref  WITH m.numRi ,;
										TipCta	WITH "D",;
										fecha   WITH m.fecRi,;
										CodCta	WITH aCadenl(i,6),;
										MtoDeb	WITH aCadenl(i,8),;
										MtoHab	WITH 0
							ENDIF
							lMuestra = .T.
						ENDIF
					ENDIF
					IF j = 2
						xNvo = .T.
						IF SEEK(m.Periodo+m.NumMes+m.NumRI+'R/I') AND !EMPTY(aCadenl(i,7))
							SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'R/I'
								IF CodCta = aCadEnl(i,7) AND TipCta = 'H'
									REPLACE MtoHab WITH MtoHab + aCadEnl(i,8)
									lMuestra = .T.
									xNvo = .F.
									LOOP
								ENDIF
							ENDSCAN
						ENDIF
						IF xNvo AND !EMPTY(aCadenl(i,7))
							IF f_appd()
								REPLACE Periodo WITH m.Periodo,;
								        nummes  WITH m.nummes,;
										tipdoc  WITH 'R/I',;
										numref  WITH m.numRi ,;
										TipCta	WITH "H",;
										fecha   WITH m.fecRi,;
										CodCta	WITH aCadenl(i,7),;
										MtoDeb	WITH 0,;
										MtoHab	WITH aCadenl(i,8)
							ENDIF
							lMuestra = .T.
						ENDIF
					ENDIF
				ENDFOR
			ENDIF
		ENDFOR
	ENDIF
ENDIF

IF lMuestra
	IF SEEK(m.Periodo+m.nummes+m.numRi+'R/I')
		SCAN WHILE Periodo+NumMes+NumRef = m.Periodo+m.NumMes+m.NumRI
			IF TipCta = 'D'
				w_PreD = CodCta
				nTotD  = nTotD + MtoDeb
			ELSE
				w_PreH = CodCta
				nTotH  = nTotH + MtoHab
			ENDIF
		ENDSCAN
	ENDIF
	
	SELE (AS)
	DEFINE WINDOW wAstOrd FROM 10,10 TO 15,70 ;
		 TITLE ' ASIENTOS DE ORDEN' COLOR SCHEME 02
	ACTIVATE WINDOW wAstOrd
	@ 00,08  SAY 'Cuentas '
	@ 00,18  SAY 'Debe '
	@ 00,34  SAY 'Haber '
	@ 01,04  SAY w_PreD PICTURE '!!!!!!!!!!!!' 
	@ 01,18  SAY nTotD  PICTURE '999,999,999.99' 
	@ 02,12  SAY w_PreH PICTURE '!!!!!!!!!!!!' 
	@ 02,34  SAY nTotH  PICTURE '999,999,999.99'
	WAIT ' '
	DEACTIVATE WINDOW wAstOrd
	vValdeb = nTotD
	vValhab = nTotH
ENDIF

RETURN

PROCEDURE AsiFac
*---------------
PUBLIC cCta
PRIVATE vDebe,vHaber,lProc

lProc = .T.

ON KEY LABEL F5 DO AgRiteF
ON KEY LABEL F8 DO EliIte
ON KEY LABEL F10 KEYBOARD CHR(23)
SELE AstPat
cOrd = ORDER()
SET INDEX TO (Idx1)
IF !SEEK(m.Periodo+ALLTRiM(m.NumMes)+m.NumRi+"FAC")
	DO AgrAstFac
ENDIF

IF SEEK(m.Periodo+ALLTRiM(m.NumMes)+m.NumRi+"FAC")
	IF !EOF()
		DEFINE WINDOW W_AstFac FROM 17,00 TO 23,79 DOUBLE ;
			TITLE 'Asientos de Factura (Referencial)' ;
			COLOR SCHEME 10
	
		BROWSE KEY m.Periodo+ALLTRiM(m.NumMes)+m.NumRi+"FAC" WINDOW W_AstFac ;
			FIELDS ;
				codcta :H='Cuenta':v=val_fun('Cuenta','Cuenta',"Cuenta+' '+DescRi",codcta,2):F ,;
				tipcta :H='D/H' :P='@M D,H',;
				mtodeb :H='Monto Debe'  :W=tipcta='D' :P='999,999,999.99',;
				mtohab :H='Monto Haber' :W=tipcta='H' :P='999,999,999.99';
		
		DEACTIVATE WINDOW W_AstFac
		RELEASE WINDOW W_AstFac
		
		STORE 0 TO vdebe, vhaber ,vRet
		SEEK m.Periodo+ALLTRiM(m.nummes)+m.numRi+m.CodCtc
		SCAN WHILE PERiODO=m.Periodo AND ALLTRiM(m.nummes)=nummes AND m.numRi=numRi AND m.CodCtc=codctc 
			IF IIF(TipCta='D',MtoDeb,MtoHab)=0
				dele next 1
			 else
				vdebe = vdebe  + IIF(tipcta='D',mtodeb,0)
				vhaber= vhaber + IIF(tipcta='H',mtohab,0)
			ENDIF
		ENDSCAN
		
		IF vdebe#vhaber
			DO standby WITH 'Ojo: No cuadra debe con haber Asientos de Facturas'
		ENDIF
		
	ENDIF
ENDIF

SET ORDER TO (cOrd)
ON KEY LABEL F5
ON KEY LABEL F8
ON KEY LABEL F10
RETURN

PROCEDURE AgrAstFac
*------------------
PRIVATE i,j
lMuestra = .F.
*SELECT astpat

laCadEnl = ALEN(acadenl)/9

IF type("acadenl")#'L'
	FOR i = 1 TO laCadEnl
		IF acadenl(i,1) = 'F'
			nIIGV = 1.19
			tReg = IIF(acadenl(i,9)#'S',2,3)
			nIGV = IIF(acadenl(i,9)#'S',0,ROUND(acadenl(i,8)-acadenl(i,8)/nIIGV,2))
			
			SELE AstPat
			IF !SEEK(m.Periodo+m.NumMes+m.NumRI+'FAC') AND !EMPTY(aCadEnl(i,2)) AND !EMPTY(aCadEnl(i,3))
				IF f_appd()
					REPLACE peRiodo WITH m.Periodo,;
							nummes WITH m.nummes,;
	        				numref WITH m.numRi,;
							tipdoc WITH 'FAC',;
							codctc WITH m.CodCtc,;
							fecha  WITH m.FecRi,;
							tipctc WITH w_TipCtc,;
							tipcta  WITH 'D',;
							Codcta  WITH aCadenl(i,2),;
							mtodeb  WITH aCadenl(i,8)
				ENDIF
				IF tReg = 3
					IF f_appd()
						REPLACE peRiodo WITH m.Periodo,;
				    		 	nummes WITH m.nummes,;
	        					numref WITH m.numRi,;
						        tipdoc WITH 'FAC',;
			    			    codctc WITH m.CodCtc,;
					    	    fecha  WITH m.FecRi,;
		        				tipctc WITH w_TipCtc,;
					        	tipcta  WITH 'H',;
		    				    Codcta  WITH "210101050100000",;
	    					    mtoHab  WITH nIgv
					ENDIF
				ENDIF
				
				IF f_appd()
					REPLACE peRiodo WITH m.Periodo,;
					     	nummes WITH m.nummes,;
					        numref WITH m.numRi,;
					        tipdoc WITH 'FAC',;
					        codctc WITH m.CodCtc,;
					        fecha  WITH m.FecRi,;
				        	tipctc WITH w_TipCtc,;
				    	    tipcta  WITH 'H',;
					        Codcta  WITH aCadEnl(i,3),;
					        mtoHab  WITH aCadEnl(i,8)-nIgv
				ENDIF
				lMuestra = .T.
			ELSE
				FOR j = 1 to tReg
					IF j = 1
						SEEK m.Periodo+m.NumMes+m.NumRI+'FAC'
						xNvo = .T.
						SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+"FAC"
							IF CodCta = aCadEnl(i,2) AND TipCta = 'D'
								REPLACE MtoDeb WITH MtoDeb + aCadEnl(i,8)
								lMuestra = .T.
								xNvo = .F.
								LOOP
							ENDIF
						ENDSCAN
						IF xNvo AND !EMPTY(aCadEnl(i,2))
							IF f_appd()
								REPLACE peRiodo WITH m.Periodo,;
										nummes WITH m.nummes,;
    		    						numref WITH m.numRi,;
										tipdoc WITH 'FAC',;
										codctc WITH m.CodCtc,;
										fecha  WITH m.FecRi,;
										tipctc WITH w_TipCtc,;
										tipcta  WITH 'D',;
										Codcta  WITH aCadEnl(i,2),;
										mtodeb  WITH aCadEnl(i,8)
							ENDIF
							lMuestra = .T.
						ENDIF
					ENDIF
					IF j = 2
						SEEK m.Periodo+m.NumMes+m.NumRI+"FAC"
						xNvo = .T.
						SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+"FAC"
							IF CodCta = aCadEnl(i,3) AND TipCta = 'H'
								REPLACE MtoHab WITH MtoHab + aCadEnl(i,8)
								lMuestra = .T.
								xNvo = .F.
								LOOP
							ENDIF
						ENDSCAN
						IF xNvo AND !EMPTY(aCadEnl(i,3))
							IF f_appd()
								REPLACE peRiodo WITH m.Periodo,;
					     				nummes WITH m.nummes,;
								        numref WITH m.numRi,;
							        	tipdoc WITH 'FAC',;
							    	    codctc WITH m.CodCtc,;
			        					fecha  WITH m.FecRi,;
								        tipctc WITH w_TipCtc,;
							    	    tipcta  WITH 'H',;
							        	Codcta  WITH aCadEnl(i,3),;
								        mtoHab  WITH IIF(tReg=3,aCadEnl(i,8)-nReg,aCadEnl(i,8))
							ENDIF
							lMuestra = .T.
						ENDIF
					ENDIF
					IF j = 3
						SEEK m.Periodo+m.NumMes+m.NumRI+"FAC"
						xNvo = .T.
						SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+"FAC"
							IF CodCta = "210101050100000" AND TipCta = 'H'
								REPLACE MtoHab WITH MtoHab + nIgv
								lMuestra = .T.
								xNvo = .F.
								LOOP
							ENDIF
						ENDSCAN
						IF xNvo AND !EMPTY(aCadEnl(i,2)) AND !EMPTY(aCadEnl(i,3))
							IF f_appd()
								REPLACE peRiodo WITH m.Periodo,;
				    	 				nummes WITH m.nummes,;
								        numref WITH m.numRi,;
								        tipdoc WITH 'FAC',;
								        codctc WITH m.CodCtc,;
				        				fecha  WITH m.FecRi,;
								        tipctc WITH w_TipCtc,;
						    	    	tipcta  WITH 'H',;
						        		Codcta  WITH "210101050100000",;
								        mtoHab  WITH nIgv
							ENDIF
						ENDIF
					ENDIF
				ENDFOR
			ENDIF
		ENDIF
	ENDFOR
ENDIF

RETURN


*PROCEDURE AgrAstFac
*------------------
SELE IteRI
SEEK m.Periodo+m.NumMes+m.NumRI
nTot = 0
IF FOUND()
	SCAN FOR Periodo = m.Periodo AND NumMes = m.NumMes AND NumRi = m.NumRI AND Tipo="P"
		nTot = nTot + ImpParc
	ENDSCAN
ENDIF

nIIGV = iif(dtoc(m.fecri,1)>"20030731",1.19,1.18)

tReg = IIF(cIgv#'S',2,3)
nIGV = IIF(cIgv#'S',0,ROUND(nTot-nTot/nIIGV,2))

SELECT astpat
IF f_appd()
	REPLACE peRiodo WITH m.Periodo,;
	     	nummes WITH m.nummes,;
	        numref WITH m.numRi,;
	        tipdoc WITH 'FAC',;
	        codctc WITH m.CodCtc,;
	        fecha  WITH m.FecRi,;
	        tipctc WITH w_TipCtc,;
	        tipcta  WITH 'D',;
	        Codcta  WITH dFacAPa,;
	        mtodeb  WITH ntot
ENDIF

IF tReg = 3
	IF f_appd()
		REPLACE peRiodo WITH m.Periodo,;
	    	 	nummes WITH m.nummes,;
	        	numref WITH m.numRi,;
		        tipdoc WITH 'FAC',;
		        codctc WITH m.CodCtc,;
	    	    fecha  WITH m.FecRi,;
	        	tipctc WITH w_TipCtc,;
		        tipcta  WITH 'H',;
		        Codcta  WITH "4010401000",;
	    	    mtoHab  WITH nIgv
	ENDIF
ENDIF

IF f_appd()
	REPLACE peRiodo WITH m.Periodo,;
	     	nummes WITH m.nummes,;
	        numref WITH m.numRi,;
	        tipdoc WITH 'FAC',;
	        codctc WITH m.CodCtc,;
	        fecha  WITH m.FecRi,;
	        tipctc WITH w_TipCtc,;
	        tipcta  WITH 'H',;
	        Codcta  WITH HFacApa,;
	        mtoHab  WITH nTot-nIgv
ENDIF
RETURN

PROCEDURE AgRiteF
*----------------
SELECT astpat
IF f_appd()
	REPLACE peRiodo WITH m.Periodo,;
	     	nummes WITH m.nummes,;
	        numref WITH m.numRi,;
	        tipdoc WITH 'FAC',;
	        codctc WITH m.CodCtc,;
	        fecha  WITH m.FecRi,;
	        TipCtc WITH w_TipCtc
ENDIF
RETURN

PROCEDURE AsiOrdFac
*------------------
PRIVATE i,j,nTotD,nTotH,w_PreD,w_PreH
AS=ALIAS()

w_PreD = SPACE(15)
w_PreH = SPACE(15)
lMuestra = .F.
nTotD = 0
nTotH = 0

SELE AstOrd

IF !SEEK(m.Periodo+m.nummes+m.numRi+'FAC')
	IF type("acadenl")#'L'
		laCadEnl = ALEN(acadenl)/9
		FOR i = 1 TO laCadEnl
			IF acadenl(i,1) = 'F'
				SELE AstOrd
				IF !SEEK(m.Periodo+m.NumMes+m.NumRI+'FAC') AND !EMPTY(aCadenl(i,6)) AND !EMPTY(aCadenl(i,7))
					IF f_appd()
						REPLACE Periodo WITH m.Periodo,;
						        nummes  WITH m.nummes,;
								tipdoc  WITH 'FAC',;
								numref  WITH m.numRi ,;
								TipCta	WITH "D",;
								fecha   WITH m.fecRi,;
								CodCta	WITH aCadenl(i,6),;
								MtoDeb	WITH aCadenl(i,8),;
								MtoHab	WITH 0
								
					ENDIF
					IF f_appd()
						REPLACE Periodo WITH m.Periodo,;
						        nummes  WITH m.nummes,;
								tipdoc  WITH 'FAC',;
								numref  WITH m.numRi ,;
								TipCta	WITH "H",;
								fecha   WITH m.fecRi,;
								CodCta	WITH aCadenl(i,7),;
								MtoDeb	WITH 0,;
								MtoHab	WITH aCadenl(i,8)
					ENDIF
					lMuestra = .T.
				ELSE
					FOR j = 1 to 2
						IF j = 1
							xNvo = .T.
							IF SEEK(m.Periodo+m.NumMes+m.NumRI+'FAC') AND !EMPTY(aCadenl(i,6))
								SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'FAC'
									IF CodCta = aCadEnl(i,6) AND TipCta = 'D'
										REPLACE MtoDeb WITH MtoDeb + aCadEnl(i,8)
										lMuestra = .T.
										xNvo = .F.
										LOOP
									ENDIF
								ENDSCAN
							ENDIF
							IF xNvo AND !EMPTY(aCadenl(i,6))
								IF f_appd()
									REPLACE Periodo WITH m.Periodo,;
									        nummes  WITH m.nummes,;
											tipdoc  WITH 'FAC',;
											numref  WITH m.numRi ,;
											TipCta	WITH "D",;
											fecha   WITH m.fecRi,;
											CodCta	WITH aCadenl(i,6),;
											MtoDeb	WITH aCadenl(i,8),;
											MtoHab	WITH 0
								ENDIF
								lMuestra = .T.
							ENDIF
						ENDIF
						IF j = 2
							xNvo = .T.
							IF SEEK(m.Periodo+m.NumMes+m.NumRI+'FAC') AND !EMPTY(aCadenl(i,7))
								SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'FAC'
									IF CodCta = aCadEnl(i,7) AND TipCta = 'H'
										REPLACE MtoHab WITH MtoHab + aCadEnl(i,8)
										lMuestra = .T.
										xNvo = .F.
										LOOP
									ENDIF
								ENDSCAN
							ENDIF
							IF xNvo  AND !EMPTY(aCadenl(i,7))
								IF f_appd()
									REPLACE Periodo WITH m.Periodo,;
									        nummes  WITH m.nummes,;
											tipdoc  WITH 'FAC',;
											numref  WITH m.numRi ,;
											TipCta	WITH "H",;
											fecha   WITH m.fecRi,;
											CodCta	WITH aCadenl(i,7),;
											MtoDeb	WITH 0,;
											MtoHab	WITH aCadenl(i,8)
								ENDIF
								lMuestra = .T.
							ENDIF
						ENDIF
					ENDFOR
				ENDIF
			ENDIF
		ENDFOR
	ENDIF
ELSE
	IF SEEK(m.Periodo+m.nummes+m.numRi+'FAC')
		SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'FAC'
			IF TipCta = 'D'
				REPLACE MtoDeb WITH 0
			ELSE
				REPLACE MtoHab WITH 0
			ENDIF
		ENDSCAN
	ENDIF
	
	IF type("acadenl")#'L'
		laCadEnl = ALEN(acadenl)/9
		FOR i = 1 TO laCadEnl
			IF acadenl(i,1) = 'F'
				SELE AstOrd
				FOR j = 1 to 2
					IF j = 1
						xNvo = .T.
						IF SEEK(m.Periodo+m.NumMes+m.NumRI+'FAC') AND !EMPTY(aCadenl(i,6))
							SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'FAC'
								IF CodCta = aCadEnl(i,6) AND TipCta = 'D'
									REPLACE MtoDeb WITH MtoDeb + aCadEnl(i,8)
									lMuestra = .T.
									xNvo = .F.
									LOOP
								ENDIF
							ENDSCAN
						ENDIF
						IF xNvo AND !EMPTY(aCadenl(i,6))
							IF f_appd()
								REPLACE Periodo WITH m.Periodo,;
								        nummes  WITH m.nummes,;
										tipdoc  WITH 'FAC',;
										numref  WITH m.numRi ,;
										TipCta	WITH "D",;
										fecha   WITH m.fecRi,;
										CodCta	WITH aCadenl(i,6),;
										MtoDeb	WITH aCadenl(i,8),;
										MtoHab	WITH 0
							ENDIF
							lMuestra = .T.
						ENDIF
					ENDIF
					IF j = 2
						xNvo = .T.
						IF SEEK(m.Periodo+m.NumMes+m.NumRI+'FAC') AND !EMPTY(aCadenl(i,7))
							SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'FAC'
								IF CodCta = aCadEnl(i,7) AND TipCta = 'H'
									REPLACE MtoHab WITH MtoHab + aCadEnl(i,8)
									lMuestra = .T.
									xNvo = .F.
									LOOP
								ENDIF
							ENDSCAN
						ENDIF
						IF xNvo AND !EMPTY(aCadenl(i,7))
							IF f_appd()
								REPLACE Periodo WITH m.Periodo,;
								        nummes  WITH m.nummes,;
										tipdoc  WITH 'FAC',;
										numref  WITH m.numRi ,;
										TipCta	WITH "H",;
										fecha   WITH m.fecRi,;
										CodCta	WITH aCadenl(i,7),;
										MtoDeb	WITH 0,;
										MtoHab	WITH aCadenl(i,8)
							ENDIF
							lMuestra = .T.
						ENDIF
					ENDIF
				ENDFOR
			ENDIF
		ENDFOR
	ENDIF
ENDIF

IF lMuestra
	IF SEEK(m.Periodo+m.nummes+m.numRi+'FAC')
		SCAN WHILE Periodo+NumMes+NumRef+TipDoc = m.Periodo+m.NumMes+m.NumRI+'FAC'
			IF TipCta = 'D'
				w_PreD = CodCta
				nTotD  = nTotD + MtoDeb
			ELSE
				w_PreH = CodCta
				nTotH  = nTotH + MtoHab
			ENDIF
		ENDSCAN
	ENDIF
	
	SELE (AS)
	DEFINE WINDOW wAstOrd FROM 10,10 TO 15,70 ;
	 TITLE ' ASIENTOS DE ORDEN DE FACTURA ' COLOR SCHEME 02
	ACTIVATE WINDOW wAstOrd
		@ 00,08  SAY 'Cuentas '
		@ 00,18  SAY 'Debe '
		@ 00,34  SAY 'Haber '
		@ 01,04  SAY w_PreD PICTURE '!!!!!!!!!!!!' 
		@ 01,18  SAY nTotD  PICTURE '999,999,999.99' 
		@ 02,12  SAY w_PreH PICTURE '!!!!!!!!!!!!' 
		@ 02,34  SAY nTotH  PICTURE '999,999,999.99'
		WAIT ' '
		DEACTIVATE WINDOW wAstOrd
		vValdeb = nTotD
		vValhab = nTotH
ENDIF


RETURN


*PROCEDURE AsiOrdFac
*------------------
*SELE AsiAut
*SEEK "FAC"+"   "+"ASTORD"

*IF !FOUND()
*	DO StandBy WITH "PARAMETRO DE CTAS. DE ORDEN INICIALIZADO, CONSULTE AL AREA DE SISTEMAS"
*	RETURN
* ELSE
*	cCtaD = DCuenta
*	cCtaH = HCuenta
*ENDIF

DFacAOr =   PADR("910302",15,"0")
HFacAOr =   PADR("910402",15,"0")

SELE IteRI
SEEK m.Periodo+m.NumMes+m.NumRI
nTot = 0
IF FOUND()
	SCAN FOR Periodo = m.Periodo AND NumMes = m.NumMes AND NumRi = m.NumRI AND Tipo="P"
		nTot = nTot + ImpParc
	ENDSCAN
ENDIF

SELE AstOrd
SEEK m.Periodo+m.NumMes+m.NumRI+"FAC"
IF FOUND()
	FOR i = 1 TO 2
		IF f_Lock(1) OR RLOCK()
			REPLACE Periodo WITH m.Periodo ,;
					NUMMES	WITH m.NumMes  ,;
					NUMREF	WITH m.NumRI   ,;
					TIPDOC	WITH "FAC"     ,;
					FECHA	WITH m.FecRI   ,;
					CODCTA	WITH IIF(i=1,DFacAOr,HFacAOr),;
					TIPCTA	WITH IIF(i=1,"D","H"),;
					MTODEB	WITH IIF(i=1,nTot,0),;
					MTOHAB	WITH IIF(i=2,nTot,0)
			UNLOCK
			SKIP
		ENDIF
	ENDFOR
 ELSE
	FOR i = 1 TO 2
		IF f_Appd()
			REPLACE Periodo WITH m.Periodo ,;
					NUMMES	WITH m.NumMes  ,;
					NUMREF	WITH m.NumRI   ,;
					TIPDOC	WITH "FAC"     ,;
					FECHA	WITH m.FecRI   ,;
					CODCTA	WITH IIF(i=1,DFacAOr,HFacAOr),;
					TIPCTA	WITH IIF(i=1,"D","H"),;
					MTODEB	WITH IIF(i=1,nTot,0),;
					MTOHAB	WITH IIF(i=2,nTot,0)
			UNLOCK
		ENDIF
	ENDFOR
ENDIF
DEFINE WINDOW wAstOrd FROM 10,10 TO 15,70 ;
 TITLE ' ASIENTOS DE ORDEN DE FACTURA' COLOR SCHEME 02
ACTIVATE WINDOW wAstOrd
@ 00,08  SAY 'Cuentas '
@ 00,18  SAY '        Debe '
@ 00,34  SAY '        Haber '
@ 01,04  SAY DFacAOr PICTURE '!!!!!!!!!!!'
@ 01,18  SAY nTot PICTURE '99,999,999.99'
@ 02,12  SAY HFacAOr PICTURE '!!!!!!!!!!!'
@ 02,34  SAY nTot PICTURE '99,999,999.99'
WAIT " "
DEACTIVATE WINDOW wAstOrd
RELEASE WIND wAstOrd
RETURN

PROCEDURE SubOpc
*---------------
PRIVATE cAlias,cMod
cAlias = ALIAS()
SELE SubOp
cCtrlOp = ''
cMod = "02"

SEEK vUsuCla+PADL(SistCtrl,2,'0')+cMod

IF FOUND()
	SCAN WHILE vUsuCla+PADL(SistCtrl,2,'0')+cMod = ALLTRIM(SubOp.User)+SubOp.Sistema+SubOp.Modulo
		cCtrlOp = cCtrlOp + SubOp.Opcion
	ENDSCAN
ENDIF

set skip of PAD Revis of mMenu !'A' $cCtrlOp
set skip of PAD Busca of mMenu !'B' $cCtrlOp
set skip of PAD Anter of mMenu !'C' $cCtrlOp
set skip of PAD Proxi of mMenu !'D' $cCtrlOp
set skip of PAD Corri of mMenu !'E' $cCtrlOp
set skip of PAD Ingre of mMenu !'F' $cCtrlOp
set skip of PAD Anula of mMenu !'G' $cCtrlOp
set skip of PAD Lista of mMenu !'H' $cCtrlOp

SELE (cAlias)

RETURN

FUNCTION Val_TipRI
*-----------------
PARAMETERS vFil,vCol
PRIVATE mBus,mImp,cAlias
STORE .F. TO MbUS,mImp
cAlias = ALIAS()
IF EMPTY(m.TipRI)
	mBus = .T.
 ELSE
	IF SEEK('R/I'+m.TipRI,"AsiAut")
		mImp = .T.
	 ELSE
		mBus = .T.
	ENDIF
ENDIF

IF mBus
	SELE AsiAut
	SET ORDER TO AsiAutRI2
	DEFINE POPUP v__xx FROM 1,30 TO 12,79 PROMPT FIELD Descri
	ON SELECTION POPUP v__xx DEACTIVATE POPUP
	ACTIVATE POPUP v__xx
	RELEASE POPUP v__xx
	
	m.TipRI = Codigo
	
	SET ORDER TO AsiAutRi1
	mImp = .T.
ENDIF

IF mImp
	@ vFil,vCol SAY AsiAut.descri
ENDIF
SELE (cAlias)
RETURN